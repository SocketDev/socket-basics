rules:
  # === Critical Severity Rules ===

  # Code injection
  - id: php-code-injection
    message: "Code injection vulnerability detected - user input flows to code execution functions"
    severity: CRITICAL
    languages: [php]
    mode: taint
    pattern-sources:
      - pattern: $_GET
      - pattern: $_POST
      - pattern: $_REQUEST
      - pattern: $_COOKIE
      - pattern: $_SERVER['REQUEST_URI']
      - pattern: $_SERVER['QUERY_STRING']
      - pattern: file_get_contents('php://input')
    pattern-sinks:
      - pattern: eval($CODE)
      - pattern: assert($CODE)
      - pattern: assert($CODE, ...)
      - pattern: create_function($ARGS, $CODE)
    pattern-sanitizers:
      - pattern: preg_quote($STR)
      - pattern: addslashes($STR)
    metadata:
      category: security
      cwe: CWE-94
      confidence: high
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Remove eval(), assert(), and preg_replace with /e flag. Use proper parsing functions for data. Never include user-controlled file paths."

  # preg_replace with /e modifier (separate rule due to specific vulnerability)
  - id: php-preg-replace-e-modifier
    message: "Code injection vulnerability detected. User-controlled input is passed to a code evaluation function, allowing arbitrary code execution. Avoid eval/exec with user input; use safe alternatives."
    severity: CRITICAL
    languages: [php]
    pattern-either:
      - pattern: preg_replace('/.../e', $REPLACEMENT, $SUBJECT)
      - pattern: preg_replace("/.../e", $REPLACEMENT, $SUBJECT)
      - pattern: preg_replace($PATTERN, $REPLACEMENT, $SUBJECT)
    pattern-inside: |
      ...
      $PATTERN = '/.../e';
      ...
    metadata:
      category: security
      cwe: CWE-94
      confidence: high
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Remove eval(), assert(), and preg_replace with /e flag. Use proper parsing functions for data. Never include user-controlled file paths."

  # SQL injection
  - id: php-sql-injection
    message: "SQL injection vulnerability detected - user input flows to SQL query without parameterization"
    severity: CRITICAL
    languages: [php]
    mode: taint
    pattern-sources:
      - pattern: $_GET
      - pattern: $_POST
      - pattern: $_REQUEST
      - pattern: $_COOKIE
      - pattern: $_SERVER['REQUEST_URI']
      - pattern: $_SERVER['QUERY_STRING']
      - pattern: file_get_contents('php://input')
    pattern-sinks:
      - pattern: mysql_query($QUERY)
      - pattern: mysqli_query($CONN, $QUERY)
      - pattern: mysqli_query(..., $QUERY)
      - pattern: $PDO->query($QUERY)
      - pattern: $PDO->exec($QUERY)
      - pattern: $MYSQLI->query($QUERY)
      - pattern: $MYSQLI->multi_query($QUERY)
      - pattern: mysqli_multi_query($CONN, $QUERY)
      - pattern: $WPDB->query($QUERY)
      - pattern: $DB->query($QUERY)
    pattern-sanitizers:
      - pattern: $PDO->prepare($QUERY)
      - pattern: $MYSQLI->prepare($QUERY)
      - pattern: mysqli_prepare($CONN, $QUERY)
      - pattern: $WPDB->prepare($QUERY, ...)
      - pattern: mysqli_real_escape_string($CONN, $STR)
      - pattern: mysqli_real_escape_string(..., $STR)
      - pattern: mysql_real_escape_string($STR)
      - pattern: addslashes($STR)
      - pattern: intval($STR)
      - pattern: floatval($STR)
      - pattern: (int)$STR
      - pattern: (float)$STR
    metadata:
      category: security
      cwe: CWE-89
      confidence: high
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Use PDO prepared statements: $stmt = $pdo->prepare('SELECT * FROM t WHERE id = ?'); $stmt->execute([$userId]);"

  # Command injection
  - id: php-command-injection
    message: "Command injection vulnerability detected - user input flows to system command execution"
    severity: CRITICAL
    languages: [php]
    mode: taint
    pattern-sources:
      - pattern: $_GET
      - pattern: $_POST
      - pattern: $_REQUEST
      - pattern: $_COOKIE
      - pattern: $_SERVER['REQUEST_URI']
      - pattern: $_SERVER['QUERY_STRING']
      - pattern: file_get_contents('php://input')
    pattern-sinks:
      - pattern: system($CMD)
      - pattern: exec($CMD)
      - pattern: exec($CMD, ...)
      - pattern: shell_exec($CMD)
      - pattern: passthru($CMD)
      - pattern: passthru($CMD, ...)
      - pattern: popen($CMD, ...)
      - pattern: proc_open($CMD, ...)
      - pattern: '`$CMD`'
      - pattern: pcntl_exec($CMD, ...)
    pattern-sanitizers:
      - pattern: escapeshellarg($STR)
      - pattern: escapeshellcmd($STR)
    metadata:
      category: security
      cwe: CWE-78
      confidence: high
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Use escapeshellarg() for arguments and escapeshellcmd() for commands. Prefer language-level APIs over shell execution."

  # Unsafe deserialization
  - id: php-unsafe-deserialization
    message: "Unsafe deserialization detected. Deserializing untrusted data can lead to remote code execution or denial of service. Use safe serialization formats like JSON or validate data before deserializing."
    severity: CRITICAL
    languages: [php]
    patterns:
      - pattern-either:
          - pattern: unserialize($USER_INPUT)
          - pattern: serialize($USER_INPUT)
      - metavariable-pattern:
          metavariable: $USER_INPUT
          patterns:
            - pattern-either:
                - pattern: $_GET[...]
                - pattern: $_POST[...]
    metadata:
      category: security
      cwe: CWE-502
      confidence: high
      subcategory: integrity
      vulnerability_class: "Insecure Deserialization"
      owasp: "A08:2021"
      fix: "Replace unserialize() with json_decode(). If unserialize() is required, use the allowed_classes option to restrict types."

  # LDAP injection
  - id: php-ldap-injection
    message: "LDAP injection vulnerability detected. User input in LDAP queries without sanitization allows attackers to modify query logic. Escape special characters in LDAP filters."
    severity: CRITICAL
    languages: [php]
    pattern-either:
      - pattern: ldap_search($CONN, $DN, $FILTER . $USER_INPUT)
      - pattern: ldap_list($CONN, $DN, $FILTER . $USER_INPUT)
      - pattern: ldap_read($CONN, $DN, $FILTER . $USER_INPUT)
    metadata:
      category: security
      cwe: CWE-90
      confidence: medium
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Use ldap_escape() to sanitize filter values: ldap_escape($input, '', LDAP_ESCAPE_FILTER). Never concatenate user input into LDAP filters."

  # === High Severity Rules ===

  # File inclusion vulnerabilities
  - id: php-file-inclusion
    message: "Remote file inclusion vulnerability. User input controls file include paths, enabling remote code execution. Validate file paths against an allowlist."
    severity: HIGH
    languages: [php]
    pattern-either:
      - pattern: include($USER_INPUT)
      - pattern: include_once($USER_INPUT)
      - pattern: require($USER_INPUT)
      - pattern: require_once($USER_INPUT)
      - pattern: file_get_contents($USER_INPUT)
      - pattern: readfile($USER_INPUT)
      - pattern: fopen($USER_INPUT, ...)
    metadata:
      category: security
      cwe: CWE-98
      confidence: medium
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Set allow_url_include=Off in php.ini. Validate file paths against an allowlist. Use basename() to strip directory components from user input."

  # XSS vulnerabilities
  - id: php-xss
    message: "XSS vulnerability detected - user input not sanitized before output"
    severity: HIGH
    languages: [php]
    pattern-either:
      # Direct superglobal usage in output
      - pattern: echo $_GET[$KEY];
      - pattern: echo $_POST[$KEY];
      - pattern: echo $_REQUEST[$KEY];
      - pattern: echo $_COOKIE[$KEY];
      - pattern: print $_GET[$KEY];
      - pattern: print $_POST[$KEY];
      - pattern: print $_REQUEST[$KEY];
      - pattern: print $_COOKIE[$KEY];
      - pattern: printf($_GET[$KEY], $...ARGS);
      - pattern: printf($_POST[$KEY], $...ARGS);
      - pattern: printf($_REQUEST[$KEY], $...ARGS);
      # Concatenation with superglobals in output
      - pattern: echo "..." . $_GET[$KEY] . "...";
      - pattern: echo "..." . $_POST[$KEY] . "...";
      - pattern: echo "..." . $_REQUEST[$KEY] . "...";
      - pattern: echo '...' . $_GET[$KEY] . '...';
      - pattern: echo '...' . $_POST[$KEY] . '...';
      - pattern: echo '...' . $_REQUEST[$KEY] . '...';
      - pattern: print "..." . $_GET[$KEY] . "...";
      - pattern: print "..." . $_POST[$KEY] . "...";
      - pattern: print "..." . $_REQUEST[$KEY] . "...";
      - pattern: print '...' . $_GET[$KEY] . '...';
      - pattern: print '...' . $_POST[$KEY] . '...';
      - pattern: print '...' . $_REQUEST[$KEY] . '...';
      # Assignment to HTML variables (common XSS pattern)
      - pattern: $HTML .= "..." . $_GET[$KEY] . "...";
      - pattern: $HTML .= "..." . $_POST[$KEY] . "...";
      - pattern: $HTML .= "..." . $_REQUEST[$KEY] . "...";
      - pattern: $HTML .= '...' . $_GET[$KEY] . '...';
      - pattern: $HTML .= '...' . $_POST[$KEY] . '...';
      - pattern: $HTML .= '...' . $_REQUEST[$KEY] . '...';
      - pattern: $HTML = "..." . $_GET[$KEY] . "...";
      - pattern: $HTML = "..." . $_POST[$KEY] . "...";
      - pattern: $HTML = "..." . $_REQUEST[$KEY] . "...";
      - pattern: $HTML = '...' . $_GET[$KEY] . '...';
      - pattern: $HTML = '...' . $_POST[$KEY] . '...';
      - pattern: $HTML = '...' . $_REQUEST[$KEY] . '...';
      # print_r with superglobals
      - pattern: print_r($_GET)
      - pattern: print_r($_POST)
      - pattern: print_r($_REQUEST)
      - pattern: print_r($_COOKIE)
    metadata:
      category: security
      cwe: CWE-79
      confidence: high
      subcategory: xss
      vulnerability_class: "Cross-Site Scripting (XSS)"
      owasp: "A03:2021"
      fix: "Use htmlspecialchars($input, ENT_QUOTES, 'UTF-8') for output. Enable auto-escaping in Twig/Blade templates. Never echo raw user input."

  # Hardcoded secrets
  - id: php-hardcoded-secrets
    message: "Hard-coded credentials detected. Embedding secrets in source code makes them easily discoverable and impossible to rotate. Use environment variables or a secrets manager instead."
    severity: HIGH
    languages: [php]
    pattern-either:
      - pattern: $password = "...";
      - pattern: $secret = "...";
      - pattern: $api_key = "...";
      - pattern: define('PASSWORD', '...');
      - pattern: define('API_KEY', '...');
      - pattern: define('SECRET', '...');
    metadata:
      category: security
      cwe: CWE-798
      confidence: medium
      subcategory: authentication
      vulnerability_class: "Authentication Weakness"
      owasp: "A07:2021"
      fix: "Store secrets in environment variables (getenv('KEY')) or use a secrets manager. Use vlucas/phpdotenv for local development."

  # Path traversal
  - id: php-path-traversal
    message: "Path traversal vulnerability detected - user input flows to file operations without validation"
    severity: HIGH
    languages: [php]
    mode: taint
    pattern-sources:
      - pattern: $_GET
      - pattern: $_POST
      - pattern: $_REQUEST
      - pattern: $_COOKIE
      - pattern: $_SERVER['REQUEST_URI']
      - pattern: $_SERVER['QUERY_STRING']
      - pattern: file_get_contents('php://input')
    pattern-sinks:
      - pattern: file_get_contents($PATH)
      - pattern: fopen($PATH, ...)
      - pattern: include($PATH)
      - pattern: include_once($PATH)
      - pattern: require($PATH)
      - pattern: require_once($PATH)
      - pattern: readfile($PATH)
      - pattern: unlink($PATH)
      - pattern: file($PATH)
      - pattern: file_put_contents($PATH, ...)
      - pattern: copy($SRC, $DEST)
      - pattern: rename($OLD, $NEW)
      - pattern: mkdir($PATH, ...)
      - pattern: rmdir($PATH)
      - pattern: is_file($PATH)
      - pattern: is_dir($PATH)
      - pattern: scandir($PATH)
      - pattern: glob($PATH)
    pattern-sanitizers:
      - pattern: basename($PATH)
      - pattern: realpath($PATH)
    metadata:
      category: security
      cwe: CWE-22
      confidence: high
      subcategory: access-control
      vulnerability_class: "Access Control Violation"
      owasp: "A01:2021"
      fix: "Use realpath() and verify the result starts with the allowed base directory. Reject paths containing '..' sequences."

  # Open redirect
  - id: php-open-redirect
    message: "Open redirect vulnerability detected - user input flows to redirect location"
    severity: HIGH
    languages: [php]
    mode: taint
    pattern-sources:
      - pattern: $_GET
      - pattern: $_POST
      - pattern: $_REQUEST
      - pattern: $_COOKIE
      - pattern: $_SERVER['REQUEST_URI']
      - pattern: $_SERVER['QUERY_STRING']
      - pattern: $_SERVER['HTTP_REFERER']
    pattern-sinks:
      - pattern: |
          header('Location: ' . $URL)
      - pattern: |
          header("Location: $URL")
      - pattern: header($HEADER)
    pattern-sanitizers:
      - pattern: filter_var($URL, FILTER_VALIDATE_URL)
      - pattern: parse_url($URL)
    metadata:
      category: security
      cwe: CWE-601
      confidence: high
      subcategory: access-control
      vulnerability_class: "Access Control Violation"
      owasp: "A01:2021"
      fix: "Validate redirect URLs against an allowlist of trusted domains. Use relative paths for internal redirects. Parse URLs and check the host component."

  # XXE vulnerabilities
  - id: php-xxe-vulnerability
    message: "XML External Entity (XXE) vulnerability. The XML parser processes external entity references that can read local files or make network requests. Disable external entity processing in XML parsers."
    severity: HIGH
    languages: [php]
    pattern-either:
      - pattern: simplexml_load_string($XML)
      - pattern: simplexml_load_file($XML)
      - pattern: DOMDocument::loadXML($XML)
      - pattern: XMLReader::XML($XML)
    pattern-not-inside:
      pattern: |
        ...
        libxml_disable_entity_loader(true);
        ...
    metadata:
      category: security
      cwe: CWE-611
      confidence: medium
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A05:2021"
      fix: "Call libxml_disable_entity_loader(true) before parsing XML. Use LIBXML_NOENT flag carefully. Use json_decode() if possible."

  # === Medium Severity Rules ===

  # Weak cryptographic functions
  - id: php-weak-crypto
    message: "Weak cryptographic algorithm detected. Using broken or outdated algorithms may allow attackers to decrypt data or forge signatures. Use modern algorithms like AES-256, SHA-256, or Ed25519."
    severity: MEDIUM
    languages: [php]
    pattern-either:
      - pattern: md5($DATA)
      - pattern: sha1($DATA)
      - pattern: crypt($DATA, $SALT)
      - pattern: hash('md5', $DATA)
      - pattern: hash('sha1', $DATA)
      - pattern: mcrypt_encrypt(MCRYPT_DES, ...)
    metadata:
      category: security
      cwe: CWE-327
      confidence: high
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"

  # Insecure file permissions
  - id: php-insecure-file-permissions
    message: "Overly permissive file or resource permissions. Resources are accessible to unauthorized users due to incorrect permission settings. Apply the principle of least privilege."
    severity: MEDIUM
    languages: [php]
    pattern-either:
      - pattern: chmod($FILE, 0777)
      - pattern: chmod($FILE, 0666)
      - pattern: fopen($FILE, 'w+', 0777)
      - pattern: mkdir($DIR, 0777)
    metadata:
      category: security
      cwe: CWE-732
      confidence: high
      subcategory: configuration
      vulnerability_class: "Security Misconfiguration"
      owasp: "A05:2021"

  # Session security issues
  - id: php-session-security
    message: "Session fixation vulnerability. Session tokens are not regenerated after authentication, allowing session hijacking. Regenerate session IDs on login."
    severity: MEDIUM
    languages: [php]
    pattern-either:
      - pattern: session_start()
      - pattern: $_SESSION[$KEY] = $USER_INPUT
    pattern-not-inside:
      pattern: |
        ...
        session_regenerate_id(true);
        ...
    metadata:
      category: security
      cwe: CWE-384
      confidence: low
      subcategory: authentication
      vulnerability_class: "Authentication Weakness"
      owasp: "A07:2021"

  # CSRF vulnerabilities
  - id: php-csrf-vulnerability
    message: "Cross-site request forgery (CSRF) vulnerability. The application does not verify that requests originate from its own interface. Implement CSRF tokens on all state-changing operations."
    severity: MEDIUM
    languages: [php]
    pattern-either:
      - pattern: |
          if ($_POST[$PARAM]) {
            $CRITICAL_ACTION;
          }
      - pattern: |
          if ($_GET[$PARAM]) {
            $CRITICAL_ACTION;
          }
    metadata:
      category: security
      cwe: CWE-352
      confidence: low
      subcategory: access-control
      vulnerability_class: "Access Control Violation"
      owasp: "A01:2021"

  # HTTP instead of HTTPS
  - id: php-insecure-http
    message: "Sensitive data transmitted over an unencrypted channel. Using HTTP instead of HTTPS allows network attackers to intercept data in transit. Use HTTPS for all communications containing sensitive data."
    severity: MEDIUM
    languages: [php]
    pattern-either:
      - pattern: file_get_contents("http://...")
      - pattern: curl_setopt($CH, CURLOPT_URL, "http://...")
      - pattern: |
          $VAR = "http://...";
    metadata:
      category: security
      cwe: CWE-319
      confidence: low
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"

  # Insecure random number generation
  - id: php-insecure-random
    message: "Insecure random number generator used. Non-cryptographic PRNGs produce predictable values that attackers can guess. Use a cryptographically secure random generator for security-sensitive operations."
    severity: MEDIUM
    languages: [php]
    pattern-either:
      - pattern: rand()
      - pattern: mt_rand()
      - pattern: srand($SEED)
      - pattern: mt_srand($SEED)
    metadata:
      category: security
      cwe: CWE-338
      confidence: medium
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"

  # === Low Severity Rules ===

  # Debug information disclosure
  - id: php-debug-info-disclosure
    message: "Sensitive information written to log files. Passwords, tokens, or personal data in logs can be exposed to unauthorized parties. Redact sensitive values before logging."
    severity: LOW
    languages: [php]
    patterns:
      - pattern-either:
          - pattern: var_dump($USER_INPUT)
          - pattern: print_r($USER_INPUT)
          - pattern: error_reporting(E_ALL)
          - pattern: ini_set('display_errors', 1)
          - pattern: phpinfo()
      - metavariable-regex:
          metavariable: $USER_INPUT
          regex: (?i).*(password|token|secret|key|credential).*
    metadata:
      category: security
      cwe: CWE-532
      confidence: low
      subcategory: logging
      vulnerability_class: "Sensitive Data Exposure"
      owasp: "A09:2021"

  # Hardcoded IP addresses
  - id: php-hardcoded-ip
    message: "Hard-coded credentials detected. Embedding secrets in source code makes them easily discoverable and impossible to rotate. Use environment variables or a secrets manager instead."
    severity: LOW
    languages: [php]
    pattern-either:
      - pattern: $VAR = "192.168.$X.$Y";
      - pattern: $VAR = "10.$X.$Y.$Z";
      - pattern: $VAR = "127.0.0.1";
      - pattern: $VAR = "localhost";
    metadata:
      category: security
      cwe: CWE-798
      confidence: low
      subcategory: authentication
      vulnerability_class: "Authentication Weakness"
      owasp: "A07:2021"

  # Error suppression
  - id: php-error-suppression
    message: "Improper handling of exceptional conditions. The application may crash or behave unexpectedly on errors. Add proper exception handling for all expected failure modes."
    severity: LOW
    languages: [php]
    pattern-either:
      - pattern: '@$FUNCTION($...ARGS)'
      - pattern: error_reporting(0)
      - pattern: "ini_set('display_errors', 0)"
    metadata:
      category: security
      cwe: CWE-755
      confidence: low
      subcategory: error-handling
      vulnerability_class: "Improper Error Handling"

  # === Framework-specific Rules ===

  # Laravel security issues
  - id: php-laravel-security
    message: "SQL injection vulnerability detected. User-supplied input is included in a SQL query without sanitization, potentially allowing attackers to read, modify, or delete database contents. Use parameterized queries or an ORM instead of string concatenation."
    severity: HIGH
    languages: [php]
    pattern-either:
      - pattern: Route::get($PATH, $CALLBACK)->middleware('web')
      - pattern: DB::raw($QUERY . $USER_INPUT)
      - pattern: \Illuminate\Support\Facades\DB::raw($QUERY . $USER_INPUT)
      - pattern: $MODEL::whereRaw($QUERY . $USER_INPUT)
    metadata:
      category: security
      framework: laravel
      cwe: CWE-89
      confidence: medium
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      references:
        - https://laravel.com/docs/master/security
      fix: "Use PDO prepared statements: $stmt = $pdo->prepare('SELECT * FROM t WHERE id = ?'); $stmt->execute([$userId]);"

  # Symfony security issues
  - id: php-symfony-security
    message: "Missing authorization check. The application does not verify user permissions before granting access to resources. Add authorization checks to all protected endpoints."
    severity: MEDIUM
    languages: [php]
    pattern-either:
      - pattern: |
          /**
           * @Route("/admin")
           */
          public function adminAction() {
            // No security annotation
          }
      - pattern: $this->getDoctrine()->getManager()->createQuery($QUERY . $USER_INPUT)
    metadata:
      category: security
      framework: symfony
      cwe: CWE-862
      confidence: low
      subcategory: access-control
      vulnerability_class: "Access Control Violation"
      owasp: "A01:2021"
      references:
        - https://symfony.com/doc/current/security.html

  # WordPress security issues
  - id: php-wordpress-security
    message: "SQL injection vulnerability detected. User-supplied input is included in a SQL query without sanitization, potentially allowing attackers to read, modify, or delete database contents. Use parameterized queries or an ORM instead of string concatenation."
    severity: HIGH
    languages: [php]
    pattern-either:
      - pattern: $wpdb->query($QUERY . $USER_INPUT)
      - pattern: wp_remote_get($URL . $USER_INPUT)
      - pattern: file_get_contents($USER_INPUT)
      - pattern: eval($_GET[$PARAM])
    metadata:
      category: security
      framework: wordpress
      cwe: CWE-89
      confidence: medium
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      references:
        - https://developer.wordpress.org/advanced-administration/security/
      fix: "Use PDO prepared statements: $stmt = $pdo->prepare('SELECT * FROM t WHERE id = ?'); $stmt->execute([$userId]);"

  # CodeIgniter security issues
  - id: php-codeigniter-security
    message: "SQL injection vulnerability detected. User-supplied input is included in a SQL query without sanitization, potentially allowing attackers to read, modify, or delete database contents. Use parameterized queries or an ORM instead of string concatenation."
    severity: HIGH
    languages: [php]
    pattern-either:
      - pattern: $this->db->query($QUERY . $USER_INPUT)
      - pattern: $this->input->get($PARAM, true)
      - pattern: $this->load->view($VIEW, $DATA, true)
    metadata:
      category: security
      framework: codeigniter
      cwe: CWE-89
      confidence: low
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Use PDO prepared statements: $stmt = $pdo->prepare('SELECT * FROM t WHERE id = ?'); $stmt->execute([$userId]);"

  # === Additional Security Rules ===

  # File upload vulnerabilities
  - id: php-file-upload-vulnerability
    message: "Unrestricted file upload detected. Accepting uploads without validating file type and content can allow execution of malicious code. Validate file type, size, and content before storing."
    severity: HIGH
    languages: [php]
    pattern-either:
      - pattern: |
          move_uploaded_file($_FILES[$KEY]['tmp_name'], $DEST);
      - pattern: |
          copy($_FILES[$KEY]['tmp_name'], $DEST);
    pattern-not-inside:
      pattern: |
        ...
        if (in_array($_FILES[$KEY]['type'], $ALLOWED_TYPES)) {
          ...
        }
        ...
    metadata:
      category: security
      cwe: CWE-434
      confidence: low
      subcategory: upload
      vulnerability_class: "Unrestricted File Upload"
      owasp: "A04:2021"
      fix: "Validate file extension, MIME type with finfo_file(), and content. Store uploads outside the web root. Never trust $_FILES['type']."

  # Email injection
  - id: php-email-injection
    message: "Log injection risk. Unsanitized input in logs allows forged entries. Sanitize newlines and special characters before logging."
    severity: MEDIUM
    languages: [php]
    pattern-either:
      - pattern: mail($TO . $USER_INPUT, $SUBJECT, $MESSAGE)
      - pattern: mail($TO, $SUBJECT . $USER_INPUT, $MESSAGE)
      - pattern: mail($TO, $SUBJECT, $MESSAGE . $USER_INPUT)
    metadata:
      category: security
      cwe: CWE-117
      confidence: medium
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A09:2021"

  # Type juggling vulnerabilities
  - id: php-type-juggling
    message: "Incorrect comparison detected. Flawed comparison logic can bypass security checks. Use strict equality and proper type checking."
    severity: MEDIUM
    languages: [php]
    pattern-either:
      - pattern: $USER_INPUT == $HASH
      - pattern: in_array($USER_INPUT, $ARRAY)
      - pattern: array_search($USER_INPUT, $ARRAY)
    pattern-not-inside:
      pattern: |
        ...
        $USER_INPUT === $HASH
        ...
    metadata:
      category: security
      cwe: CWE-697
      confidence: low
      subcategory: design
      vulnerability_class: "Insecure Design"

  # Insecure direct object references
  - id: php-insecure-direct-object-reference
    message: "Insecure direct object reference (IDOR). User-supplied IDs access resources without authorization checks. Verify user permissions for every resource access."
    severity: HIGH
    languages: [php]
    pattern-either:
      - pattern: |
          $id = $_GET['id'];
          $query = "SELECT * FROM users WHERE id = $id";
      - pattern: |
          $file = $_GET['file'];
          include($file);
      - pattern: |
          $user_id = $_POST['user_id'];
          // Direct use without authorization check
    metadata:
      category: security
      cwe: CWE-639
      confidence: low
      subcategory: access-control
      vulnerability_class: "Access Control Violation"
      owasp: "A01:2021"
      fix: "Verify user authorization before accessing resources. Use the authenticated user's session ID, not user-supplied IDs for resource access."

  # SQL injection in prepared statements
  - id: php-prepared-statement-injection
    message: "SQL injection vulnerability detected. User-supplied input is included in a SQL query without sanitization, potentially allowing attackers to read, modify, or delete database contents. Use parameterized queries or an ORM instead of string concatenation."
    severity: CRITICAL
    languages: [php]
    pattern-either:
      - pattern: $stmt->prepare($QUERY . $USER_INPUT)
      - pattern: $pdo->prepare($QUERY . $USER_INPUT)
      - pattern: $stmt->execute(array($USER_INPUT))
    metadata:
      category: security
      cwe: CWE-89
      confidence: medium
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Use PDO prepared statements: $stmt = $pdo->prepare('SELECT * FROM t WHERE id = ?'); $stmt->execute([$userId]);"

  # Regex injection (ReDoS)
  - id: php-regex-injection
    message: "Regular expression denial of service (ReDoS) risk. A regex with catastrophic backtracking can freeze the application on crafted input. Simplify the regex or set a timeout."
    severity: MEDIUM
    languages: [php]
    pattern-either:
      - pattern: preg_match($USER_INPUT, $STRING)
      - pattern: preg_replace($USER_INPUT, $REPLACEMENT, $STRING)
      - pattern: preg_split($USER_INPUT, $STRING)
    metadata:
      category: security
      cwe: CWE-1333
      confidence: low
      subcategory: dos
      vulnerability_class: "Denial of Service"

  # Insecure cookie settings
  - id: php-insecure-cookie
    message: "Sensitive cookie missing the Secure flag. The cookie may be transmitted over unencrypted HTTP, allowing interception. Set the Secure flag on all sensitive cookies."
    severity: MEDIUM
    languages: [php]
    pattern-either:
      - pattern: setcookie($NAME, $VALUE)
      - pattern: setcookie($NAME, $VALUE, $EXPIRE, $PATH, $DOMAIN, false)
      - pattern: setcookie($NAME, $VALUE, $EXPIRE, $PATH, $DOMAIN, $SECURE, false)
    metadata:
      category: security
      cwe: CWE-614
      confidence: medium
      subcategory: configuration
      vulnerability_class: "Security Misconfiguration"
      owasp: "A05:2021"

  # Information disclosure through errors
  - id: php-information-disclosure-errors
    message: "Error messages expose sensitive information. Stack traces or internal details in error responses help attackers plan attacks. Use generic error messages in production."
    severity: LOW
    languages: [php]
    pattern-either:
      - pattern: |
          try {
            ...
          } catch (Exception $e) {
            echo $e->getMessage();
          }
      - pattern: |
          mysql_query($QUERY) or die(mysql_error());
      - pattern: |
          mysqli_query($CONN, $QUERY) or die(mysqli_error($CONN));
    metadata:
      category: security
      cwe: CWE-209
      confidence: low
      subcategory: configuration
      vulnerability_class: "Security Misconfiguration"
      owasp: "A04:2021"