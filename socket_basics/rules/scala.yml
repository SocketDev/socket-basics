rules:
  # === Critical Severity Rules ===
  
  # SQL injection
  - id: scala-sql-injection
    message: "SQL injection vulnerability detected. User-supplied input is included in a SQL query without sanitization, potentially allowing attackers to read, modify, or delete database contents. Use parameterized queries or an ORM instead of string concatenation."
    severity: CRITICAL
    languages: [scala]
    pattern-either:
      - pattern: SQL($QUERY + $USER_INPUT)
      - pattern: sql"$QUERY$USER_INPUT"
      - pattern: $STATEMENT.executeQuery($QUERY + $USER_INPUT)
      - pattern: s"$QUERY$USER_INPUT"
    metadata:
      category: security
      cwe: CWE-89
      confidence: high
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Use Slick's type-safe query DSL or JDBC PreparedStatement with parameter binding."

  # Zip Slip / Path Traversal in ZIP extraction
  - id: scala-zip-slip
    message: "Zip Slip vulnerability - ZIP extraction without path validation"
    severity: CRITICAL
    languages: [scala]
    pattern-either:
      - pattern: $ZIP.extractAll(...)
      - pattern: new ZipFile(...).extractAll(...)
      - pattern: |
          val $ZIP = new ZipFile(...)
          ...
          $ZIP.extractAll(...)
    pattern-not-inside: |
      ...
      if ($ENTRY.getName().contains("..")) {
        ...
      }
      ...
    metadata:
      category: security
      cwe: CWE-22
      confidence: high
      references:
        - https://snyk.io/research/zip-slip-vulnerability
      subcategory: access-control
      vulnerability_class: "Access Control Violation"
      owasp: "A01:2021"
      fix: "Use java.io.File.getCanonicalPath() and verify it starts with the allowed base directory. Use java.nio.file.Path.normalize()."

  # Code injection via eval or compilation
  - id: scala-code-injection
    message: "Code injection vulnerability detected. User-controlled input is passed to a code evaluation function, allowing arbitrary code execution. Avoid eval/exec with user input; use safe alternatives."
    severity: CRITICAL
    languages: [scala]
    pattern-either:
      - pattern: scala.tools.nsc.interpreter.IMain($USER_INPUT)
      - pattern: $INTERPRETER.interpret($USER_INPUT)
      - pattern: scala.reflect.runtime.universe.reify($USER_INPUT)
      - pattern: toolbox.eval($USER_INPUT)
    metadata:
      category: security
      cwe: CWE-94
      confidence: high
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Avoid scala.tools.reflect.ToolBox.eval() with user input. Use a sandboxed interpreter or safe expression parser."

  # Command injection
  - id: scala-command-injection
    message: "OS command injection vulnerability detected. User-controlled data flows into a system command without proper sanitization, allowing attackers to execute arbitrary commands. Use safe APIs with argument lists instead of shell execution."
    severity: CRITICAL
    languages: [scala]
    patterns:
      - pattern-either:
          - pattern: Runtime.getRuntime().exec($CMD + $USER_INPUT)
          - pattern: ProcessBuilder($CMD + $USER_INPUT)
          - pattern: sys.process.Process($CMD + $USER_INPUT)
          - pattern: $CMD.!
          - pattern: $CMD.!!
          - pattern: Seq($SH, "-c", $CMD).!
          - pattern: Seq($SH, "-c", $CMD).!!
      - pattern-not: '"...".!'
      - pattern-not: '"...".!!'
      - pattern-not: 'Seq($SH, "-c", "...").!'
      - pattern-not: 'Seq($SH, "-c", "...").!!'
    metadata:
      category: security
      cwe: CWE-78
      confidence: high
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Use ProcessBuilder or scala.sys.process with separate arguments. Never interpolate user input into shell command strings."

  # Deserialization vulnerabilities
  - id: scala-unsafe-deserialization
    message: "Unsafe deserialization detected. Deserializing untrusted data can lead to remote code execution or denial of service. Use safe serialization formats like JSON or validate data before deserializing."
    severity: CRITICAL
    languages: [scala]
    pattern-either:
      - pattern: ObjectInputStream.readObject()
      - pattern: $STREAM.readObject()
      - pattern: java.io.ObjectInputStream($STREAM).readObject()
    metadata:
      category: security
      cwe: CWE-502
      confidence: high
      subcategory: integrity
      vulnerability_class: "Insecure Deserialization"
      owasp: "A08:2021"
      fix: "Use circe, play-json, or upickle for JSON deserialization. Avoid Java ObjectInputStream for untrusted data."

  # === High Severity Rules ===

  # Hardcoded secrets
  - id: scala-hardcoded-secrets
    message: "Hard-coded credentials detected. Embedding secrets in source code makes them easily discoverable and impossible to rotate. Use environment variables or a secrets manager instead."
    severity: HIGH
    languages: [scala]
    patterns:
      - pattern-either:
          - pattern: |
              val $VAR = "..."
          - pattern: |
              var $VAR = "..."
          - pattern: |
              final val $VAR = "..."
          - pattern: |
              private val $VAR = "..."
      - metavariable-regex:
          metavariable: $VAR
          regex: (?i).*(password|secret|token|key|api_key|apikey|private_key|auth).*
    metadata:
      category: security
      cwe: CWE-798
      confidence: medium
      subcategory: authentication
      vulnerability_class: "Authentication Weakness"
      owasp: "A07:2021"
      fix: "Store secrets in environment variables or use a secrets manager. Use Typesafe Config with environment variable substitution."

  # Weak cryptography - MD5
  - id: scala-weak-crypto-md5
    message: "Weak cryptographic algorithm detected. Using broken or outdated algorithms may allow attackers to decrypt data or forge signatures. Use modern algorithms like AES-256, SHA-256, or Ed25519."
    severity: HIGH
    languages: [scala]
    pattern-either:
      - pattern: MessageDigest.getInstance("MD5")
      - pattern: MessageDigest.getInstance("md5")
      - pattern: java.security.MessageDigest.getInstance("MD5")
      - pattern: DigestUtils.md5($DATA)
    metadata:
      category: security
      cwe: CWE-327
      confidence: high
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"
      fix: "Use MessageDigest.getInstance('SHA-256') instead of MD5/SHA1. Use javax.crypto.Cipher with AES-GCM for encryption."

  # Weak cryptography - SHA1
  - id: scala-weak-crypto-sha1
    message: "Weak cryptographic algorithm detected. Using broken or outdated algorithms may allow attackers to decrypt data or forge signatures. Use modern algorithms like AES-256, SHA-256, or Ed25519."
    severity: HIGH
    languages: [scala]
    pattern-either:
      - pattern: MessageDigest.getInstance("SHA1")
      - pattern: MessageDigest.getInstance("SHA-1")
      - pattern: MessageDigest.getInstance("sha1")
      - pattern: DigestUtils.sha1($DATA)
    metadata:
      category: security
      cwe: CWE-327
      confidence: high
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"
      fix: "Use MessageDigest.getInstance('SHA-256') instead of MD5/SHA1. Use javax.crypto.Cipher with AES-GCM for encryption."

  # SSL/TLS bypass
  - id: scala-ssl-bypass
    message: "TLS/SSL certificate validation is disabled or bypassed. This allows man-in-the-middle attacks where attackers can intercept encrypted communications. Always validate certificates in production."
    severity: HIGH
    languages: [scala]
    pattern-either:
      - pattern: HttpsURLConnection.setDefaultHostnameVerifier(($HOSTNAME, $SESSION) => true)
      - pattern: SSLContext.getInstance("SSL")
      - pattern: TrustManager.checkServerTrusted(...)
    metadata:
      category: security
      cwe: CWE-295
      confidence: medium
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A07:2021"
      fix: "Never override TrustManager to accept all certificates. Use the default SSLContext or configure trusted CA certificates."

  # Path traversal
  - id: scala-path-traversal
    message: "Path traversal vulnerability detected. User input is used in file paths without validation, allowing attackers to access files outside the intended directory. Validate and canonicalize paths before use."
    severity: HIGH
    languages: [scala]
    pattern-either:
      - pattern: new File($PATH + $USER_INPUT)
      - pattern: Files.readAllLines(Paths.get($PATH + $USER_INPUT))
      - pattern: Source.fromFile($PATH + $USER_INPUT)
      - pattern: scala.io.Source.fromFile($PATH + $USER_INPUT)
    metadata:
      category: security
      cwe: CWE-22
      confidence: medium
      subcategory: access-control
      vulnerability_class: "Access Control Violation"
      owasp: "A01:2021"
      fix: "Use java.io.File.getCanonicalPath() and verify it starts with the allowed base directory. Use java.nio.file.Path.normalize()."

  # XSS in templates
  - id: scala-xss-template
    message: "Cross-site scripting (XSS) vulnerability detected. User input is rendered in HTML output without proper escaping, allowing attackers to inject malicious scripts. Sanitize or escape all user input before rendering."
    severity: HIGH
    languages: [scala]
    pattern-either:
      - pattern: Html($USER_INPUT)
      - pattern: views.html.$TEMPLATE($USER_INPUT)
      - pattern: play.twirl.api.Html($USER_INPUT)
    metadata:
      category: security
      framework: play
      cwe: CWE-79
      confidence: medium
      subcategory: xss
      vulnerability_class: "Cross-Site Scripting (XSS)"
      owasp: "A03:2021"
      references:
        - https://www.playframework.com/documentation/latest/SecurityHeaders
      fix: "Use Play framework's Twirl templates (auto-escaped by default). Use Html() only for trusted content. Sanitize user input before rendering."

  # === Medium Severity Rules ===

  # Insecure random
  - id: scala-insecure-random
    message: "Insecure random number generator used. Non-cryptographic PRNGs produce predictable values that attackers can guess. Use a cryptographically secure random generator for security-sensitive operations."
    severity: MEDIUM
    languages: [scala]
    pattern-either:
      - pattern: new Random()
      - pattern: scala.util.Random
      - pattern: Math.random()
      - pattern: Random.nextInt()
    metadata:
      category: security
      cwe: CWE-338
      confidence: medium
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"

  # HTTP instead of HTTPS
  - id: scala-insecure-http
    message: "Sensitive data transmitted over an unencrypted channel. Using HTTP instead of HTTPS allows network attackers to intercept data in transit. Use HTTPS for all communications containing sensitive data."
    severity: MEDIUM
    languages: [scala]
    pattern-either:
      - pattern: "http://..."
      - pattern: new URL("http://...")
      - pattern: Http().singleRequest(HttpRequest(uri = "http://..."))
    metadata:
      category: security
      cwe: CWE-319
      confidence: low
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"

  # Open redirect
  - id: scala-open-redirect
    message: "Open redirect vulnerability detected. The application redirects to a user-controlled URL without validation, enabling phishing attacks. Validate redirect targets against an allowlist."
    severity: MEDIUM
    languages: [scala]
    pattern-either:
      - pattern: Redirect($USER_INPUT)
      - pattern: Found($USER_INPUT)
      - pattern: SeeOther($USER_INPUT)
    metadata:
      category: security
      framework: play
      cwe: CWE-601
      confidence: low
      subcategory: access-control
      vulnerability_class: "Access Control Violation"
      owasp: "A01:2021"
      references:
        - https://www.playframework.com/documentation/latest/SecurityHeaders

  # Weak cipher algorithms
  - id: scala-weak-cipher
    message: "Weak cryptographic algorithm detected. Using broken or outdated algorithms may allow attackers to decrypt data or forge signatures. Use modern algorithms like AES-256, SHA-256, or Ed25519."
    severity: MEDIUM
    languages: [scala]
    pattern-either:
      - pattern: Cipher.getInstance("DES")
      - pattern: Cipher.getInstance("RC4")
      - pattern: Cipher.getInstance("RC2")
      - pattern: Cipher.getInstance("3DES")
    metadata:
      category: security
      cwe: CWE-327
      confidence: high
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"

  # === Low Severity Rules ===

  # Debug information disclosure
  - id: scala-debug-info-disclosure
    message: "Sensitive information written to log files. Passwords, tokens, or personal data in logs can be exposed to unauthorized parties. Redact sensitive values before logging."
    severity: LOW
    languages: [scala]
    patterns:
      - pattern-either:
          - pattern: println($USER_INPUT)
          - pattern: print($USER_INPUT)
          - pattern: Console.println($USER_INPUT)
          - pattern: System.out.println($USER_INPUT)
      - metavariable-regex:
          metavariable: $USER_INPUT
          regex: (?i).*(password|token|secret|key|credential).*
    metadata:
      category: security
      cwe: CWE-532
      confidence: low
      subcategory: logging
      vulnerability_class: "Sensitive Data Exposure"
      owasp: "A09:2021"

  # Hardcoded IP addresses
  - id: scala-hardcoded-ip
    message: "Hard-coded credentials detected. Embedding secrets in source code makes them easily discoverable and impossible to rotate. Use environment variables or a secrets manager instead."
    severity: LOW
    languages: [scala]
    pattern-either:
      - pattern: "192.168.$X.$Y"
      - pattern: "10.$X.$Y.$Z"
      - pattern: "172.16.$X.$Y"
      - pattern: '"127.0.0.1"'
      - pattern: 'localhost'
    metadata:
      category: security
      cwe: CWE-798
      confidence: low
      subcategory: authentication
      vulnerability_class: "Authentication Weakness"
      owasp: "A07:2021"

  # === Framework-specific Rules ===

  # Play Framework CSRF bypass
  - id: scala-play-csrf-bypass
    message: "Cross-site request forgery (CSRF) vulnerability. The application does not verify that requests originate from its own interface. Implement CSRF tokens on all state-changing operations."
    severity: MEDIUM
    languages: [scala]
    pattern-either:
      - pattern: NoCSRFCheck
      - pattern: csrf.check = false
      - pattern: play.filters.csrf.CSRFFilter.Disabled
    metadata:
      category: security
      framework: play
      cwe: CWE-352
      confidence: medium
      subcategory: access-control
      vulnerability_class: "Access Control Violation"
      owasp: "A01:2021"
      references:
        - https://www.playframework.com/documentation/latest/SecurityHeaders

  # Akka HTTP security issues
  - id: scala-akka-http-security
    message: "Uncontrolled resource consumption detected. The application does not limit resource usage, making it vulnerable to denial-of-service attacks. Implement rate limiting and resource caps."
    severity: MEDIUM
    languages: [scala]
    pattern-either:
      - pattern: akka.http.server.parsing.max-content-length = infinite
      - pattern: Http().bindAndHandle(..., interface = "0.0.0.0")
      - pattern: ServerSettings().withVerboseErrorMessages(true)
    metadata:
      category: security
      framework: akka
      cwe: CWE-400
      confidence: low
      subcategory: dos
      vulnerability_class: "Denial of Service"

  # Slick SQL injection
  - id: scala-slick-sql-injection
    message: "SQL injection vulnerability detected. User-supplied input is included in a SQL query without sanitization, potentially allowing attackers to read, modify, or delete database contents. Use parameterized queries or an ORM instead of string concatenation."
    severity: CRITICAL
    languages: [scala]
    pattern-either:
      - pattern: $TABLE.filter($CONDITION + $USER_INPUT)
      - pattern: $DB.withConnection($QUERY + $USER_INPUT)
      - pattern: $TABLE.filter(_.column === $USER_INPUT)
    metadata:
      category: security
      framework: slick
      cwe: CWE-89
      confidence: medium
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Use Slick's type-safe query DSL or JDBC PreparedStatement with parameter binding."

  # JSON injection
  - id: scala-json-injection
    message: "Code injection vulnerability detected. User-controlled input is passed to a code evaluation function, allowing arbitrary code execution. Avoid eval/exec with user input; use safe alternatives."
    severity: HIGH
    languages: [scala]
    pattern-either:
      - pattern: Json.parse($USER_INPUT)
      - pattern: play.api.libs.json.Json.parse($USER_INPUT)
      - pattern: $JSON_STRING + $USER_INPUT + $JSON_STRING
    metadata:
      category: security
      cwe: CWE-94
      confidence: low
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Avoid scala.tools.reflect.ToolBox.eval() with user input. Use a sandboxed interpreter or safe expression parser."

  # File upload without validation
  - id: scala-file-upload-no-validation
    message: "Unrestricted file upload detected. Accepting uploads without validating file type and content can allow execution of malicious code. Validate file type, size, and content before storing."
    severity: HIGH
    languages: [scala]
    pattern-either:
      - pattern: |
          def upload = Action(parse.multipartFormData) { request =>
            val file = request.body.file("picture").get
            file.ref.moveTo(...)
          }
    pattern-not-inside:
      pattern: |
        ...
        if (file.contentType.contains("image")) {
          ...
        }
        ...
    metadata:
      category: security
      framework: play
      cwe: CWE-434
      confidence: low
      subcategory: upload
      vulnerability_class: "Unrestricted File Upload"
      owasp: "A04:2021"
      references:
        - https://www.playframework.com/documentation/latest/SecurityHeaders
      fix: "Validate file extension, MIME type, and content. Store uploads outside the web root with randomized names."