rules:
  # === Critical Severity Rules ===

  # Code injection via reflection
  - id: java-reflection-injection
    message: "Code injection vulnerability detected. User-controlled input is passed to a code evaluation function, allowing arbitrary code execution. Avoid eval/exec with user input; use safe alternatives."
    severity: CRITICAL
    languages: [java]
    pattern-either:
      - pattern: Class.forName($USER_INPUT)
      - pattern: $CLASS.newInstance()
      - pattern: $METHOD.invoke($OBJ, $USER_INPUT)
      - pattern: Runtime.getRuntime().exec($USER_INPUT)
    metadata:
      category: security
      cwe: CWE-94
      confidence: medium
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Avoid ScriptEngine.eval() with user input. Use a sandboxed interpreter or template engine. Restrict class loading with a SecurityManager."

  # SQL injection - using taint mode for accurate detection
  - id: java-sql-injection
    message: "SQL injection vulnerability detected. User-controlled data flows into SQL execution without proper sanitization. Use PreparedStatement with parameter binding to prevent SQL injection."
    severity: CRITICAL
    languages: [java]
    mode: taint
    pattern-sources:
      # Servlet request sources
      - pattern: $REQ.getParameter(...)
      - pattern: $REQ.getParameterValues(...)
      - pattern: $REQ.getHeader(...)
      - pattern: $REQ.getQueryString()
      - pattern: $REQ.getRequestURI()
      - pattern: $REQ.getCookies()
      - pattern: $REQ.getInputStream()
      - pattern: $REQ.getReader()
      # User object getters that typically return user input
      - pattern: $OBJ.getUsername()
      - pattern: $OBJ.getName()
      - pattern: $OBJ.getEmail()
      - pattern: $OBJ.getPassword()
      - pattern: $OBJ.getValue()
      - pattern: $OBJ.getData()
      - pattern: $OBJ.getInput()
      - pattern: $OBJ.getContent()
      - pattern: $OBJ.getText()
    pattern-propagators:
      # StringBuilder/StringBuffer propagation
      - pattern: $B.append(...)
        from: $B
        to: $B
      - pattern: $B.append($X)
        from: $X
        to: $B
      - pattern: (StringBuilder $B).toString()
        from: $B
        to: (StringBuilder $B).toString()
      - pattern: (StringBuffer $B).toString()
        from: $B
        to: (StringBuffer $B).toString()
      # String.format propagation
      - pattern: String.format($FMT, ..., $X, ...)
        from: $X
        to: String.format
      # String concatenation
      - pattern: (String $A) + (String $B)
        from: $B
        to: $A
      - pattern: (String $A).concat($B)
        from: $B
        to: $A
    pattern-sinks:
      # JDBC statement execution
      - pattern: $STMT.executeQuery(...)
      - pattern: $STMT.execute(...)
      - pattern: $STMT.executeUpdate(...)
      - pattern: $STMT.executeLargeUpdate(...)
      # JPA/Hibernate query creation
      - pattern: $EM.createQuery(...)
      - pattern: $EM.createNativeQuery(...)
      - pattern: $SESSION.createQuery(...)
      - pattern: $SESSION.createSQLQuery(...)
      # JDBC template methods
      - pattern: $TEMPLATE.query(...)
      - pattern: $TEMPLATE.queryForObject(...)
      - pattern: $TEMPLATE.queryForList(...)
      - pattern: $TEMPLATE.execute(...)
      - pattern: $TEMPLATE.update(...)
    pattern-sanitizers:
      # PreparedStatement parameter binding
      - pattern: $STMT.setString(...)
        by-side-effect: true
      - pattern: $STMT.setInt(...)
        by-side-effect: true
      - pattern: $STMT.setObject(...)
        by-side-effect: true
      # JPA parameter binding
      - pattern: $QUERY.setParameter(...)
        by-side-effect: true
      # Spring named parameter binding
      - pattern: $SOURCE.addValue(...)
        by-side-effect: true
    metadata:
      category: security
      cwe: CWE-89
      owasp:
        - A03:2021 - Injection
      confidence: high
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      fix: "Use PreparedStatement with parameter binding: ps = conn.prepareStatement('SELECT * FROM t WHERE id = ?'); ps.setString(1, userId);"

  # Deserialization vulnerabilities
  - id: java-unsafe-deserialization
    message: "Unsafe deserialization detected. Deserializing untrusted data can lead to remote code execution or denial of service. Use safe serialization formats like JSON or validate data before deserializing."
    severity: CRITICAL
    languages: [java]
    pattern-either:
      - pattern: new ObjectInputStream($STREAM).readObject()
      - pattern: $OIS.readObject()
      - pattern: XMLDecoder.readObject()
      - pattern: Yaml.load($INPUT)
    metadata:
      category: security
      cwe: CWE-502
      confidence: high
      subcategory: integrity
      vulnerability_class: "Insecure Deserialization"
      owasp: "A08:2021"
      fix: "Use ObjectInputFilter (JEP 290) to restrict deserializable classes. Prefer JSON (Jackson/Gson) or Protocol Buffers for data interchange."

  # Command injection - using taint mode for accurate detection
  - id: java-command-injection
    message: "Command injection vulnerability detected. User-controlled data flows into system command execution without proper validation. Avoid command execution with user input; if necessary, use strict allowlisting."
    severity: CRITICAL
    languages: [java]
    mode: taint
    pattern-sources:
      # Servlet request sources
      - pattern: $REQ.getParameter(...)
      - pattern: $REQ.getParameterValues(...)
      - pattern: $REQ.getHeader(...)
      - pattern: $REQ.getQueryString()
      - pattern: $REQ.getRequestURI()
      # User object getters
      - pattern: $OBJ.getCommand()
      - pattern: $OBJ.getFilename()
      - pattern: $OBJ.getName()
      - pattern: $OBJ.getValue()
      - pattern: $OBJ.getData()
      - pattern: $OBJ.getInput()
    pattern-propagators:
      # String concatenation
      - pattern: (String $A) + (String $B)
        from: $B
        to: $A
      - pattern: (String $A).concat($B)
        from: $B
        to: $A
      # StringBuilder/StringBuffer
      - pattern: $B.append($X)
        from: $X
        to: $B
      # String.format
      - pattern: String.format($FMT, ..., $X, ...)
        from: $X
        to: String.format
      # Array creation with tainted elements
      - pattern: new String[] {..., $X, ...}
        from: $X
        to: new String[]
    pattern-sinks:
      # Runtime exec
      - pattern: Runtime.getRuntime().exec(...)
      - pattern: $RUNTIME.exec(...)
      # ProcessBuilder
      - pattern: new ProcessBuilder(...)
      - pattern: $BUILDER.command(...)
      - pattern: ProcessBuilder.start()
      # Legacy Process API
      - pattern: Process.start(...)
    metadata:
      category: security
      cwe: CWE-78
      confidence: high
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Use ProcessBuilder with separate arguments: new ProcessBuilder('cmd', arg1, arg2). Never concatenate user input into Runtime.exec() strings."

  # LDAP injection
  - id: java-ldap-injection
    message: "LDAP injection vulnerability detected. User input in LDAP queries without sanitization allows attackers to modify query logic. Escape special characters in LDAP filters."
    severity: CRITICAL
    languages: [java]
    pattern-either:
      - pattern: $CTX.search($FILTER + $USER_INPUT, ...)
      - pattern: new SearchFilter($FILTER + $USER_INPUT)
      - pattern: LdapName($DN + $USER_INPUT)
    metadata:
      category: security
      cwe: CWE-90
      confidence: medium
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Use javax.naming.ldap with properly escaped filter values. Use LdapEncoder.filterEncode() from Spring LDAP for escaping."

  # === High Severity Rules ===

  # Hardcoded credentials
  - id: java-hardcoded-credentials
    message: "Hard-coded credentials detected. Embedding secrets in source code makes them easily discoverable and impossible to rotate. Use environment variables or a secrets manager instead."
    severity: HIGH
    languages: [java]
    patterns:
      - pattern-either:
          - pattern: |
              private static final String $VAR = "...";
          - pattern: |
              public static final String $VAR = "...";
          - pattern: |
              String $VAR = "...";
      - metavariable-regex:
          metavariable: $VAR
          regex: (?i).*(password|passwd|pwd|secret|token|key|api_key).*
    metadata:
      category: security
      cwe: CWE-798
      confidence: medium
      subcategory: authentication
      vulnerability_class: "Authentication Weakness"
      owasp: "A07:2021"
      fix: "Store secrets in environment variables (System.getenv('KEY')), a secrets manager, or externalized configuration (Spring Vault, AWS Secrets Manager)."

  # Weak cryptography
  - id: java-weak-crypto-md5
    message: "Weak cryptographic algorithm detected. Using broken or outdated algorithms may allow attackers to decrypt data or forge signatures. Use modern algorithms like AES-256, SHA-256, or Ed25519."
    severity: HIGH
    languages: [java]
    pattern-either:
      - pattern: MessageDigest.getInstance("MD5")
      - pattern: MessageDigest.getInstance("md5")
      - pattern: DigestUtils.md5($DATA)
    metadata:
      category: security
      cwe: CWE-327
      confidence: high
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"
      fix: "Use MessageDigest.getInstance('SHA-256') instead of MD5/SHA1. Use AES/GCM/NoPadding for encryption. Use Cipher from javax.crypto with strong algorithms."

  - id: java-weak-crypto-sha1
    message: "Weak cryptographic algorithm detected. Using broken or outdated algorithms may allow attackers to decrypt data or forge signatures. Use modern algorithms like AES-256, SHA-256, or Ed25519."
    severity: HIGH
    languages: [java]
    pattern-either:
      - pattern: MessageDigest.getInstance("SHA-1")
      - pattern: MessageDigest.getInstance("SHA1")
      - pattern: MessageDigest.getInstance("sha1")
      - pattern: DigestUtils.sha1($DATA)
    metadata:
      category: security
      cwe: CWE-327
      confidence: high
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"
      fix: "Use MessageDigest.getInstance('SHA-256') instead of MD5/SHA1. Use AES/GCM/NoPadding for encryption. Use Cipher from javax.crypto with strong algorithms."

  # Insecure random
  - id: java-insecure-random
    message: "Insecure random number generator used. Non-cryptographic PRNGs produce predictable values that attackers can guess. Use a cryptographically secure random generator for security-sensitive operations."
    severity: HIGH
    languages: [java]
    pattern-either:
      - pattern: new Random()
      - pattern: new Random($SEED)
      - pattern: Math.random()
    pattern-not-inside:
      pattern: |
        // This is not for cryptographic use
        ...
    metadata:
      category: security
      cwe: CWE-338
      confidence: medium
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"
      fix: "Use java.security.SecureRandom instead of java.util.Random for security-sensitive operations."

  # XXE vulnerabilities
  - id: java-xxe-vulnerability
    message: "XML External Entity (XXE) vulnerability. The XML parser processes external entity references that can read local files or make network requests. Disable external entity processing in XML parsers."
    severity: HIGH
    languages: [java]
    pattern-either:
      - pattern: DocumentBuilderFactory.newInstance()
      - pattern: SAXParserFactory.newInstance()
      - pattern: XMLInputFactory.newInstance()
      - pattern: SchemaFactory.newInstance(...)
      - pattern: TransformerFactory.newInstance()
    pattern-not-inside:
      pattern: |
        ...
        $FACTORY.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true);
        ...
    metadata:
      category: security
      cwe: CWE-611
      confidence: medium
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A05:2021"
      fix: "Set XMLConstants.FEATURE_SECURE_PROCESSING and disable DOCTYPE declarations: factory.setFeature('http://apache.org/xml/features/disallow-doctype-decl', true)."

  # Path traversal - using taint mode for accurate detection
  - id: java-path-traversal
    message: "Path traversal vulnerability detected. User-controlled data flows into file operations without proper validation. Use Path.normalize() and validate the result is within allowed directory."
    severity: HIGH
    languages: [java]
    mode: taint
    pattern-sources:
      # Servlet request sources
      - pattern: $REQ.getParameter(...)
      - pattern: $REQ.getParameterValues(...)
      - pattern: $REQ.getHeader(...)
      - pattern: $REQ.getQueryString()
      - pattern: $REQ.getRequestURI()
      - pattern: $REQ.getPathInfo()
      # User object getters that typically return user input
      - pattern: $OBJ.getFilename()
      - pattern: $OBJ.getName()
      - pattern: $OBJ.getPath()
      - pattern: $OBJ.getValue()
      - pattern: $OBJ.getData()
    pattern-propagators:
      # String concatenation
      - pattern: (String $A) + (String $B)
        from: $B
        to: $A
      - pattern: (String $A).concat($B)
        from: $B
        to: $A
      # Path operations that propagate taint
      - pattern: Paths.get(..., $X, ...)
        from: $X
        to: Paths.get
      - pattern: Path.resolve($X)
        from: $X
        to: Path.resolve
      # File path operations
      - pattern: new File($X)
        from: $X
        to: new File
      - pattern: new File($DIR, $X)
        from: $X
        to: new File
    pattern-sinks:
      # File operations
      - pattern: new File(...)
      - pattern: new FileInputStream(...)
      - pattern: new FileOutputStream(...)
      - pattern: new FileReader(...)
      - pattern: new FileWriter(...)
      - pattern: new RandomAccessFile(...)
      - pattern: Files.readAllBytes(...)
      - pattern: Files.readAllLines(...)
      - pattern: Files.write(...)
      - pattern: Files.copy(...)
      - pattern: Files.move(...)
      - pattern: Files.delete(...)
      - pattern: Files.deleteIfExists(...)
      - pattern: Paths.get(...)
      # Legacy IO operations
      - pattern: $FILE.createNewFile(...)
      - pattern: $FILE.delete()
      - pattern: $FILE.renameTo(...)
    pattern-sanitizers:
      # Path validation
      - pattern: $PATH.normalize()
      - pattern: $PATH.toRealPath(...)
      - pattern: FilenameUtils.normalize(...)
    metadata:
      category: security
      cwe: CWE-22
      confidence: high
      subcategory: access-control
      vulnerability_class: "Access Control Violation"
      owasp: "A01:2021"
      fix: "Use File.getCanonicalPath() and verify the result starts with the allowed base directory. Use java.nio.file.Path.normalize() and resolve()."

  # SSL/TLS bypass
  - id: java-ssl-bypass
    message: "TLS/SSL certificate validation is disabled or bypassed. This allows man-in-the-middle attacks where attackers can intercept encrypted communications. Always validate certificates in production."
    severity: HIGH
    languages: [java]
    pattern-either:
      - pattern: |
          HttpsURLConnection.setDefaultHostnameVerifier(new HostnameVerifier() {
            public boolean verify(String hostname, SSLSession session) {
              return true;
            }
          });
      - pattern: |
          TrustManager[] trustAllCerts = new TrustManager[] {
            new X509TrustManager() {
              public void checkClientTrusted(...) {}
              public void checkServerTrusted(...) {}
              public X509Certificate[] getAcceptedIssuers() { return null; }
            }
          };
    metadata:
      category: security
      cwe: CWE-295
      confidence: high
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A07:2021"
      fix: "Never override TrustManager to accept all certificates. Use the default SSLContext or configure with trusted CA certificates only."

  # === Medium Severity Rules ===

  # Weak cipher algorithms
  - id: java-weak-cipher
    message: "Weak cryptographic algorithm detected. Using broken or outdated algorithms may allow attackers to decrypt data or forge signatures. Use modern algorithms like AES-256, SHA-256, or Ed25519."
    severity: MEDIUM
    languages: [java]
    pattern-either:
      - pattern: Cipher.getInstance("DES")
      - pattern: Cipher.getInstance("RC4")
      - pattern: Cipher.getInstance("RC2")
      - pattern: Cipher.getInstance("DESede")
      - pattern: Cipher.getInstance("Blowfish")
    metadata:
      category: security
      cwe: CWE-327
      confidence: high
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"

  # Weak SSL/TLS versions
  - id: java-weak-ssl-version
    message: "Weak cryptographic algorithm detected. Using broken or outdated algorithms may allow attackers to decrypt data or forge signatures. Use modern algorithms like AES-256, SHA-256, or Ed25519."
    severity: MEDIUM
    languages: [java]
    pattern-either:
      - pattern: SSLContext.getInstance("SSL")
      - pattern: SSLContext.getInstance("SSLv2")
      - pattern: SSLContext.getInstance("SSLv3")
      - pattern: SSLContext.getInstance("TLS")
      - pattern: SSLContext.getInstance("TLSv1")
      - pattern: SSLContext.getInstance("TLSv1.1")
    metadata:
      category: security
      cwe: CWE-327
      confidence: high
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"

  # HTTP usage instead of HTTPS
  - id: java-insecure-http
    message: "Sensitive data transmitted over an unencrypted channel. Using HTTP instead of HTTPS allows network attackers to intercept data in transit. Use HTTPS for all communications containing sensitive data."
    severity: MEDIUM
    languages: [java]
    pattern-either:
      - pattern: new URL("http://$URL")
      - pattern: '"http://$URL"'
      - pattern: HttpURLConnection.setRequestMethod("GET")
    metadata:
      category: security
      cwe: CWE-319
      confidence: low
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"

  # Weak key generation
  - id: java-weak-key-generation
    message: "Cryptographic weakness detected. Misuse of cryptographic primitives undermines data protection. Use well-tested crypto libraries with recommended configurations."
    severity: MEDIUM
    languages: [java]
    patterns:
      - pattern-either:
          - pattern: KeyPairGenerator.getInstance("RSA").initialize(512)
          - pattern: KeyPairGenerator.getInstance("RSA").initialize(1024)
          - pattern: KeyGenerator.getInstance(...).init(512)
          - pattern: KeyGenerator.getInstance(...).init(1024)
    metadata:
      category: security
      cwe: CWE-310
      confidence: medium
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"

  # Unvalidated redirects
  - id: java-unvalidated-redirect
    message: "Open redirect vulnerability detected. The application redirects to a user-controlled URL without validation, enabling phishing attacks. Validate redirect targets against an allowlist."
    severity: MEDIUM
    languages: [java]
    pattern-either:
      - pattern: response.sendRedirect($USER_INPUT)
      - pattern: $RESPONSE.setHeader("Location", $USER_INPUT)
    metadata:
      category: security
      cwe: CWE-601
      confidence: low
      subcategory: access-control
      vulnerability_class: "Access Control Violation"
      owasp: "A01:2021"

  # Cookie security issues
  - id: java-insecure-cookie
    message: "Sensitive cookie missing the Secure flag. The cookie may be transmitted over unencrypted HTTP, allowing interception. Set the Secure flag on all sensitive cookies."
    severity: MEDIUM
    languages: [java]
    pattern-either:
      - pattern: |
          Cookie $COOKIE = new Cookie($NAME, $VALUE);
      - pattern: |
          new Cookie($NAME, $VALUE);
    pattern-not-inside:
      pattern: |
        ...
        $COOKIE.setSecure(true);
        ...
    metadata:
      category: security
      cwe: CWE-614
      confidence: low
      subcategory: configuration
      vulnerability_class: "Security Misconfiguration"
      owasp: "A05:2021"

  # === Low Severity Rules ===

  # System.out usage in production
  - id: java-system-out-usage
    message: "Sensitive information written to log files. Passwords, tokens, or personal data in logs can be exposed to unauthorized parties. Redact sensitive values before logging."
    severity: LOW
    languages: [java]
    pattern-either:
      - pattern: System.out.println($MSG)
      - pattern: System.out.print($MSG)
      - pattern: System.err.println($MSG)
      - pattern: $THROWABLE.printStackTrace()
    metadata:
      category: security
      cwe: CWE-532
      confidence: low
      subcategory: logging
      vulnerability_class: "Sensitive Data Exposure"
      owasp: "A09:2021"

  # Empty catch blocks
  - id: java-empty-catch-block
    message: "Improper error handling detected. The application does not properly handle exceptions, which may cause crashes or information leaks. Catch specific exceptions and handle them gracefully."
    severity: LOW
    languages: [java]
    pattern: |
      try {
        ...
      } catch ($EXCEPTION $VAR) {
      }
    metadata:
      category: security
      cwe: CWE-703
      confidence: high
      subcategory: error-handling
      vulnerability_class: "Improper Error Handling"

  # Hardcoded IP addresses
  - id: java-hardcoded-ip
    message: "Hard-coded credentials detected. Embedding secrets in source code makes them easily discoverable and impossible to rotate. Use environment variables or a secrets manager instead."
    severity: LOW
    languages: [java]
    pattern-either:
      - pattern: '"192.168.$IP"'
      - pattern: '"10.$IP"'
      - pattern: '"172.16.$IP"'
      - pattern: '"127.0.0.1"'
    metadata:
      category: security
      cwe: CWE-798
      confidence: low
      subcategory: authentication
      vulnerability_class: "Authentication Weakness"
      owasp: "A07:2021"

  # === Framework-specific Rules ===

  # Spring Security bypass
  - id: java-spring-security-bypass
    message: "Cross-site request forgery (CSRF) vulnerability. The application does not verify that requests originate from its own interface. Implement CSRF tokens on all state-changing operations."
    severity: HIGH
    languages: [java]
    pattern-either:
      - pattern: |
          @Override
          protected void configure(HttpSecurity http) throws Exception {
            http.csrf().disable();
          }
      - pattern: |
          http.authorizeRequests().anyRequest().permitAll()
    metadata:
      category: security
      framework: spring
      cwe: CWE-352
      subcategory: access-control
      vulnerability_class: "Access Control Violation"
      owasp: "A01:2021"
      references:
        - https://docs.spring.io/spring-security/reference/
      fix: "Enable Spring Security CSRF protection or use a custom CSRF token filter. Include CSRF tokens in all HTML forms and AJAX requests."

  # JPA/Hibernate SQL injection
  - id: java-jpa-sql-injection
    message: "SQL injection vulnerability detected. User-supplied input is included in a SQL query without sanitization, potentially allowing attackers to read, modify, or delete database contents. Use parameterized queries or an ORM instead of string concatenation."
    severity: HIGH
    languages: [java]
    pattern-either:
      - pattern: entityManager.createQuery($QUERY + $USER_INPUT)
      - pattern: session.createQuery($QUERY + $USER_INPUT)
      - pattern: entityManager.createNativeQuery($QUERY + $USER_INPUT)
    metadata:
      category: security
      framework: jpa
      cwe: CWE-89
      confidence: high
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Use PreparedStatement with parameter binding: ps = conn.prepareStatement('SELECT * FROM t WHERE id = ?'); ps.setString(1, userId);"

  # Struts2 OGNL injection
  - id: java-struts-ognl-injection
    message: "Code injection vulnerability detected. User-controlled input is passed to a code evaluation function, allowing arbitrary code execution. Avoid eval/exec with user input; use safe alternatives."
    severity: CRITICAL
    languages: [java]
    pattern-either:
      - pattern: Ognl.parseExpression($USER_INPUT)
      - pattern: OgnlContext.setRoot($USER_INPUT)
    metadata:
      category: security
      framework: struts
      cwe: CWE-94
      confidence: medium
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Avoid ScriptEngine.eval() with user input. Use a sandboxed interpreter or template engine. Restrict class loading with a SecurityManager."

  # Android specific vulnerabilities
  - id: java-android-webview-js-enabled
    message: "Cross-site scripting (XSS) vulnerability detected. User input is rendered in HTML output without proper escaping, allowing attackers to inject malicious scripts. Sanitize or escape all user input before rendering."
    severity: MEDIUM
    languages: [java]
    pattern: |
      $WEBVIEW.getSettings().setJavaScriptEnabled(true);
    metadata:
      category: security
      platform: android
      cwe: CWE-79
      confidence: medium
      subcategory: xss
      vulnerability_class: "Cross-Site Scripting (XSS)"
      owasp: "A03:2021"

  - id: java-android-external-storage
    message: "Use of external storage - data may be readable by other apps"
    severity: LOW
    languages: [java]
    pattern-either:
      - pattern: Environment.getExternalStorageDirectory()
      - pattern: getExternalFilesDir(...)
      - pattern: openFileOutput($NAME, MODE_WORLD_READABLE)
    metadata:
      category: security
      platform: android
      cwe: CWE-200
      confidence: medium
      subcategory: configuration
      vulnerability_class: "Security Misconfiguration"
      owasp: "A01:2021"

  # JNDI injection
  - id: java-jndi-injection
    message: "Injection vulnerability. User input reaches a downstream interpreter without sanitization. Sanitize or parameterize all user-controlled data."
    severity: CRITICAL
    languages: [java]
    pattern-either:
      - pattern: $CTX.lookup($USER_INPUT)
      - pattern: new InitialContext().lookup($USER_INPUT)
      - pattern: InitialContext.doLookup($USER_INPUT)
    metadata:
      category: security
      cwe: CWE-74
      confidence: medium
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Sanitize or parameterize all user-controlled data before passing to interpreters."

  # Expression Language injection
  - id: java-el-injection
    message: "Code injection vulnerability detected. User-controlled input is passed to a code evaluation function, allowing arbitrary code execution. Avoid eval/exec with user input; use safe alternatives."
    severity: HIGH
    languages: [java]
    pattern-either:
      - pattern: $FACTORY.createValueExpression($USER_INPUT, ...)
      - pattern: $FACTORY.createMethodExpression($USER_INPUT, ...)
    metadata:
      category: security
      cwe: CWE-94
      confidence: medium
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Avoid ScriptEngine.eval() with user input. Use a sandboxed interpreter or template engine. Restrict class loading with a SecurityManager."

  # Template injection
  - id: java-template-injection
    message: "Code injection vulnerability detected. User-controlled input is passed to a code evaluation function, allowing arbitrary code execution. Avoid eval/exec with user input; use safe alternatives."
    severity: HIGH
    languages: [java]
    pattern-either:
      - pattern: new VelocityEngine().evaluate($USER_INPUT, ...)
      - pattern: Template.make($USER_INPUT)
      - pattern: $ENGINE.process($USER_INPUT, ...)
    metadata:
      category: security
      cwe: CWE-94
      confidence: medium
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Avoid ScriptEngine.eval() with user input. Use a sandboxed interpreter or template engine. Restrict class loading with a SecurityManager."

  # File upload without validation
  - id: java-file-upload-no-validation
    message: "Unrestricted file upload detected. Accepting uploads without validating file type and content can allow execution of malicious code. Validate file type, size, and content before storing."
    severity: HIGH
    languages: [java]
    pattern-either:
      - pattern: |
          @RequestMapping(method = RequestMethod.POST)
          public String handleFileUpload(@RequestParam("file") MultipartFile file) {
            ...
            file.transferTo(new File($PATH));
            ...
          }
    pattern-not-inside:
      pattern: |
        ...
        if (!$FILE.getContentType().equals(...)) {
          ...
        }
        ...
    metadata:
      category: security
      cwe: CWE-434
      confidence: low
      subcategory: upload
      vulnerability_class: "Unrestricted File Upload"
      owasp: "A04:2021"
      fix: "Validate file extension, MIME type, and content. Store uploads outside the web root. Use Apache Tika for content-type detection."