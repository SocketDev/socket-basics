rules:
  # ===== ELIXIR SECURITY RULES =====

  # === Critical Severity Rules ===

  # Code injection
  - id: elixir-code-injection
    message: "Code injection vulnerability detected. User-controlled input is passed to a code evaluation function, allowing arbitrary code execution. Avoid eval/exec with user input; use safe alternatives."
    severity: CRITICAL
    languages: [elixir]
    pattern-either:
      - pattern: Code.eval_string($USER_INPUT)
      - pattern: Code.eval_string($USER_INPUT, ...)
      - pattern: Code.compile_string($USER_INPUT)
      - pattern: Code.compile_string($USER_INPUT, ...)
    metadata:
      category: security
      cwe: CWE-94
      confidence: high
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Remove Code.eval_string/1 calls with user input. Use pattern matching and safe parsing instead. Never evaluate untrusted Elixir code."

  # SQL injection
  - id: elixir-sql-injection
    message: "SQL injection vulnerability detected. User-supplied input is included in a SQL query without sanitization, potentially allowing attackers to read, modify, or delete database contents. Use parameterized queries or an ORM instead of string concatenation."
    severity: CRITICAL
    languages: [elixir]
    pattern-either:
      - pattern: Ecto.Adapters.SQL.query($REPO, $QUERY <> $USER_INPUT, [])
      - pattern: "\"SELECT * FROM users WHERE id = #{$USER_INPUT}\""
      - pattern: fragment($QUERY <> $USER_INPUT)
      - pattern: Repo.query($QUERY <> $USER_INPUT)
    metadata:
      category: security
      cwe: CWE-89
      confidence: medium
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Use Ecto parameterized queries: Repo.all(from u in User, where: u.id == ^user_id). Never interpolate user input into raw SQL."

  # Command injection
  - id: elixir-command-injection
    message: "OS command injection vulnerability detected. User-controlled data flows into a system command without proper sanitization, allowing attackers to execute arbitrary commands. Use safe APIs with argument lists instead of shell execution."
    severity: CRITICAL
    languages: [elixir]
    pattern-either:
      - pattern: System.cmd($CMD, [$USER_INPUT])
      - pattern: System.cmd($USER_INPUT, ...)
      - pattern: "Port.open({:spawn, $USER_INPUT}, [])"
      - pattern: "Port.open({:spawn_executable, $USER_INPUT}, [])"
    metadata:
      category: security
      cwe: CWE-78
      confidence: medium
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Use System.cmd/2 with separate arguments: System.cmd(\"cmd\", [arg1, arg2]). Never pass user input to :os.cmd/1."

  # Unsafe deserialization
  - id: elixir-unsafe-deserialization
    message: "Unsafe deserialization detected. Deserializing untrusted data can lead to remote code execution or denial of service. Use safe serialization formats like JSON or validate data before deserializing."
    severity: CRITICAL
    languages: [elixir]
    pattern-either:
      - pattern: ":erlang.binary_to_term($USER_INPUT)"
      - pattern: Plug.Crypto.MessageVerifier.verify($TOKEN, $USER_INPUT)
    pattern-not-inside:
      pattern: ":erlang.binary_to_term($USER_INPUT, [:safe])"
    metadata:
      category: security
      cwe: CWE-502
      confidence: high
      subcategory: integrity
      vulnerability_class: "Insecure Deserialization"
      owasp: "A08:2021"
      fix: "Use Jason.decode/1 or :erlang.binary_to_term/2 with [:safe] option. Never use :erlang.binary_to_term/1 on untrusted data."

  # === High Severity Rules ===

  # Hardcoded secrets
  - id: elixir-hardcoded-secrets
    message: "Hard-coded credentials detected. Embedding secrets in source code makes them easily discoverable and impossible to rotate. Use environment variables or a secrets manager instead."
    severity: HIGH
    languages: [elixir]
    pattern-either:
      - pattern: '@password "..."'
      - pattern: '@secret "..."'
      - pattern: '@api_key "..."'
      - pattern: '[password: "..."]'
      - pattern: '[secret: "..."]'
      - pattern: '[api_key: "..."]'
    metadata:
      category: security
      cwe: CWE-798
      confidence: medium
      subcategory: authentication
      vulnerability_class: "Authentication Weakness"
      owasp: "A07:2021"
      fix: "Store secrets in environment variables (System.get_env/1) or use runtime configuration. Use config/runtime.exs for production secrets."

  # Weak cryptography
  - id: elixir-weak-crypto
    message: "Weak cryptographic algorithm detected. Using broken or outdated algorithms may allow attackers to decrypt data or forge signatures. Use modern algorithms like AES-256, SHA-256, or Ed25519."
    severity: HIGH
    languages: [elixir]
    pattern-either:
      - pattern: ":crypto.hash(:md5, $DATA)"
      - pattern: ":crypto.hash(:sha, $DATA)"
      - pattern: "Base.encode16(:crypto.hash(:md5, $DATA))"
      - pattern: "Base.encode16(:crypto.hash(:sha, $DATA))"
    metadata:
      category: security
      cwe: CWE-327
      confidence: high
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"
      fix: "Use :crypto.hash(:sha256, data) instead of :md5/:sha. Use :crypto.crypto_one_time_aead for AES-GCM encryption."

  # Path traversal
  - id: elixir-path-traversal
    message: "Path traversal vulnerability detected. User input is used in file paths without validation, allowing attackers to access files outside the intended directory. Validate and canonicalize paths before use."
    severity: HIGH
    languages: [elixir]
    pattern-either:
      - pattern: File.read($PATH <> $USER_INPUT)
      - pattern: File.write($PATH <> $USER_INPUT, ...)
      - pattern: File.open($PATH <> $USER_INPUT, ...)
      - pattern: Path.join($BASE, $USER_INPUT)
    metadata:
      category: security
      cwe: CWE-22
      confidence: medium
      subcategory: access-control
      vulnerability_class: "Access Control Violation"
      owasp: "A01:2021"
      fix: "Use Path.expand/1 and verify the result starts with the allowed base directory. Reject paths containing '..' components."

  # XSS vulnerabilities
  - id: elixir-xss
    message: "Cross-site scripting (XSS) vulnerability detected. User input is rendered in HTML output without proper escaping, allowing attackers to inject malicious scripts. Sanitize or escape all user input before rendering."
    severity: HIGH
    languages: [elixir]
    pattern-either:
      - pattern: raw($USER_INPUT)
      - pattern: Phoenix.HTML.raw($USER_INPUT)
      - pattern: html_escape($USER_INPUT)
    metadata:
      category: security
      cwe: CWE-79
      confidence: low
      subcategory: xss
      vulnerability_class: "Cross-Site Scripting (XSS)"
      owasp: "A03:2021"
      fix: "Phoenix templates auto-escape by default. Never use raw/1 or {:safe, ...} with user input. Use Phoenix.HTML.html_escape/1 for manual escaping."

  # Open redirect
  - id: elixir-open-redirect
    message: "Open redirect vulnerability detected. The application redirects to a user-controlled URL without validation, enabling phishing attacks. Validate redirect targets against an allowlist."
    severity: HIGH
    languages: [elixir]
    pattern-either:
      - pattern: "redirect(conn, external: $USER_INPUT)"
      - pattern: "Phoenix.Controller.redirect(conn, external: $USER_INPUT)"
    metadata:
      category: security
      cwe: CWE-601
      confidence: medium
      subcategory: access-control
      vulnerability_class: "Access Control Violation"
      owasp: "A01:2021"
      fix: "Validate redirect URLs against an allowlist of trusted paths or domains. Use relative paths for internal redirects. Reject external URLs."

  # === Medium Severity Rules ===

  # Insecure random
  - id: elixir-insecure-random
    message: "Insecure random number generator used. Non-cryptographic PRNGs produce predictable values that attackers can guess. Use a cryptographically secure random generator for security-sensitive operations."
    severity: MEDIUM
    languages: [elixir]
    pattern-either:
      - pattern: ":rand.uniform()"
      - pattern: ":rand.uniform($N)"
      - pattern: ":random.uniform()"
      - pattern: Enum.random($LIST)
    metadata:
      category: security
      cwe: CWE-338
      confidence: low
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"

  # HTTP instead of HTTPS
  - id: elixir-insecure-http
    message: "Sensitive data transmitted over an unencrypted channel. Using HTTP instead of HTTPS allows network attackers to intercept data in transit. Use HTTPS for all communications containing sensitive data."
    severity: MEDIUM
    languages: [elixir]
    pattern-either:
      - pattern: HTTPoison.get("http://...")
      - pattern: Tesla.get("http://...")
      - pattern: HTTPoison.post("http://...", ...)
      - pattern: Tesla.post("http://...", ...)
    metadata:
      category: security
      cwe: CWE-319
      confidence: low
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"

  # Weak session configuration
  - id: elixir-weak-session
    message: "Sensitive cookie missing the Secure flag. The cookie may be transmitted over unencrypted HTTP, allowing interception. Set the Secure flag on all sensitive cookies."
    severity: MEDIUM
    languages: [elixir]
    pattern-either:
      - pattern: |
          plug Plug.Session,
            store: :cookie,
            key: "_app_session",
            secure: false
      - pattern: |
          plug Plug.Session,
            store: :cookie,
            key: "_app_session",
            http_only: false
    metadata:
      category: security
      cwe: CWE-614
      confidence: medium
      subcategory: configuration
      vulnerability_class: "Security Misconfiguration"
      owasp: "A05:2021"

  # CSRF protection bypass
  - id: elixir-csrf-bypass
    message: "Cross-site request forgery (CSRF) vulnerability. The application does not verify that requests originate from its own interface. Implement CSRF tokens on all state-changing operations."
    severity: MEDIUM
    languages: [elixir]
    pattern-either:
      - pattern: "protect_from_forgery with: :null_session"
      - pattern: skip_csrf_protection
    metadata:
      category: security
      cwe: CWE-352
      confidence: medium
      subcategory: access-control
      vulnerability_class: "Access Control Violation"
      owasp: "A01:2021"

  # === Low Severity Rules ===

  # Debug information disclosure
  - id: elixir-debug-info-disclosure
    message: "Sensitive information written to log files. Passwords, tokens, or personal data in logs can be exposed to unauthorized parties. Redact sensitive values before logging."
    severity: LOW
    languages: [elixir]
    patterns:
      - pattern-either:
          - pattern: IO.puts($USER_INPUT)
          - pattern: IO.inspect($USER_INPUT)
          - pattern: Logger.debug($USER_INPUT)
          - pattern: Logger.info($USER_INPUT)
      - metavariable-regex:
          metavariable: $USER_INPUT
          regex: (?i).*(password|token|secret|key|credential).*
    metadata:
      category: security
      cwe: CWE-532
      confidence: low
      subcategory: logging
      vulnerability_class: "Sensitive Data Exposure"
      owasp: "A09:2021"

  # Hardcoded IP addresses
  - id: elixir-hardcoded-ip
    message: "Hard-coded credentials detected. Embedding secrets in source code makes them easily discoverable and impossible to rotate. Use environment variables or a secrets manager instead."
    severity: LOW
    languages: [elixir]
    pattern-either:
      - pattern: '"192.168.$X.$Y"'
      - pattern: '"10.$X.$Y.$Z"'
      - pattern: '"172.16.$X.$Y"'
      - pattern: '"127.0.0.1"'
      - pattern: '"localhost"'
    metadata:
      category: security
      cwe: CWE-798
      confidence: low
      subcategory: authentication
      vulnerability_class: "Authentication Weakness"
      owasp: "A07:2021"

  # === Phoenix Framework Rules ===

  # Phoenix XSS
  - id: elixir-phoenix-xss
    message: "Cross-site scripting (XSS) vulnerability detected. User input is rendered in HTML output without proper escaping, allowing attackers to inject malicious scripts. Sanitize or escape all user input before rendering."
    severity: HIGH
    languages: [elixir]
    pattern-either:
      - pattern: 'raw($USER_INPUT)'
      - pattern: 'content_tag(:div, $USER_INPUT, class: "content")'
      - pattern: 'Phoenix.HTML.raw($USER_INPUT)'
    metadata:
      category: security
      framework: phoenix
      cwe: CWE-79
      confidence: low
      subcategory: xss
      vulnerability_class: "Cross-Site Scripting (XSS)"
      owasp: "A03:2021"
      references:
        - https://hexdocs.pm/phoenix/security.html
      fix: "Phoenix templates auto-escape by default. Never use raw/1 or {:safe, ...} with user input. Use Phoenix.HTML.html_escape/1 for manual escaping."

  # Phoenix SQL injection in Ecto
  - id: elixir-phoenix-ecto-injection
    message: "SQL injection vulnerability detected. User-supplied input is included in a SQL query without sanitization, potentially allowing attackers to read, modify, or delete database contents. Use parameterized queries or an ORM instead of string concatenation."
    severity: CRITICAL
    languages: [elixir]
    pattern-either:
      - pattern: 'fragment("... #{$USER_INPUT} ...")'
      - pattern: 'Repo.query("... #{$USER_INPUT} ...")'
      - pattern: 'Ecto.Adapters.SQL.query!($REPO, "... #{$USER_INPUT} ...")'
    metadata:
      category: security
      framework: phoenix
      cwe: CWE-89
      confidence: high
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      references:
        - https://hexdocs.pm/phoenix/security.html
      fix: "Use Ecto parameterized queries: Repo.all(from u in User, where: u.id == ^user_id). Never interpolate user input into raw SQL."

  # Phoenix insecure routes
  - id: elixir-phoenix-insecure-routes
    message: "Missing authorization check. The application does not verify user permissions before granting access to resources. Add authorization checks to all protected endpoints."
    severity: MEDIUM
    languages: [elixir]
    pattern-either:
      - pattern: |
          scope "/admin" do
            pipe_through :browser
            # No authentication pipeline
          end
      - pattern: |
          get "/api/admin/:id", AdminController, :show
    metadata:
      category: security
      framework: phoenix
      cwe: CWE-862
      confidence: low
      subcategory: access-control
      vulnerability_class: "Access Control Violation"
      owasp: "A01:2021"
      references:
        - https://hexdocs.pm/phoenix/security.html

  # Phoenix file upload without validation
  - id: elixir-phoenix-file-upload
    message: "Unrestricted file upload detected. Accepting uploads without validating file type and content can allow execution of malicious code. Validate file type, size, and content before storing."
    severity: HIGH
    languages: [elixir]
    pattern-either:
      - pattern: |
          def upload(conn, %{"file" => file}) do
            File.copy(file.path, "/uploads/" <> file.filename)
          end
    pattern-not-inside:
      pattern: |
        ...
        if file.content_type in @allowed_types do
          ...
        end
        ...
    metadata:
      category: security
      framework: phoenix
      cwe: CWE-434
      confidence: low
      subcategory: upload
      vulnerability_class: "Unrestricted File Upload"
      owasp: "A04:2021"
      references:
        - https://hexdocs.pm/phoenix/security.html
      fix: "Validate file extension, MIME type, and content. Store uploads outside the web root. Use Plug.Upload metadata for validation."
