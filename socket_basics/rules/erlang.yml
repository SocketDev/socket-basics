rules:
  # ===== ELIXIR SECURITY RULES =====

  # === Critical Severity Rules ===

  # Code injection
  - id: elixir-code-injection
    message: "Code injection vulnerability detected. User-controlled input is passed to a code evaluation function, allowing arbitrary code execution. Avoid eval/exec with user input; use safe alternatives."
    severity: CRITICAL
    languages: [elixir]
    pattern-either:
      - pattern: Code.eval_string($USER_INPUT)
      - pattern: Code.eval_string($USER_INPUT, ...)
      - pattern: Code.compile_string($USER_INPUT)
      - pattern: Code.compile_string($USER_INPUT, ...)
    metadata:
      category: security
      cwe: CWE-94
      confidence: high
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Avoid erl_eval:expr/2 and erl_scan with user input. Use pattern matching and safe parsing instead. Never evaluate untrusted Erlang terms."

  # SQL injection
  - id: elixir-sql-injection
    message: "SQL injection vulnerability detected. User-supplied input is included in a SQL query without sanitization, potentially allowing attackers to read, modify, or delete database contents. Use parameterized queries or an ORM instead of string concatenation."
    severity: CRITICAL
    languages: [elixir]
    pattern-either:
      - pattern: Ecto.Adapters.SQL.query($REPO, $QUERY <> $USER_INPUT, [])
      - pattern: "SELECT * FROM users WHERE id = #{$USER_INPUT}"
      - pattern: fragment($QUERY <> $USER_INPUT)
      - pattern: Repo.query($QUERY <> $USER_INPUT)
    metadata:
      category: security
      cwe: CWE-89
      confidence: medium
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Use parameterized queries with your database driver, e.g., epgsql:equery(C, \"SELECT * FROM t WHERE id = $1\", [UserId])."

  # Command injection
  - id: elixir-command-injection
    message: "OS command injection vulnerability detected. User-controlled data flows into a system command without proper sanitization, allowing attackers to execute arbitrary commands. Use safe APIs with argument lists instead of shell execution."
    severity: CRITICAL
    languages: [elixir]
    pattern-either:
      - pattern: System.cmd($CMD, [$USER_INPUT])
      - pattern: System.cmd($USER_INPUT, ...)
      - pattern: "Port.open({:spawn, $USER_INPUT}, [])"
      - pattern: "Port.open({:spawn_executable, $USER_INPUT}, [])"
    metadata:
      category: security
      cwe: CWE-78
      confidence: medium
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Use erlang:open_port with {spawn_executable, Cmd} and {args, Args} instead of os:cmd/1. Never interpolate user input into commands."

  # Unsafe deserialization
  - id: elixir-unsafe-deserialization
    message: "Unsafe deserialization detected. Deserializing untrusted data can lead to remote code execution or denial of service. Use safe serialization formats like JSON or validate data before deserializing."
    severity: CRITICAL
    languages: [elixir]
    pattern-either:
      - pattern: ":erlang.binary_to_term($USER_INPUT)"
      - pattern: Plug.Crypto.MessageVerifier.verify($TOKEN, $USER_INPUT)
    pattern-not-inside:
      pattern: ":erlang.binary_to_term($USER_INPUT, [:safe])"
    metadata:
      category: security
      cwe: CWE-502
      confidence: high
      subcategory: integrity
      vulnerability_class: "Insecure Deserialization"
      owasp: "A08:2021"
      fix: "Use binary_to_term/2 with [safe] option. Use jsx or jiffy for JSON deserialization. Never use binary_to_term/1 on untrusted data."

  # === High Severity Rules ===

  # Hardcoded secrets
  - id: elixir-hardcoded-secrets
    message: "Hard-coded credentials detected. Embedding secrets in source code makes them easily discoverable and impossible to rotate. Use environment variables or a secrets manager instead."
    severity: HIGH
    languages: [elixir]
    pattern-either:
      - pattern: |
          @password "..."
      - pattern: |
          @secret "..."
      - pattern: |
          @api_key "..."
      - pattern: |
          password: "..."
      - pattern: |
          secret: "..."
      - pattern: |
          api_key: "..."
    metadata:
      category: security
      cwe: CWE-798
      confidence: medium
      subcategory: authentication
      vulnerability_class: "Authentication Weakness"
      owasp: "A07:2021"
      fix: "Store secrets in environment variables (os:getenv/1) or use a secrets manager. Load secrets from configuration files excluded from version control."

  # Weak cryptography
  - id: elixir-weak-crypto
    message: "Weak cryptographic algorithm detected. Using broken or outdated algorithms may allow attackers to decrypt data or forge signatures. Use modern algorithms like AES-256, SHA-256, or Ed25519."
    severity: HIGH
    languages: [elixir]
    pattern-either:
      - pattern: ":crypto.hash(:md5, $DATA)"
      - pattern: ":crypto.hash(:sha, $DATA)"
      - pattern: "Base.encode16(:crypto.hash(:md5, $DATA))"
      - pattern: "Base.encode16(:crypto.hash(:sha, $DATA))"
    metadata:
      category: security
      cwe: CWE-327
      confidence: high
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"
      fix: "Use crypto:hash(sha256, Data) instead of md5/sha. Use crypto:crypto_one_time_aead for AES-GCM encryption."

  # Path traversal
  - id: elixir-path-traversal
    message: "Path traversal vulnerability detected. User input is used in file paths without validation, allowing attackers to access files outside the intended directory. Validate and canonicalize paths before use."
    severity: HIGH
    languages: [elixir]
    pattern-either:
      - pattern: File.read($PATH <> $USER_INPUT)
      - pattern: File.write($PATH <> $USER_INPUT, ...)
      - pattern: File.open($PATH <> $USER_INPUT, ...)
      - pattern: Path.join($BASE, $USER_INPUT)
    metadata:
      category: security
      cwe: CWE-22
      confidence: medium
      subcategory: access-control
      vulnerability_class: "Access Control Violation"
      owasp: "A01:2021"
      fix: "Use filename:absname/1 and verify the result starts with the allowed base directory. Reject paths containing '..' components."

  # XSS vulnerabilities
  - id: elixir-xss
    message: "Cross-site scripting (XSS) vulnerability detected. User input is rendered in HTML output without proper escaping, allowing attackers to inject malicious scripts. Sanitize or escape all user input before rendering."
    severity: HIGH
    languages: [elixir]
    pattern-either:
      - pattern: raw($USER_INPUT)
      - pattern: Phoenix.HTML.raw($USER_INPUT)
      - pattern: html_escape($USER_INPUT)
    metadata:
      category: security
      cwe: CWE-79
      confidence: low
      subcategory: xss
      vulnerability_class: "Cross-Site Scripting (XSS)"
      owasp: "A03:2021"
      fix: "Escape all user input before inserting into HTML output. Use a templating library with auto-escaping enabled."

  # Open redirect
  - id: elixir-open-redirect
    message: "Open redirect vulnerability detected. The application redirects to a user-controlled URL without validation, enabling phishing attacks. Validate redirect targets against an allowlist."
    severity: HIGH
    languages: [elixir]
    pattern-either:
      - pattern: "redirect(conn, external: $USER_INPUT)"
      - pattern: "Phoenix.Controller.redirect(conn, external: $USER_INPUT)"
    metadata:
      category: security
      cwe: CWE-601
      confidence: medium
      subcategory: access-control
      vulnerability_class: "Access Control Violation"
      owasp: "A01:2021"
      fix: "Validate redirect URLs against an allowlist of trusted paths or domains. Use relative paths for internal redirects. Reject external URLs."

  # === Medium Severity Rules ===

  # Insecure random
  - id: elixir-insecure-random
    message: "Insecure random number generator used. Non-cryptographic PRNGs produce predictable values that attackers can guess. Use a cryptographically secure random generator for security-sensitive operations."
    severity: MEDIUM
    languages: [elixir]
    pattern-either:
      - pattern: ":rand.uniform()"
      - pattern: ":rand.uniform($N)"
      - pattern: ":random.uniform()"
      - pattern: Enum.random($LIST)
    metadata:
      category: security
      cwe: CWE-338
      confidence: low
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"

  # HTTP instead of HTTPS
  - id: elixir-insecure-http
    message: "Sensitive data transmitted over an unencrypted channel. Using HTTP instead of HTTPS allows network attackers to intercept data in transit. Use HTTPS for all communications containing sensitive data."
    severity: MEDIUM
    languages: [elixir]
    pattern-either:
      - pattern: "http://..."
      - pattern: "'http://...'"
      - pattern: HTTPoison.get("http://...")
      - pattern: Tesla.get("http://...")
    metadata:
      category: security
      cwe: CWE-319
      confidence: low
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"

  # Weak session configuration
  - id: elixir-weak-session
    message: "Sensitive cookie missing the Secure flag. The cookie may be transmitted over unencrypted HTTP, allowing interception. Set the Secure flag on all sensitive cookies."
    severity: MEDIUM
    languages: [elixir]
    pattern-either:
      - pattern: |
          plug Plug.Session,
            store: :cookie,
            key: "_app_session",
            secure: false
      - pattern: |
          plug Plug.Session,
            store: :cookie,
            key: "_app_session",
            http_only: false
    metadata:
      category: security
      cwe: CWE-614
      confidence: medium
      subcategory: configuration
      vulnerability_class: "Security Misconfiguration"
      owasp: "A05:2021"

  # CSRF protection bypass
  - id: elixir-csrf-bypass
    message: "Cross-site request forgery (CSRF) vulnerability. The application does not verify that requests originate from its own interface. Implement CSRF tokens on all state-changing operations."
    severity: MEDIUM
    languages: [elixir]
    pattern-either:
      - pattern: "protect_from_forgery with: :null_session"
      - pattern: skip_csrf_protection
    metadata:
      category: security
      cwe: CWE-352
      confidence: medium
      subcategory: access-control
      vulnerability_class: "Access Control Violation"
      owasp: "A01:2021"

  # === Low Severity Rules ===

  # Debug information disclosure
  - id: elixir-debug-info-disclosure
    message: "Sensitive information written to log files. Passwords, tokens, or personal data in logs can be exposed to unauthorized parties. Redact sensitive values before logging."
    severity: LOW
    languages: [elixir]
    patterns:
      - pattern-either:
          - pattern: IO.puts($USER_INPUT)
          - pattern: IO.inspect($USER_INPUT)
          - pattern: Logger.debug($USER_INPUT)
          - pattern: Logger.info($USER_INPUT)
      - metavariable-regex:
          metavariable: $USER_INPUT
          regex: (?i).*(password|token|secret|key|credential).*
    metadata:
      category: security
      cwe: CWE-532
      confidence: low
      subcategory: logging
      vulnerability_class: "Sensitive Data Exposure"
      owasp: "A09:2021"

  # Hardcoded IP addresses
  - id: elixir-hardcoded-ip
    message: "Hard-coded credentials detected. Embedding secrets in source code makes them easily discoverable and impossible to rotate. Use environment variables or a secrets manager instead."
    severity: LOW
    languages: [elixir]
    pattern-either:
      - pattern: "192.168...."
      - pattern: "10...."
      - pattern: "172.16...."
      - pattern: "127.0.0.1"
      - pattern: 'localhost'
    metadata:
      category: security
      cwe: CWE-798
      confidence: low
      subcategory: authentication
      vulnerability_class: "Authentication Weakness"
      owasp: "A07:2021"

  # === Phoenix Framework Rules ===

  # Phoenix XSS
  - id: elixir-phoenix-xss
    message: "Cross-site scripting (XSS) vulnerability detected. User input is rendered in HTML output without proper escaping, allowing attackers to inject malicious scripts. Sanitize or escape all user input before rendering."
    severity: HIGH
    languages: [elixir]
    pattern-either:
      - pattern: |
          <%= $USER_INPUT %>
      - pattern: |
          <%= raw $USER_INPUT %>
      - pattern: 'content_tag(:div, $USER_INPUT, class: "content")'
    metadata:
      category: security
      framework: phoenix
      cwe: CWE-79
      confidence: low
      subcategory: xss
      vulnerability_class: "Cross-Site Scripting (XSS)"
      owasp: "A03:2021"
      references:
        - https://hexdocs.pm/phoenix/security.html
      fix: "Escape all user input before inserting into HTML output. Use a templating library with auto-escaping enabled."

  # Phoenix SQL injection in Ecto
  - id: elixir-phoenix-ecto-injection
    message: "SQL injection vulnerability detected. User-supplied input is included in a SQL query without sanitization, potentially allowing attackers to read, modify, or delete database contents. Use parameterized queries or an ORM instead of string concatenation."
    severity: CRITICAL
    languages: [elixir]
    pattern-either:
      - pattern: |
          from u in User,
          where: fragment("name = #{$USER_INPUT}")
      - pattern: Repo.query("SELECT * FROM users WHERE id = #{$USER_INPUT}")
    metadata:
      category: security
      framework: phoenix
      cwe: CWE-89
      confidence: high
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      references:
        - https://hexdocs.pm/phoenix/security.html
      fix: "Use parameterized queries with your database driver, e.g., epgsql:equery(C, \"SELECT * FROM t WHERE id = $1\", [UserId])."

  # Phoenix insecure routes
  - id: elixir-phoenix-insecure-routes
    message: "Missing authorization check. The application does not verify user permissions before granting access to resources. Add authorization checks to all protected endpoints."
    severity: MEDIUM
    languages: [elixir]
    pattern-either:
      - pattern: |
          scope "/admin" do
            pipe_through :browser
            # No authentication pipeline
          end
      - pattern: |
          get "/api/admin/:id", AdminController, :show
    metadata:
      category: security
      framework: phoenix
      cwe: CWE-862
      confidence: low
      subcategory: access-control
      vulnerability_class: "Access Control Violation"
      owasp: "A01:2021"
      references:
        - https://hexdocs.pm/phoenix/security.html

  # Phoenix file upload without validation
  - id: elixir-phoenix-file-upload
    message: "Unrestricted file upload detected. Accepting uploads without validating file type and content can allow execution of malicious code. Validate file type, size, and content before storing."
    severity: HIGH
    languages: [elixir]
    pattern-either:
      - pattern: |
          def upload(conn, %{"file" => file}) do
            File.copy(file.path, "/uploads/" <> file.filename)
          end
    pattern-not-inside:
      pattern: |
        ...
        if file.content_type in @allowed_types do
          ...
        end
        ...
    metadata:
      category: security
      framework: phoenix
      cwe: CWE-434
      confidence: low
      subcategory: upload
      vulnerability_class: "Unrestricted File Upload"
      owasp: "A04:2021"
      references:
        - https://hexdocs.pm/phoenix/security.html
      fix: "Validate file extension, MIME type, and content. Store uploads outside the web root with randomized filenames."

  # ===== ERLANG SECURITY RULES =====

  # === Critical Severity Rules ===

  # Code injection
  - id: erlang-code-injection
    message: "Code injection vulnerability detected. User-controlled input is passed to a code evaluation function, allowing arbitrary code execution. Avoid eval/exec with user input; use safe alternatives."
    severity: CRITICAL
    languages: [erlang]
    pattern-either:
      - pattern: "erl_eval:expr($USER_INPUT, [])"
      - pattern: "erl_scan:string($USER_INPUT)"
      - pattern: "erl_parse:parse_exprs($USER_INPUT)"
      - pattern: eval($USER_INPUT)
    metadata:
      category: security
      cwe: CWE-94
      confidence: high
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Avoid erl_eval:expr/2 and erl_scan with user input. Use pattern matching and safe parsing instead. Never evaluate untrusted Erlang terms."

  # Command injection
  - id: erlang-command-injection
    message: "OS command injection vulnerability detected. User-controlled data flows into a system command without proper sanitization, allowing attackers to execute arbitrary commands. Use safe APIs with argument lists instead of shell execution."
    severity: CRITICAL
    languages: [erlang]
    pattern-either:
      - pattern: "os:cmd($USER_INPUT)"
      - pattern: "erlang:open_port({spawn, $USER_INPUT}, [])"
      - pattern: "erlang:open_port({spawn_executable, $USER_INPUT}, [])"
    metadata:
      category: security
      cwe: CWE-78
      confidence: high
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Use erlang:open_port with {spawn_executable, Cmd} and {args, Args} instead of os:cmd/1. Never interpolate user input into commands."

  # Unsafe deserialization
  - id: erlang-unsafe-deserialization
    message: "Unsafe deserialization detected. Deserializing untrusted data can lead to remote code execution or denial of service. Use safe serialization formats like JSON or validate data before deserializing."
    severity: CRITICAL
    languages: [erlang]
    pattern-either:
      - pattern: "erlang:binary_to_term($USER_INPUT)"
      - pattern: "erlang:binary_to_term($USER_INPUT, [])"
    pattern-not-inside:
      pattern: "erlang:binary_to_term($USER_INPUT, [safe])"
    metadata:
      category: security
      cwe: CWE-502
      confidence: high
      subcategory: integrity
      vulnerability_class: "Insecure Deserialization"
      owasp: "A08:2021"
      fix: "Use binary_to_term/2 with [safe] option. Use jsx or jiffy for JSON deserialization. Never use binary_to_term/1 on untrusted data."

  # === High Severity Rules ===

  # Hardcoded secrets
  - id: erlang-hardcoded-secrets
    message: "Hard-coded credentials detected. Embedding secrets in source code makes them easily discoverable and impossible to rotate. Use environment variables or a secrets manager instead."
    severity: HIGH
    languages: [erlang]
    pattern-either:
      - pattern: |
          Password = "...",
      - pattern: |
          Secret = "...",
      - pattern: |
          ApiKey = "...",
      - pattern: |
          -define(PASSWORD, "...").
      - pattern: |
          -define(SECRET, "...").
    metadata:
      category: security
      cwe: CWE-798
      confidence: medium
      subcategory: authentication
      vulnerability_class: "Authentication Weakness"
      owasp: "A07:2021"
      fix: "Store secrets in environment variables (os:getenv/1) or use a secrets manager. Load secrets from configuration files excluded from version control."

  # Weak cryptography
  - id: erlang-weak-crypto
    message: "Weak cryptographic algorithm detected. Using broken or outdated algorithms may allow attackers to decrypt data or forge signatures. Use modern algorithms like AES-256, SHA-256, or Ed25519."
    severity: HIGH
    languages: [erlang]
    pattern-either:
      - pattern: "crypto:hash(md5, $DATA)"
      - pattern: "crypto:hash(sha, $DATA)"
      - pattern: "erlang:md5($DATA)"
      - pattern: "crypto:md5($DATA)"
    metadata:
      category: security
      cwe: CWE-327
      confidence: high
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"
      fix: "Use crypto:hash(sha256, Data) instead of md5/sha. Use crypto:crypto_one_time_aead for AES-GCM encryption."

  # Path traversal
  - id: erlang-path-traversal
    message: "Path traversal vulnerability detected. User input is used in file paths without validation, allowing attackers to access files outside the intended directory. Validate and canonicalize paths before use."
    severity: HIGH
    languages: [erlang]
    pattern-either:
      - pattern: "file:read_file($PATH ++ $USER_INPUT)"
      - pattern: "file:write_file($PATH ++ $USER_INPUT, $DATA)"
      - pattern: "file:open($PATH ++ $USER_INPUT, ...)"
    metadata:
      category: security
      cwe: CWE-22
      confidence: medium
      subcategory: access-control
      vulnerability_class: "Access Control Violation"
      owasp: "A01:2021"
      fix: "Use filename:absname/1 and verify the result starts with the allowed base directory. Reject paths containing '..' components."

  # === Medium Severity Rules ===

  # Insecure random
  - id: erlang-insecure-random
    message: "Insecure random number generator used. Non-cryptographic PRNGs produce predictable values that attackers can guess. Use a cryptographically secure random generator for security-sensitive operations."
    severity: MEDIUM
    languages: [erlang]
    pattern-either:
      - pattern: "random:uniform()"
      - pattern: "random:uniform($N)"
      - pattern: "rand:uniform()"
      - pattern: "rand:uniform($N)"
    metadata:
      category: security
      cwe: CWE-338
      confidence: low
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"

  # HTTP instead of HTTPS
  - id: erlang-insecure-http
    message: "Sensitive data transmitted over an unencrypted channel. Using HTTP instead of HTTPS allows network attackers to intercept data in transit. Use HTTPS for all communications containing sensitive data."
    severity: MEDIUM
    languages: [erlang]
    pattern-either:
      - pattern: "http://..."
      - pattern: "'http://...'"
      - pattern: httpc:request("http://...")
      - pattern: inets:start(httpc, "http://...")
    metadata:
      category: security
      cwe: CWE-319
      confidence: low
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"

  # SSL/TLS configuration issues
  - id: erlang-ssl-insecure
    message: "TLS/SSL certificate validation is disabled or bypassed. This allows man-in-the-middle attacks where attackers can intercept encrypted communications. Always validate certificates in production."
    severity: MEDIUM
    languages: [erlang]
    pattern-either:
      - pattern: "ssl:connect($HOST, $PORT, [{verify, verify_none}])"
      - pattern: "ssl:connect($HOST, $PORT, [{fail_if_no_peer_cert, false}])"
      - pattern: "ssl:listen($PORT, [{verify, verify_none}])"
    metadata:
      category: security
      cwe: CWE-295
      confidence: high
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A07:2021"

  # === Low Severity Rules ===

  # Debug information disclosure
  - id: erlang-debug-info-disclosure
    message: "Sensitive information written to log files. Passwords, tokens, or personal data in logs can be exposed to unauthorized parties. Redact sensitive values before logging."
    severity: LOW
    languages: [erlang]
    patterns:
      - pattern-either:
          - pattern: io:format("~p~n", [$USER_INPUT])
          - pattern: "error_logger:info_msg($USER_INPUT)"
          - pattern: "lager:debug($USER_INPUT)"
      - metavariable-regex:
          metavariable: $USER_INPUT
          regex: (?i).*(password|token|secret|key|credential).*
    metadata:
      category: security
      cwe: CWE-532
      confidence: low
      subcategory: logging
      vulnerability_class: "Sensitive Data Exposure"
      owasp: "A09:2021"

  # Hardcoded IP addresses
  - id: erlang-hardcoded-ip
    message: "Hard-coded credentials detected. Embedding secrets in source code makes them easily discoverable and impossible to rotate. Use environment variables or a secrets manager instead."
    severity: LOW
    languages: [erlang]
    pattern-either:
      - pattern: "192.168...."
      - pattern: "10...."
      - pattern: "172.16...."
      - pattern: "127.0.0.1"
      - pattern: 'localhost'
    metadata:
      category: security
      cwe: CWE-798
      confidence: low
      subcategory: authentication
      vulnerability_class: "Authentication Weakness"
      owasp: "A07:2021"

  # === OTP/GenServer Security Rules ===

  # Unprotected GenServer calls
  - id: erlang-genserver-unprotected
    message: "Missing authorization check. The application does not verify user permissions before granting access to resources. Add authorization checks to all protected endpoints."
    severity: MEDIUM
    languages: [erlang]
    pattern-either:
      - pattern: |
          handle_call($REQUEST, _From, State) ->
            % No authorization check
            {reply, ok, State}.
      - pattern: |
          handle_cast($REQUEST, State) ->
            % No validation
            {noreply, State}.
    metadata:
      category: security
      framework: otp
      cwe: CWE-862
      confidence: low
      subcategory: access-control
      vulnerability_class: "Access Control Violation"
      owasp: "A01:2021"
      references:
        - https://www.erlang.org/doc/design_principles/

  # Supervisor restart strategy issues
  - id: erlang-supervisor-restart
    message: "Uncontrolled resource consumption detected. The application does not limit resource usage, making it vulnerable to denial-of-service attacks. Implement rate limiting and resource caps."
    severity: LOW
    languages: [erlang]
    pattern-either:
      - pattern: |
          init([]) ->
            {ok, {{one_for_all, 0, 1}, []}}.
      - pattern: |
          {ok, {{rest_for_one, 1000, 1}, []}}.
    metadata:
      category: security
      framework: otp
      cwe: CWE-400
      confidence: low
      subcategory: dos
      vulnerability_class: "Denial of Service"
      references:
        - https://www.erlang.org/doc/design_principles/

  # === Cowboy/Web Framework Rules ===

  # Cowboy route without authentication
  - id: erlang-cowboy-no-auth
    message: "Missing authorization check. The application does not verify user permissions before granting access to resources. Add authorization checks to all protected endpoints."
    severity: MEDIUM
    languages: [erlang]
    pattern-either:
      - pattern: |
          init(Req, State) ->
            % Direct processing without auth
            {ok, Req, State}.
      - pattern: |
          {'_', '/admin/[...]', handler_module, []}
    metadata:
      category: security
      framework: cowboy
      cwe: CWE-862
      confidence: low
      subcategory: access-control
      vulnerability_class: "Access Control Violation"
      owasp: "A01:2021"
      references:
        - https://ninenines.eu/docs/en/cowboy/

  # Cowboy XSS vulnerability
  - id: erlang-cowboy-xss
    message: "Cross-site scripting (XSS) vulnerability detected. User input is rendered in HTML output without proper escaping, allowing attackers to inject malicious scripts. Sanitize or escape all user input before rendering."
    severity: HIGH
    languages: [erlang]
    pattern-either:
      - pattern: "cowboy_req:reply(200, #{}, $USER_INPUT, Req)"
      - pattern: |
          Body = <<"<html><body>", $USER_INPUT/binary, "</body></html>">>,
          cowboy_req:reply(200, #{}, Body, Req)
    metadata:
      category: security
      framework: cowboy
      cwe: CWE-79
      confidence: medium
      subcategory: xss
      vulnerability_class: "Cross-Site Scripting (XSS)"
      owasp: "A03:2021"
      references:
        - https://ninenines.eu/docs/en/cowboy/
      fix: "Escape all user input before inserting into HTML output. Use a templating library with auto-escaping enabled."

  # === Database Security Rules ===

  # Mnesia security issues
  - id: erlang-mnesia-security
    message: "Race condition on shared resource. Concurrent access without synchronization can corrupt data. Use proper locking or atomic operations."
    severity: MEDIUM
    languages: [erlang]
    pattern-either:
      - pattern: "mnesia:create_table($TABLE, [{access_mode, read_write}, {type, set}])"
      - pattern: "mnesia:dirty_read($TABLE, $KEY)"
      - pattern: "mnesia:dirty_write($RECORD)"
    pattern-not-inside:
      pattern: |
        ...
        mnesia:activity(transaction, ...)
        ...
    metadata:
      category: security
      framework: mnesia
      cwe: CWE-362
      confidence: low
      subcategory: design
      vulnerability_class: "Insecure Design"

  # === Additional Erlang Security Rules ===

  # Format string vulnerabilities
  - id: erlang-format-string
    message: "Format string vulnerability. User input in format strings allows memory read/write. Never pass user input as a format string argument."
    severity: HIGH
    languages: [erlang]
    pattern-either:
      - pattern: "io:format($USER_INPUT)"
      - pattern: "io:fwrite($USER_INPUT)"
      - pattern: "error_logger:info_msg($USER_INPUT)"
    metadata:
      category: security
      cwe: CWE-134
      confidence: medium
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Never use user input as the format string in io:format/2. Always use a static format string: io:format(\"~s\", [UserInput])."

  # Race conditions in file operations
  - id: erlang-race-condition
    message: "Time-of-check time-of-use (TOCTOU) race condition. A resource can change between check and use, allowing bypass. Perform check and use atomically."
    severity: MEDIUM
    languages: [erlang]
    pattern-either:
      - pattern: |
          case file:read_file_info($PATH) of
            {ok, _} ->
              file:read_file($PATH)
          end
      - pattern: |
          filelib:is_file($PATH),
          file:open($PATH, [read])
    metadata:
      category: security
      cwe: CWE-367
      confidence: low
      subcategory: design
      vulnerability_class: "Insecure Design"

  # Atom exhaustion
  - id: erlang-atom-exhaustion
    message: "Uncontrolled resource consumption detected. The application does not limit resource usage, making it vulnerable to denial-of-service attacks. Implement rate limiting and resource caps."
    severity: MEDIUM
    languages: [erlang]
    patterns:
      - pattern-either:
          - pattern: list_to_atom($USER_INPUT)
          - pattern: binary_to_atom($USER_INPUT, utf8)
      - metavariable-pattern:
          metavariable: $USER_INPUT
          pattern: $VAR
    metadata:
      category: security
      cwe: CWE-400
      confidence: low
      subcategory: dos
      vulnerability_class: "Denial of Service"

  # Process dictionary misuse
  - id: erlang-process-dictionary
    message: "Race condition on shared resource. Concurrent access without synchronization can corrupt data. Use proper locking or atomic operations."
    severity: LOW
    languages: [erlang]
    pattern-either:
      - pattern: put($KEY, $VALUE)
      - pattern: get($KEY)
      - pattern: erase($KEY)
    metadata:
      category: security
      cwe: CWE-362
      confidence: low
      subcategory: design
      vulnerability_class: "Insecure Design"

  # ETS table security
  - id: erlang-ets-security
    message: "Information exposure detected. The application reveals sensitive internal details to unauthorized users. Remove or restrict access to sensitive information in responses."
    severity: MEDIUM
    languages: [erlang]
    pattern-either:
      - pattern: "ets:new($TABLE, [public])"
      - pattern: "ets:new($TABLE, [public, named_table])"
    pattern-not-inside:
      pattern: |
        ...
        {heir, $PID, $DATA}
        ...
    metadata:
      category: security
      cwe: CWE-200
      confidence: low
      subcategory: configuration
      vulnerability_class: "Security Misconfiguration"
      owasp: "A01:2021"

  # === Cross-Language Generic Rules ===

  # Generic hardcoded localhost
  - id: generic-elixir-erlang-localhost
    message: "Hard-coded credentials detected. Embedding secrets in source code makes them easily discoverable and impossible to rotate. Use environment variables or a secrets manager instead."
    severity: LOW
    languages: [elixir, erlang]
    pattern-either:
      - pattern: "127.0.0.1"
      - pattern: "localhost"
      - pattern: "::1"
      - pattern: "0.0.0.0"
    metadata:
      category: security
      cwe: CWE-798
      confidence: low
      subcategory: authentication
      vulnerability_class: "Authentication Weakness"
      owasp: "A07:2021"

  # Generic TODO/FIXME security comments
  - id: generic-elixir-erlang-todo
    message: "TODO/FIXME comments may indicate incomplete security implementations"
    severity: LOW
    languages: [elixir, erlang]
    pattern-either:
      - pattern-regex: "(?i).*TODO.*security.*"
      - pattern-regex: "(?i).*FIXME.*security.*"
      - pattern-regex: "(?i).*HACK.*security.*"
    metadata:
      category: security
      cwe: CWE-1059
      confidence: low
      subcategory: configuration
      vulnerability_class: "Security Misconfiguration"
      owasp: "A06:2021"