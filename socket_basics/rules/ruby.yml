rules:
  # === Critical Severity Rules ===

  # Code injection via eval - using taint mode
  - id: ruby-eval-injection
    message: "Code injection via eval detected. User-controlled data flows into eval without sanitization. Avoid eval with user input."
    severity: CRITICAL
    languages: [ruby]
    mode: taint
    pattern-sources:
      # User-controlled input sources
      - pattern: params
      - pattern: request.params
      - pattern: cookies
      - pattern: request.query_string
    pattern-propagators:
      # String concatenation
      - pattern: (String $A) + (String $B)
        from: $B
        to: $A
    pattern-sinks:
      # Code evaluation methods
      - pattern: eval(...)
      - pattern: instance_eval(...)
      - pattern: class_eval(...)
      - pattern: module_eval(...)
      - pattern: binding.eval(...)
    metadata:
      category: security
      cwe: CWE-94
      confidence: high
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Remove eval(), instance_eval(), and send() with user input. Use safe parsing methods. Use a sandboxed environment if dynamic execution is required."

  # Command injection - using taint mode for accurate detection
  - id: ruby-command-injection
    message: "Command injection vulnerability detected. User-controlled data flows into system command without proper sanitization. Use safe command execution with array arguments or proper escaping."
    severity: CRITICAL
    languages: [ruby]
    mode: taint
    pattern-sources:
      # User-controlled input sources
      - pattern: params
      - pattern: request.params
      - pattern: cookies
      - pattern: request.query_string
    pattern-propagators:
      # String concatenation
      - pattern: (String $A) + (String $B)
        from: $B
        to: $A
    pattern-sinks:
      # Command execution methods
      - pattern: system(...)
      - pattern: exec(...)
      - pattern: spawn(...)
      - pattern: IO.popen(...)
      - pattern: Kernel.system(...)
    pattern-sanitizers:
      # Array-based command execution is safe
      - pattern: system([$CMD, ...])
      - pattern: spawn([$CMD, ...])
    metadata:
      category: security
      cwe: CWE-78
      confidence: high
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Use system() with separate arguments: system('cmd', arg1, arg2). Avoid backticks or %x{} with user input."

  # SQL injection - using taint mode for accurate detection
  - id: ruby-sql-injection
    message: "SQL injection vulnerability detected. User-controlled data flows into SQL query without proper sanitization. Use parameterized queries with placeholders (?, :symbol) to prevent SQL injection."
    severity: CRITICAL
    languages: [ruby]
    mode: taint
    pattern-sources:
      # User-controlled input sources
      - pattern: params
      - pattern: request.params
      - pattern: cookies
      - pattern: request.query_string
      - pattern: request.GET
      - pattern: request.POST
    pattern-propagators:
      # String concatenation
      - pattern: (String $A) + (String $B)
        from: $B
        to: $A
      # String interpolation is implicitly tracked
    pattern-sinks:
      # ActiveRecord query methods
      - pattern: $MODEL.where(...)
      - pattern: $MODEL.find_by_sql(...)
      - pattern: ActiveRecord::Base.connection.execute(...)
      - pattern: $DB.execute(...)
      - pattern: $DB.query(...)
    pattern-sanitizers:
      # Parameterized queries
      - pattern: $MODEL.where($KEY => $VAL)
      - pattern: $MODEL.where("... ?", ...)
      - pattern: $MODEL.where("... :$SYM", ...)
    metadata:
      category: security
      cwe: CWE-89
      confidence: high
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Use parameterized queries with ActiveRecord: User.where('id = ?', user_id) or use the ORM query interface."

  # Unsafe deserialization
  - id: ruby-unsafe-deserialization
    message: "Unsafe deserialization detected. Deserializing untrusted data can lead to remote code execution or denial of service. Use safe serialization formats like JSON or validate data before deserializing."
    severity: CRITICAL
    languages: [ruby]
    pattern-either:
      - pattern: Marshal.load($USER_INPUT)
      - pattern: Marshal.restore($USER_INPUT)
      - pattern: YAML.load($USER_INPUT)
      - pattern: YAML.unsafe_load($USER_INPUT)
    metadata:
      category: security
      cwe: CWE-502
      confidence: high
      subcategory: integrity
      vulnerability_class: "Insecure Deserialization"
      owasp: "A08:2021"
      fix: "Replace Marshal.load/YAML.load with JSON.parse or YAML.safe_load. Never deserialize untrusted data with Marshal."

  # Dynamic method definition - simplified
  - id: ruby-dynamic-method-definition
    message: "Code injection vulnerability detected. User-controlled input is passed to a code evaluation function, allowing arbitrary code execution. Avoid eval/exec with user input; use safe alternatives."
    severity: CRITICAL
    languages: [ruby]
    pattern-either:
      - pattern: define_method($USER_INPUT)
      - pattern: define_method($USER_INPUT, $BLOCK)
      - pattern: send($USER_INPUT)
      - pattern: send($USER_INPUT, $ARGS)
      - pattern: $OBJ.send($USER_INPUT)
      - pattern: public_send($USER_INPUT)
    metadata:
      category: security
      cwe: CWE-94
      confidence: medium
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Remove eval(), instance_eval(), and send() with user input. Use safe parsing methods. Use a sandboxed environment if dynamic execution is required."

  # === High Severity Rules ===

  # Hardcoded secrets - using regex on the variable name
  - id: ruby-hardcoded-secrets
    message: "Hard-coded credentials detected. Embedding secrets in source code makes them easily discoverable and impossible to rotate. Use environment variables or a secrets manager instead."
    severity: HIGH
    languages: [ruby]
    patterns:
      - pattern-either:
          - pattern: $VAR = $VALUE
          - pattern: $CONST = $VALUE
      - metavariable-regex:
          metavariable: $VAR
          regex: (?i).*(password|passwd|pwd|secret|token|key|api_key|private_key).*
      - metavariable-pattern:
          metavariable: $VALUE
          pattern: '"..."'
    metadata:
      category: security
      cwe: CWE-798
      confidence: medium
      subcategory: authentication
      vulnerability_class: "Authentication Weakness"
      owasp: "A07:2021"
      fix: "Store secrets in environment variables (ENV['KEY']) or use Rails credentials (config/credentials.yml.enc) or a secrets manager."

  # File path traversal - using taint mode
  - id: ruby-path-traversal
    message: "Path traversal vulnerability detected. User-controlled data flows into file operations without proper validation. Use File.expand_path or validate paths."
    severity: HIGH
    languages: [ruby]
    mode: taint
    pattern-sources:
      # User-controlled input sources
      - pattern: params
      - pattern: request.params
      - pattern: cookies
    pattern-propagators:
      # String concatenation
      - pattern: (String $A) + (String $B)
        from: $B
        to: $A
      # File.join propagates taint
      - pattern: File.join(..., (String $X), ...)
        from: $X
        to: File.join
    pattern-sinks:
      # File operations
      - pattern: File.open(...)
      - pattern: File.read(...)
      - pattern: File.write(...)
      - pattern: IO.read(...)
      - pattern: Pathname.new(...)
      - pattern: Dir.glob(...)
    pattern-sanitizers:
      # Path validation
      - pattern: File.expand_path(...)
      - pattern: File.basename(...)
    metadata:
      category: security
      cwe: CWE-22
      confidence: high
      subcategory: access-control
      vulnerability_class: "Access Control Violation"
      owasp: "A01:2021"
      fix: "Use File.expand_path() and verify the result starts with the allowed base directory. Use Pathname#cleanpath for normalization."

  # Open redirect - Rails patterns with taint mode
  - id: ruby-open-redirect
    message: "Open redirect vulnerability detected. The application redirects to a user-controlled URL without validation, enabling phishing attacks. Validate redirect targets against an allowlist."
    severity: HIGH
    languages: [ruby]
    mode: taint
    pattern-sources:
      # User-controlled input sources
      - pattern: params
      - pattern: request.params
      - pattern: request.query_string
      - pattern: cookies
    pattern-propagators:
      # String concatenation
      - pattern: (String $A) + (String $B)
        from: $B
        to: $A
    pattern-sinks:
      # Redirect methods that are dangerous with user input
      - pattern: redirect_to(...)
      - pattern: redirect_back(...)
    metadata:
      category: security
      cwe: CWE-601
      confidence: high
      subcategory: access-control
      vulnerability_class: "Access Control Violation"
      owasp: "A01:2021"
      fix: "Validate redirect URLs against an allowlist. Use relative paths for internal redirects. Use URI.parse to check the host before redirecting."

  # XSS vulnerabilities - Rails specific with taint mode
  - id: ruby-xss-raw-output
    message: "XSS vulnerability via raw HTML output. User-controlled data flows into raw HTML rendering without proper sanitization. Use sanitize() or escape HTML properly."
    severity: HIGH
    languages: [ruby]
    mode: taint
    pattern-sources:
      # User-controlled input sources
      - pattern: params
      - pattern: request.params
      - pattern: cookies
    pattern-propagators:
      # String concatenation
      - pattern: (String $A) + (String $B)
        from: $B
        to: $A
    pattern-sinks:
      # Raw HTML output methods
      - pattern: raw(...)
      - pattern: $VAR.html_safe
    pattern-sanitizers:
      # Proper HTML sanitization
      - pattern: sanitize(...)
      - pattern: h(...)
      - pattern: html_escape(...)
    metadata:
      category: security
      cwe: CWE-79
      confidence: high
      subcategory: xss
      vulnerability_class: "Cross-Site Scripting (XSS)"
      owasp: "A03:2021"
      fix: "Use ERB auto-escaping (<%= %>) or sanitize helper. Never use raw() or html_safe on user input without sanitization."

  # SSL/TLS verification bypass
  - id: ruby-ssl-verification-bypass
    message: "TLS/SSL certificate validation is disabled or bypassed. This allows man-in-the-middle attacks where attackers can intercept encrypted communications. Always validate certificates in production."
    severity: HIGH
    languages: [ruby]
    pattern-either:
      - pattern: OpenSSL::SSL::VERIFY_NONE
      - pattern: $HTTP.verify_mode = OpenSSL::SSL::VERIFY_NONE
    metadata:
      category: security
      cwe: CWE-295
      confidence: high
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A07:2021"
      fix: "Never set verify_mode = OpenSSL::SSL::VERIFY_NONE. Use the default certificate validation in Net::HTTP and OpenSSL."

  # Weak cryptographic hash
  - id: ruby-weak-crypto
    message: "Weak cryptographic algorithm detected. Using broken or outdated algorithms may allow attackers to decrypt data or forge signatures. Use modern algorithms like AES-256, SHA-256, or Ed25519."
    severity: HIGH
    languages: [ruby]
    pattern-either:
      # MD5
      - pattern: Digest::MD5.hexdigest($DATA)
      - pattern: Digest::MD5.digest($DATA)
      - pattern: Digest::MD5.new
      - pattern: OpenSSL::Digest::MD5.new
      # SHA1
      - pattern: Digest::SHA1.hexdigest($DATA)
      - pattern: Digest::SHA1.digest($DATA)
      - pattern: Digest::SHA1.new
      - pattern: OpenSSL::Digest::SHA1.new
    metadata:
      category: security
      cwe: CWE-327
      confidence: high
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"
      fix: "Use OpenSSL::Digest::SHA256 instead of MD5/SHA1. Use OpenSSL::Cipher.new('aes-256-gcm') for encryption."

  # === Medium Severity Rules ===

  # Insecure random number generation
  - id: ruby-insecure-random
    message: "Insecure random number generator used. Non-cryptographic PRNGs produce predictable values that attackers can guess. Use a cryptographically secure random generator for security-sensitive operations."
    severity: MEDIUM
    languages: [ruby]
    pattern-either:
      - pattern: rand()
      - pattern: rand($MAX)
      - pattern: Random.rand()
      - pattern: Kernel.rand()
      - pattern: srand($SEED)
    metadata:
      category: security
      cwe: CWE-338
      confidence: medium
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"

  # Weak cipher algorithms
  - id: ruby-weak-cipher
    message: "Weak cryptographic algorithm detected. Using broken or outdated algorithms may allow attackers to decrypt data or forge signatures. Use modern algorithms like AES-256, SHA-256, or Ed25519."
    severity: MEDIUM
    languages: [ruby]
    pattern-either:
      - pattern: OpenSSL::Cipher.new("DES")
      - pattern: OpenSSL::Cipher.new("RC4")
      - pattern: OpenSSL::Cipher.new("RC2")
      - pattern: OpenSSL::Cipher::DES.new
      - pattern: OpenSSL::Cipher::RC4.new
    metadata:
      category: security
      cwe: CWE-327
      confidence: high
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"

  # Mass assignment vulnerability - Rails
  - id: ruby-mass-assignment
    message: "Mass assignment vulnerability. Users can set object attributes they should not control. Use an allowlist of permitted attributes."
    severity: MEDIUM
    languages: [ruby]
    pattern-either:
      - pattern: $MODEL.new(params)
      - pattern: $MODEL.create(params)
      - pattern: $MODEL.update(params)
      - pattern: $MODEL.update_attributes(params)
      - pattern: $MODEL.assign_attributes(params)
    metadata:
      category: security
      framework: rails
      cwe: CWE-915
      confidence: low
      subcategory: access-control
      vulnerability_class: "Access Control Violation"
      owasp: "A08:2021"
      references:
        - https://guides.rubyonrails.org/security.html

  # CSRF protection bypass
  - id: ruby-csrf-bypass
    message: "Cross-site request forgery (CSRF) vulnerability. The application does not verify that requests originate from its own interface. Implement CSRF tokens on all state-changing operations."
    severity: MEDIUM
    languages: [ruby]
    pattern-either:
      - pattern: skip_before_action :verify_authenticity_token
      - pattern: skip_forgery_protection
    metadata:
      category: security
      framework: rails
      cwe: CWE-352
      confidence: medium
      subcategory: access-control
      vulnerability_class: "Access Control Violation"
      owasp: "A01:2021"
      references:
        - https://guides.rubyonrails.org/security.html

  # HTTP instead of HTTPS - catch any HTTP URL
  - id: ruby-insecure-http
    message: "Sensitive data transmitted over an unencrypted channel. Using HTTP instead of HTTPS allows network attackers to intercept data in transit. Use HTTPS for all communications containing sensitive data."
    severity: MEDIUM
    languages: [ruby]
    pattern-regex: "http://[a-zA-Z0-9.-]+[a-zA-Z0-9/._-]*"
    metadata:
      category: security
      cwe: CWE-319
      confidence: low
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"

  # === Low Severity Rules ===

  # Debug information disclosure
  - id: ruby-debug-info-disclosure
    message: "Sensitive information written to log files. Passwords, tokens, or personal data in logs can be exposed to unauthorized parties. Redact sensitive values before logging."
    severity: LOW
    languages: [ruby]
    patterns:
      - pattern-either:
          - pattern: puts $USER_INPUT
          - pattern: p $USER_INPUT
          - pattern: pp $USER_INPUT
          - pattern: print $USER_INPUT
          - pattern: Rails.logger.debug $USER_INPUT
      - metavariable-regex:
          metavariable: $USER_INPUT
          regex: (?i).*(password|token|secret|key|credential).*
    metadata:
      category: security
      cwe: CWE-532
      confidence: low
      subcategory: logging
      vulnerability_class: "Sensitive Data Exposure"
      owasp: "A09:2021"

  # Hardcoded IP addresses
  - id: ruby-hardcoded-ip
    message: "Hard-coded credentials detected. Embedding secrets in source code makes them easily discoverable and impossible to rotate. Use environment variables or a secrets manager instead."
    severity: LOW
    languages: [ruby]
    pattern-regex: "(192\\.168\\.|10\\.|172\\.16\\.|127\\.0\\.0\\.1)"
    metadata:
      category: security
      cwe: CWE-798
      confidence: low
      subcategory: authentication
      vulnerability_class: "Authentication Weakness"
      owasp: "A07:2021"

  # Empty rescue blocks
  - id: ruby-empty-rescue
    message: "Improper error handling detected. The application does not properly handle exceptions, which may cause crashes or information leaks. Catch specific exceptions and handle them gracefully."
    severity: LOW
    languages: [ruby]
    pattern: |
      begin
        $...BODY
      rescue
      end
    metadata:
      category: security
      cwe: CWE-703
      confidence: high
      subcategory: error-handling
      vulnerability_class: "Improper Error Handling"

  # === Framework-specific Rules (Rails) ===

  # Rails find_by_sql injection - catch any variable usage
  - id: ruby-rails-find-by-sql-injection
    message: "SQL injection vulnerability detected. User-supplied input is included in a SQL query without sanitization, potentially allowing attackers to read, modify, or delete database contents. Use parameterized queries or an ORM instead of string concatenation."
    severity: CRITICAL
    languages: [ruby]
    pattern-either:
      - pattern: $MODEL.find_by_sql($QUERY + $VAR)
      - pattern: $MODEL.find_by_sql($QUERY % $VAR)
      - pattern: $MODEL.find_by_sql("...#{$VAR}...")
    metadata:
      category: security
      framework: rails
      cwe: CWE-89
      confidence: medium
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      references:
        - https://guides.rubyonrails.org/security.html
      fix: "Use parameterized queries with ActiveRecord: User.where('id = ?', user_id) or use the ORM query interface."

  # Rails where clause injection
  - id: ruby-rails-where-injection
    message: "SQL injection vulnerability detected. User-supplied input is included in a SQL query without sanitization, potentially allowing attackers to read, modify, or delete database contents. Use parameterized queries or an ORM instead of string concatenation."
    severity: CRITICAL
    languages: [ruby]
    pattern-either:
      - pattern: $MODEL.where($QUERY + $VAR)
      - pattern: $MODEL.where($QUERY % $VAR)
      - pattern: $MODEL.where("...#{$VAR}...")
    metadata:
      category: security
      framework: rails
      cwe: CWE-89
      confidence: medium
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      references:
        - https://guides.rubyonrails.org/security.html
      fix: "Use parameterized queries with ActiveRecord: User.where('id = ?', user_id) or use the ORM query interface."

  # Template injection - generic
  - id: ruby-template-injection
    message: "Code injection vulnerability detected. User-controlled input is passed to a code evaluation function, allowing arbitrary code execution. Avoid eval/exec with user input; use safe alternatives."
    severity: HIGH
    languages: [ruby]
    pattern-either:
      - pattern: ERB.new($USER_INPUT).result
      - pattern: Liquid::Template.parse($USER_INPUT)
      - pattern: Mustache.render($USER_INPUT, $DATA)
    metadata:
      category: security
      cwe: CWE-94
      confidence: medium
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Remove eval(), instance_eval(), and send() with user input. Use safe parsing methods. Use a sandboxed environment if dynamic execution is required."

  # File upload without validation - Rails pattern
  - id: ruby-file-upload-no-validation
    message: "Unrestricted file upload detected. Accepting uploads without validating file type and content can allow execution of malicious code. Validate file type, size, and content before storing."
    severity: MEDIUM
    languages: [ruby]
    pattern-either:
      - pattern: |
          def upload
            $...BODY
            File.open($PATH, $MODE) { |f| f.write(file.read) }
            $...BODY
          end
      - pattern: params[$PARAM].read
    metadata:
      category: security
      cwe: CWE-434
      confidence: low
      subcategory: upload
      vulnerability_class: "Unrestricted File Upload"
      owasp: "A04:2021"

  # Dangerous file permissions
  - id: ruby-dangerous-file-permissions
    message: "Overly permissive file or resource permissions. Resources are accessible to unauthorized users due to incorrect permission settings. Apply the principle of least privilege."
    severity: MEDIUM
    languages: [ruby]
    pattern-either:
      - pattern: File.chmod(0777, $FILE)
      - pattern: File.chmod(0666, $FILE)
      - pattern: FileUtils.chmod(0777, $FILE)
      - pattern: FileUtils.chmod(0666, $FILE)
    metadata:
      category: security
      cwe: CWE-732
      confidence: high
      subcategory: configuration
      vulnerability_class: "Security Misconfiguration"
      owasp: "A05:2021"