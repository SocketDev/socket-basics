rules:
  # =====================================================================
  # OWASP Top 10 2021 Coverage for Python
  # =====================================================================

  # ===================================================================== 
  # A01:2021 - Broken Access Control
  # =====================================================================

  # Path traversal vulnerabilities
  - id: python-path-traversal-open
    message: "Path traversal vulnerability detected. User-controlled data flows into file operations without proper validation. Use os.path.abspath() and validate the result is within allowed directory."
    severity: HIGH
    languages: [python]
    mode: taint
    pattern-sources:
      # Flask request sources
      - pattern: request.args
      - pattern: request.form
      - pattern: request.values
      - pattern: request.json
      - pattern: request.data
      - pattern: request.cookies
      - pattern: request.files
      # Django request sources
      - pattern: request.GET
      - pattern: request.POST
      - pattern: request.COOKIES
      - pattern: request.FILES
      # FastAPI request sources
      - pattern: request.query_params
      - pattern: request.path_params
      # Generic input sources
      - pattern: input(...)
    pattern-propagators:
      # String concatenation
      - pattern: $A + $B
        from: $B
        to: $A
      # Path operations that propagate taint (if any arg is tainted, result is tainted)
      - pattern: os.path.join(..., $X, ...)
        from: $X
        to: os.path.join
      - pattern: pathlib.Path($X)
        from: $X
        to: pathlib.Path
    pattern-sinks:
      # File operations
      - pattern: open(...)
      - pattern: io.open(...)
      - pattern: pathlib.Path(...).open(...)
      - pattern: pathlib.Path(...).read_text(...)
      - pattern: pathlib.Path(...).read_bytes(...)
      - pattern: pathlib.Path(...).write_text(...)
      - pattern: pathlib.Path(...).write_bytes(...)
      # os module file operations
      - pattern: os.remove(...)
      - pattern: os.unlink(...)
      - pattern: os.rmdir(...)
      - pattern: os.rename(...)
      - pattern: os.replace(...)
      # shutil operations
      - pattern: shutil.copy(...)
      - pattern: shutil.copy2(...)
      - pattern: shutil.copytree(...)
      - pattern: shutil.move(...)
      - pattern: shutil.rmtree(...)
    pattern-sanitizers:
      # Path validation functions
      - pattern: os.path.abspath(...)
      - pattern: os.path.realpath(...)
      - pattern: pathlib.Path(...).resolve()
    metadata:
      category: security
      owasp: "A01:2021"
      cwe: CWE-22
      confidence: high
      subcategory: access-control
      vulnerability_class: "Access Control Violation"
      fix: "Use os.path.abspath() and verify the result starts with your allowed base directory. Use pathlib.Path.resolve() for canonicalization."

  # Open redirect
  - id: python-open-redirect
    message: "Open redirect vulnerability detected. User-controlled data flows into redirect without validation. Validate URLs against an allowlist of trusted domains."
    severity: MEDIUM
    languages: [python]
    mode: taint
    pattern-sources:
      # Flask request sources
      - pattern: request.args
      - pattern: request.form
      - pattern: request.values
      - pattern: request.json
      - pattern: request.data
      - pattern: request.cookies
      # Django request sources
      - pattern: request.GET
      - pattern: request.POST
      - pattern: request.COOKIES
      # FastAPI request sources
      - pattern: request.query_params
      - pattern: request.path_params
      # Generic input sources
      - pattern: input(...)
    pattern-propagators:
      # String concatenation
      - pattern: $A + $B
        from: $B
        to: $A
    pattern-sinks:
      # Flask redirects
      - pattern: flask.redirect(...)
      - pattern: redirect(...)
      # Django redirects
      - pattern: django.shortcuts.redirect(...)
      - pattern: django.http.HttpResponseRedirect(...)
      - pattern: HttpResponseRedirect(...)
      # FastAPI redirects
      - pattern: fastapi.responses.RedirectResponse(...)
      - pattern: RedirectResponse(...)
    pattern-sanitizers:
      # URL validation functions (if any are used)
      - pattern: urllib.parse.urlparse(...)
    metadata:
      category: security
      owasp: "A01:2021"
      cwe: CWE-601
      confidence: high
      subcategory: access-control
      vulnerability_class: "Access Control Violation"

  # Insecure direct object reference
  - id: python-idor-vulnerability
    message: "Potential IDOR vulnerability - verify user authorization before accessing resource"
    severity: HIGH
    languages: [python]
    patterns:
      - pattern-either:
          - pattern: $MODEL.objects.get(id=$REQ.$W.get(...))
          - pattern: $MODEL.objects.get(pk=$REQ.$W[...])
          - pattern: $SESSION.query($MODEL).get($REQ.$W.get(...))
          - pattern: $DB.get($MODEL, $REQ.$W.get(...))
      - pattern-not-inside: |
          ...
          if $USER.id == ...:
            ...
      - pattern-not-inside: |
          ...
          if $OBJ.user_id == $USER.id:
            ...
    metadata:
      category: security
      owasp: "A01:2021"
      cwe: CWE-639
      confidence: medium
      subcategory: access-control
      vulnerability_class: "Access Control Violation"
      fix: "Verify user authorization before accessing resources. Use the authenticated user's ID from the session, not from request parameters."

  # Missing authorization check
  - id: python-missing-auth-check
    message: "Missing authorization check. The application does not verify user permissions before granting access to resources. Add authorization checks to all protected endpoints."
    severity: HIGH
    languages: [python]
    patterns:
      - pattern-inside: |
          @$APP.route(...)
          def $FUNC($REQ, ...):
            ...
      - pattern-not-inside: |
          @$APP.route(...)
          @login_required
          def $FUNC($REQ, ...):
            ...
      - pattern-not-inside: |
          @$APP.route(...)
          @permission_required(...)
          def $FUNC($REQ, ...):
            ...
      - pattern-not-inside: |
          ...
          if not $REQ.user.is_authenticated:
            ...
      - metavariable-regex:
          metavariable: $FUNC
          regex: (create|update|delete|remove|edit|modify)_(user|account|profile|password|permission|role|admin|resource|data|record)
    metadata:
      category: security
      owasp: "A01:2021"
      cwe: CWE-862
      confidence: low
      subcategory: access-control
      vulnerability_class: "Access Control Violation"
      fix: "Add authorization decorators or middleware to protected endpoints. Use @login_required (Django) or @jwt_required (Flask-JWT) on all protected routes."

  # ===================================================================== 
  # A02:2021 - Cryptographic Failures
  # =====================================================================

  # Weak cryptographic hash algorithms
  - id: python-weak-hash-md5
    message: "Weak cryptographic algorithm detected. Using broken or outdated algorithms may allow attackers to decrypt data or forge signatures. Use modern algorithms like AES-256, SHA-256, or Ed25519."
    severity: HIGH
    languages: [python]
    pattern-either:
      - pattern: hashlib.md5(...)
      - pattern: Crypto.Hash.MD5.new(...)
      - pattern: cryptography.hazmat.primitives.hashes.MD5()
    metadata:
      category: security
      owasp: "A02:2021"
      cwe: CWE-327
      confidence: high
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      fix: "Use hashlib.sha256() or hashlib.sha3_256() instead of md5/sha1. Use cryptography library with AES-GCM or ChaCha20-Poly1305 for encryption."

  - id: python-weak-hash-sha1
    message: "SHA1 is cryptographically weak and should not be used for security"
    severity: HIGH
    languages: [python]
    pattern-either:
      - pattern: hashlib.sha1(...)
      - pattern: Crypto.Hash.SHA1.new(...)
      - pattern: cryptography.hazmat.primitives.hashes.SHA1()
    metadata:
      category: security
      owasp: "A02:2021"
      cwe: CWE-327
      confidence: high
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      fix: "Use hashlib.sha256() or hashlib.sha3_256() instead of md5/sha1. Use cryptography library with AES-GCM or ChaCha20-Poly1305 for encryption."

  # Insecure random number generation
  - id: python-insecure-random
    message: "random module used for security-sensitive operation - use secrets module instead"
    severity: HIGH
    languages: [python]
    patterns:
      - pattern-either:
          - pattern: random.random()
          - pattern: random.randint(...)
          - pattern: random.choice(...)
          - pattern: random.randrange(...)
      - pattern-inside: |
          ...
          $TOKEN = ...
          ...
      - metavariable-regex:
          metavariable: $TOKEN
          regex: (?i).*(token|secret|key|password|salt|nonce|session|auth|crypto).*
    metadata:
      category: security
      owasp: "A02:2021"
      cwe: CWE-338
      confidence: medium
      subcategory: crypto
      fix: "Use secrets.token_bytes(), secrets.token_hex(), or secrets.choice() for security-sensitive operations"
      vulnerability_class: "Cryptographic Weakness"

  # Hardcoded secrets
  - id: python-hardcoded-secret
    message: "Hardcoded secret or credential detected - use environment variables"
    severity: HIGH
    languages: [python]
    patterns:
      - pattern-either:
          - pattern: $VAR = "..."
          - pattern: $VAR = '...'
      - metavariable-regex:
          metavariable: $VAR
          regex: (?i).*(password|passwd|pwd|secret|api[_-]?key|private[_-]?key|access[_-]?token|auth[_-]?token|session[_-]?key|db[_-]?password).*
    metadata:
      category: security
      owasp: "A02:2021"
      cwe: CWE-798
      confidence: medium
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      fix: "Store secrets in environment variables (os.environ['KEY']) or use a secrets manager (AWS Secrets Manager, HashiCorp Vault, python-dotenv)."

  # Weak cipher algorithms
  - id: python-weak-cipher-des
    message: "Weak cipher algorithm DES detected - use AES-256-GCM instead"
    severity: HIGH
    languages: [python]
    pattern-either:
      - pattern: Crypto.Cipher.DES.new(...)
      - pattern: Crypto.Cipher.DES3.new(...)
      - pattern: Crypto.Cipher.ARC2.new(...)
      - pattern: Crypto.Cipher.ARC4.new(...)
      - pattern: Crypto.Cipher.Blowfish.new(...)
    metadata:
      category: security
      owasp: "A02:2021"
      cwe: CWE-327
      confidence: high
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      fix: "Use hashlib.sha256() or hashlib.sha3_256() instead of md5/sha1. Use cryptography library with AES-GCM or ChaCha20-Poly1305 for encryption."

  # SSL/TLS verification disabled
  - id: python-ssl-verify-disabled
    message: "SSL certificate validation disabled - vulnerable to MITM attacks"
    severity: CRITICAL
    languages: [python]
    pattern-either:
      - pattern: requests.get(..., verify=False, ...)
      - pattern: requests.post(..., verify=False, ...)
      - pattern: requests.request(..., verify=False, ...)
      - pattern: urllib.request.urlopen(..., context=ssl._create_unverified_context(), ...)
      - pattern: httpx.get(..., verify=False, ...)
      - pattern: aiohttp.ClientSession(..., connector=aiohttp.TCPConnector(ssl=False), ...)
    metadata:
      category: security
      owasp: "A02:2021"
      cwe: CWE-295
      confidence: high
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      fix: "Always use verify=True (the default) in requests. Set ssl_context properly. Never set CERT_NONE or disable hostname checking."

  # Insecure TLS versions
  - id: python-insecure-tls-version
    message: "Weak cryptographic algorithm detected. Using broken or outdated algorithms may allow attackers to decrypt data or forge signatures. Use modern algorithms like AES-256, SHA-256, or Ed25519."
    severity: HIGH
    languages: [python]
    pattern-either:
      - pattern: ssl.PROTOCOL_SSLv2
      - pattern: ssl.PROTOCOL_SSLv3
      - pattern: ssl.PROTOCOL_TLSv1
      - pattern: ssl.PROTOCOL_TLSv1_1
      - pattern: ssl.SSLContext(ssl.PROTOCOL_SSLv3)
      - pattern: ssl.SSLContext(ssl.PROTOCOL_TLSv1)
    metadata:
      category: security
      owasp: "A02:2021"
      cwe: CWE-327
      confidence: high
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      fix: "Use hashlib.sha256() or hashlib.sha3_256() instead of md5/sha1. Use cryptography library with AES-GCM or ChaCha20-Poly1305 for encryption."

  # ===================================================================== 
  # A03:2021 - Injection
  # =====================================================================

  # Code injection via eval
  - id: python-code-injection-eval
    message: "Code injection vulnerability detected. User-controlled data flows into eval()/exec() which can execute arbitrary code. Avoid eval/exec entirely or use ast.literal_eval() for safe evaluation."
    severity: CRITICAL
    languages: [python]
    mode: taint
    pattern-sources:
      # Flask request sources
      - pattern: request.args
      - pattern: request.form
      - pattern: request.values
      - pattern: request.json
      - pattern: request.data
      - pattern: request.cookies
      # Django request sources
      - pattern: request.GET
      - pattern: request.POST
      - pattern: request.COOKIES
      # FastAPI request sources
      - pattern: request.query_params
      - pattern: request.path_params
      # Generic input sources
      - pattern: input(...)
    pattern-propagators:
      # String concatenation
      - pattern: $A + $B
        from: $B
        to: $A
    pattern-sinks:
      # Code execution sinks
      - pattern: eval(...)
      - pattern: exec(...)
      - pattern: compile(...)
      - pattern: __import__(...)
    pattern-sanitizers:
      # Safe alternatives
      - pattern: ast.literal_eval(...)
      - pattern: json.loads(...)
    metadata:
      category: security
      owasp: "A03:2021"
      cwe: CWE-94
      confidence: high
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      fix: "Remove eval()/exec() calls with user input. Use ast.literal_eval() for safe parsing of Python literals. Use a sandboxed environment if dynamic execution is required."

  # SQL injection
  - id: python-sql-injection
    message: "SQL injection vulnerability detected. User-controlled data flows into SQL query without proper sanitization. Use parameterized queries with placeholders (?, %s) to prevent SQL injection."
    severity: CRITICAL
    languages: [python]
    mode: taint
    pattern-sources:
      # Flask request sources
      - pattern: request.args
      - pattern: request.form
      - pattern: request.values
      - pattern: request.json
      - pattern: request.data
      - pattern: request.cookies
      # Django request sources
      - pattern: request.GET
      - pattern: request.POST
      - pattern: request.COOKIES
      # FastAPI request sources
      - pattern: request.query_params
      - pattern: request.path_params
      # Generic input sources
      - pattern: input(...)
    pattern-propagators:
      # String concatenation and formatting
      - pattern: $A + $B
        from: $B
        to: $A
      # Template strings and formatting propagate taint implicitly
    pattern-sinks:
      # Database cursor/connection execute methods
      - pattern: $CURSOR.execute(...)
      - pattern: $CURSOR.executemany(...)
      - pattern: $CONN.execute(...)
      - pattern: $DB.execute(...)
      # Django ORM raw queries
      - pattern: $MODEL.objects.raw(...)
      - pattern: RawSQL(...)
      # SQLAlchemy text queries
      - pattern: sqlalchemy.text(...)
      - pattern: text(...)
      # Psycopg2/psycopg3
      - pattern: $CURSOR.mogrify(...)
      # MySQL connector
      - pattern: mysql.connector.cursor.execute(...)
    pattern-sanitizers:
      # Parameterized queries with proper placeholders
      - pattern: $CURSOR.execute("...", (...))
      - pattern: $CURSOR.execute("...", [...])
      - pattern: $CONN.execute("...", (...))
      - pattern: $CONN.execute("...", [...])
      # ORM methods that use parameterization
      - pattern: $MODEL.objects.filter(...)
      - pattern: $MODEL.objects.get(...)
      - pattern: $QUERY.filter(...)
    metadata:
      category: security
      owasp: "A03:2021"
      cwe: CWE-89
      confidence: high
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      fix: "Use parameterized queries: cursor.execute('SELECT * FROM t WHERE id = %s', (user_id,)). For Django, use the ORM or QuerySet API. For SQLAlchemy, use bound parameters."

  # NoSQL injection (MongoDB)
  - id: python-nosql-injection
    message: "NoSQL injection vulnerability - validate and sanitize user input"
    severity: HIGH
    languages: [python]
    pattern-either:
      # Direct request data in MongoDB queries
      - pattern: $COLLECTION.find($REQ.GET)
      - pattern: $COLLECTION.find($REQ.POST)
      - pattern: $COLLECTION.find_one($REQ.GET.get(...))
      - pattern: $COLLECTION.update($REQ.POST, ...)
      - pattern: $COLLECTION.delete_one($REQ.GET)
      # Pymongo with user input
      - pattern: "$DB[$COLLECTION].find({ ..., $KEY: $REQ.$W.get(...), ... })"
    metadata:
      category: security
      owasp: "A03:2021"
      cwe: CWE-943
      confidence: high
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      fix: "Use parameterized queries with PyMongo. Validate input types (reject dicts/lists where strings expected). Never pass raw request data to MongoDB queries."

  # Command injection
  - id: python-command-injection
    message: "Command injection vulnerability detected. User-controlled data flows into system command execution without proper sanitization. Avoid shell=True and use list arguments instead of string concatenation."
    severity: CRITICAL
    languages: [python]
    mode: taint
    pattern-sources:
      # Flask request sources
      - pattern: request.args
      - pattern: request.form
      - pattern: request.values
      - pattern: request.json
      - pattern: request.data
      - pattern: request.cookies
      # Django request sources
      - pattern: request.GET
      - pattern: request.POST
      - pattern: request.COOKIES
      # FastAPI request sources
      - pattern: request.query_params
      - pattern: request.path_params
      # Generic input sources
      - pattern: input(...)
    pattern-propagators:
      # String concatenation
      - pattern: $A + $B
        from: $B
        to: $A
      # Template strings propagate taint implicitly
    pattern-sinks:
      # Dangerous command execution methods
      - pattern: os.system(...)
      - pattern: os.popen(...)
      - pattern: os.popen2(...)
      - pattern: os.popen3(...)
      - pattern: os.popen4(...)
      - pattern: subprocess.call(..., shell=True, ...)
      - pattern: subprocess.run(..., shell=True, ...)
      - pattern: subprocess.Popen(..., shell=True, ...)
      - pattern: subprocess.check_output(..., shell=True, ...)
      - pattern: subprocess.check_call(..., shell=True, ...)
      - pattern: commands.getoutput(...)
      - pattern: commands.getstatusoutput(...)
      - pattern: eval(...)
      - pattern: exec(...)
    pattern-sanitizers:
      # Safe subprocess usage with list arguments (not shell=True)
      - pattern: subprocess.run([...], ...)
      - pattern: subprocess.call([...], ...)
      - pattern: subprocess.Popen([...], ...)
    metadata:
      category: security
      owasp: "A03:2021"
      cwe: CWE-78
      confidence: high
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      fix: "Use subprocess.run() with a list of arguments instead of shell=True: subprocess.run(['cmd', arg1, arg2]). Never pass user input to os.system() or shell commands."

  # LDAP injection
  - id: python-ldap-injection
    message: "LDAP injection vulnerability - sanitize user input in LDAP queries"
    severity: HIGH
    languages: [python]
    pattern-either:
      - pattern: ldap.search_s($BASE, $SCOPE, $FILTER + $USER_INPUT)
      - pattern: ldap.search_s($BASE, $SCOPE, f"...{$USER_INPUT}...")
      - pattern: ldap.search($BASE, $SCOPE, $FILTER + $USER_INPUT)
    metadata:
      category: security
      owasp: "A03:2021"
      cwe: CWE-90
      confidence: high
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      fix: "Use ldap3 library with safe filter escaping: ldap3.utils.conv.escape_filter_chars(user_input). Never concatenate user input into LDAP filters."

  # XSS via template rendering
  - id: python-xss-template
    message: "XSS vulnerability detected. User-controlled data flows into template rendering without proper escaping. Use template auto-escaping or explicit escaping functions."
    severity: HIGH
    languages: [python]
    mode: taint
    pattern-sources:
      # Flask request sources
      - pattern: request.args
      - pattern: request.form
      - pattern: request.values
      - pattern: request.json
      - pattern: request.data
      - pattern: request.cookies
      # Django request sources
      - pattern: request.GET
      - pattern: request.POST
      - pattern: request.COOKIES
      # FastAPI request sources
      - pattern: request.query_params
      - pattern: request.path_params
      # Generic input sources
      - pattern: input(...)
    pattern-propagators:
      # String concatenation
      - pattern: $A + $B
        from: $B
        to: $A
    pattern-sinks:
      # Flask template sinks
      - pattern: flask.render_template_string(...)
      - pattern: render_template_string(...)
      # Jinja2 template sinks
      - pattern: jinja2.Template(...).render(...)
      - pattern: Template(...).render(...)
      # Django mark_safe (disables escaping)
      - pattern: django.utils.safestring.mark_safe(...)
      - pattern: django.utils.html.mark_safe(...)
      - pattern: mark_safe(...)
      # Direct HTTP response with HTML
      - pattern: HttpResponse(...)
      - pattern: flask.Response(...)
    pattern-sanitizers:
      # Escaping functions
      - pattern: flask.escape(...)
      - pattern: django.utils.html.escape(...)
      - pattern: html.escape(...)
      - pattern: markupsafe.escape(...)
      # Template rendering with auto-escape (safe)
      - pattern: render_template(...)
    metadata:
      category: security
      owasp: "A03:2021"
      cwe: CWE-79
      confidence: high
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      fix: "Use template engine auto-escaping (Jinja2 autoescape=True, Django default). Use markupsafe.escape() for manual escaping. Never render raw user input with |safe or Markup()."

  # XXE (XML External Entity)
  - id: python-xxe-vulnerability
    message: "XXE vulnerability - disable external entity processing in XML parser"
    severity: HIGH
    languages: [python]
    patterns:
      - pattern-either:
          - pattern: xml.etree.ElementTree.parse($FILE)
          - pattern: xml.etree.ElementTree.fromstring($XML)
          - pattern: lxml.etree.parse($FILE)
          - pattern: lxml.etree.fromstring($XML)
      - pattern-not-inside: |
          ...
          defusedxml.ElementTree.parse(...)
          ...
    metadata:
      category: security
      owasp: "A03:2021"
      cwe: CWE-611
      confidence: medium
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      fix: "Use defusedxml instead of xml.etree or lxml. Set resolve_entities=False and no_network=True in lxml parsers."

  # Server-side template injection
  - id: python-template-injection
    message: "Template injection vulnerability - sanitize user input in templates"
    severity: CRITICAL
    languages: [python]
    pattern-either:
      # Jinja2 from string with user input
      - pattern: jinja2.Environment().from_string($REQ.$W.get(...))
      - pattern: jinja2.Template($REQ.$W.get(...))
      # Flask template string with user input
      - pattern: flask.render_template_string($REQ.args.get(...))
      - pattern: flask.render_template_string($REQ.form.get(...))
      # Mako template with user input
      - pattern: mako.template.Template($REQ.$W.get(...))
    metadata:
      category: security
      owasp: "A03:2021"
      cwe: CWE-1336
      confidence: high
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      fix: "Never pass user input to Jinja2 Template() or Mako Template(). Use render_template() with variables. Enable sandboxed environment for dynamic templates."

  # YAML deserialization
  - id: python-yaml-load-unsafe
    message: "Unsafe deserialization detected. Deserializing untrusted data can lead to remote code execution or denial of service. Use safe serialization formats like JSON or validate data before deserializing."
    severity: CRITICAL
    languages: [python]
    pattern-either:
      - pattern: yaml.load($DATA, ...)
      - pattern: yaml.load_all($DATA, ...)
    metadata:
      category: security
      owasp: "A03:2021"
      cwe: CWE-502
      confidence: high
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      fix: "Replace pickle/shelve with json.loads() for data interchange. If pickle is required, use hmac to verify data integrity before deserializing."

  # ===================================================================== 
  # A04:2021 - Insecure Design
  # =====================================================================

  # Missing rate limiting
  - id: python-missing-rate-limit
    message: "Authentication route missing rate limiting - vulnerable to brute force attacks"
    severity: MEDIUM
    languages: [python]
    patterns:
      - pattern-inside: |
          @$APP.route(..., methods=[..., "POST", ...])
          def $FUNC(...):
            ...
      - pattern-not-inside: |
          @limiter.limit(...)
          def $FUNC(...):
            ...
      - pattern-not-inside: |
          @$APP.route(...)
          @ratelimit(...)
          def $FUNC(...):
            ...
      - metavariable-regex:
          metavariable: $FUNC
          regex: (login|signin|authenticate).*
    metadata:
      category: security
      owasp: "A04:2021"
      cwe: CWE-307
      confidence: low
      subcategory: design
      vulnerability_class: "Insecure Design"

  # Insufficient input validation
  - id: python-missing-input-validation
    message: "Missing input validation. User input is not sufficiently validated, enabling injection or logic bypass attacks. Validate all inputs against expected format, type, and range."
    severity: MEDIUM
    languages: [python]
    patterns:
      - pattern-either:
          - pattern: int($REQ.$W.get(...))
          - pattern: float($REQ.$W.get(...))
          - pattern: eval($REQ.$W.get(...))
      - pattern-not-inside: |
          ...
          if isinstance(..., ...):
            ...
      - pattern-not-inside: |
          ...
          try:
            ...
          except ValueError:
            ...
    metadata:
      category: security
      owasp: "A04:2021"
      cwe: CWE-20
      confidence: low
      subcategory: design
      vulnerability_class: "Insecure Design"

  # ===================================================================== 
  # A05:2021 - Security Misconfiguration
  # =====================================================================

  # Debug mode enabled
  - id: python-debug-mode-enabled
    message: "Debug mode enabled - exposes sensitive information in production"
    severity: HIGH
    languages: [python]
    pattern-either:
      # Flask debug
      - pattern: $APP.run(..., debug=True, ...)
      - pattern: $APP.debug = True
      # Django settings
      - pattern: DEBUG = True
      # FastAPI
      - pattern: fastapi.FastAPI(..., debug=True, ...)
    metadata:
      category: security
      owasp: "A05:2021"
      cwe: CWE-489
      confidence: high
      subcategory: configuration
      vulnerability_class: "Security Misconfiguration"
      fix: "Set DEBUG=False in production. Use environment variables to control debug mode: DEBUG = os.environ.get('DEBUG', 'False').lower() == 'true'."

  # Weak session configuration
  - id: python-weak-session-config
    message: "Sensitive cookie missing the Secure flag. The cookie may be transmitted over unencrypted HTTP, allowing interception. Set the Secure flag on all sensitive cookies."
    severity: HIGH
    languages: [python]
    pattern-either:
      # Flask session without secure flag
      - pattern: $APP.config["SESSION_COOKIE_SECURE"] = False
      - pattern: $APP.config["SESSION_COOKIE_HTTPONLY"] = False
      - pattern: $APP.config["SESSION_COOKIE_SAMESITE"] = None
      # Django session settings
      - pattern: SESSION_COOKIE_SECURE = False
      - pattern: SESSION_COOKIE_HTTPONLY = False
      - pattern: CSRF_COOKIE_SECURE = False
    metadata:
      category: security
      owasp: "A05:2021"
      cwe: CWE-614
      confidence: high
      subcategory: configuration
      vulnerability_class: "Security Misconfiguration"
      fix: "Set cookie flags: response.set_cookie(key, value, secure=True, httponly=True, samesite='Lax'). Use SESSION_COOKIE_SECURE=True in Django."

  # Exposed error messages
  - id: python-error-exposure
    message: "Error details exposed to client - can leak sensitive information"
    severity: MEDIUM
    languages: [python]
    pattern-either:
      - pattern: |
          try:
            ...
          except $EXC as $E:
            ...
            return ..., str($E), ...
      - pattern: |
          try:
            ...
          except $EXC as $E:
            ...
            flask.jsonify(..., error=str($E), ...)
      - pattern: |
          try:
            ...
          except $EXC as $E:
            ...
            print($E)
    metadata:
      category: security
      owasp: "A05:2021"
      cwe: CWE-209
      confidence: medium
      subcategory: configuration
      vulnerability_class: "Security Misconfiguration"

  # Insecure file permissions
  - id: python-insecure-file-permissions
    message: "Overly permissive file or resource permissions. Resources are accessible to unauthorized users due to incorrect permission settings. Apply the principle of least privilege."
    severity: HIGH
    languages: [python]
    pattern-either:
      - pattern: os.chmod($PATH, 0o777)
      - pattern: os.chmod($PATH, 0o666)
      - pattern: os.chmod($PATH, 511)
      - pattern: os.chmod($PATH, 438)
      - pattern: os.open($PATH, $FLAGS, 0o777)
    metadata:
      category: security
      owasp: "A05:2021"
      cwe: CWE-732
      confidence: high
      subcategory: configuration
      vulnerability_class: "Security Misconfiguration"
      fix: "Set restrictive permissions with os.chmod(path, 0o600) for sensitive files. Use os.umask(0o077) to restrict default permissions."

  # Binding to all interfaces
  - id: python-bind-all-interfaces
    message: "Binding to all interfaces (0.0.0.0) - consider using localhost"
    severity: LOW
    languages: [python]
    pattern-either:
      - pattern: $APP.run(..., host="0.0.0.0", ...)
      - pattern: $SOCK.bind(("0.0.0.0", $PORT))
      - pattern: $SERVER.serve_forever(host="0.0.0.0")
    metadata:
      category: security
      owasp: "A05:2021"
      cwe: CWE-200
      confidence: medium
      subcategory: configuration
      vulnerability_class: "Security Misconfiguration"

  # ===================================================================== 
  # A06:2021 - Vulnerable and Outdated Components
  # =====================================================================

  # Deprecated functions
  - id: python-deprecated-functions
    message: "Use of obsolete or deprecated function. The function may have known security weaknesses. Replace with the recommended modern alternative."
    severity: LOW
    languages: [python]
    pattern-either:
      - pattern: os.tempnam()
      - pattern: os.tmpnam()
      - pattern: platform.popen(...)
      - pattern: imp.load_source(...)
    metadata:
      category: security
      owasp: "A06:2021"
      cwe: CWE-477
      confidence: high
      subcategory: deprecated
      vulnerability_class: "Memory Safety Violation"

  # ===================================================================== 
  # A07:2021 - Identification and Authentication Failures
  # =====================================================================

  # Weak password validation
  - id: python-weak-password-validation
    message: "Weak password requirements. The application does not enforce strong password policies. Require minimum length, complexity, and check against breached password lists."
    severity: MEDIUM
    languages: [python]
    patterns:
      - pattern: |
          if len($PASSWORD) < $N:
            ...
      - metavariable-comparison:
          metavariable: $N
          comparison: $N < 8
    metadata:
      category: security
      owasp: "A07:2021"
      cwe: CWE-521
      confidence: low
      subcategory: authentication
      vulnerability_class: "Authentication Weakness"

  # JWT without verification
  - id: python-jwt-no-verify
    message: "JWT decoded without signature verification - use jwt.decode() with verify=True"
    severity: HIGH
    languages: [python]
    pattern-either:
      - pattern: 'jwt.decode($TOKEN, options={"verify_signature": False})'
      - pattern: jwt.decode($TOKEN, verify=False)
      - pattern: 'jwt.decode($TOKEN, ..., options={..., "verify_signature": False, ...})'
    metadata:
      category: security
      owasp: "A07:2021"
      cwe: CWE-347
      confidence: high
      subcategory: authentication
      vulnerability_class: "Authentication Weakness"
      fix: "Always verify JWT signatures: jwt.decode(token, key, algorithms=['HS256']). Never use options={'verify_signature': False}."

  # Weak JWT algorithm
  - id: python-weak-jwt-algorithm
    message: "Cryptographic signature verification is missing or improper. Unverified signatures allow attackers to tamper with data. Always verify signatures before trusting signed data."
    severity: HIGH
    languages: [python]
    pattern-either:
      - pattern: jwt.encode(..., algorithm="none")
      - pattern: jwt.decode(..., algorithms=["none"])
      - pattern: 'jwt.decode($TOKEN, ..., options={..., "verify_signature": False, ...})'
    metadata:
      category: security
      owasp: "A07:2021"
      cwe: CWE-347
      confidence: high
      subcategory: authentication
      vulnerability_class: "Authentication Weakness"
      fix: "Always verify JWT signatures: jwt.decode(token, key, algorithms=['HS256']). Never use options={'verify_signature': False}."

  # Missing password hashing
  - id: python-plain-text-password
    message: "Password stored or compared in plain text - use bcrypt, argon2, or pbkdf2"
    severity: CRITICAL
    languages: [python]
    patterns:
      - pattern-either:
          - pattern: $USER.password = $REQ.$W.get(...)
          - pattern: $USER.password == $INPUT
          - pattern: $PASSWORD == $REQ.$W.get(...)
      - pattern-not-inside: |
          ...
          bcrypt.hashpw(...)
          ...
      - pattern-not-inside: |
          ...
          hashlib.pbkdf2_hmac(...)
          ...
      - pattern-not-inside: |
          ...
          werkzeug.security.generate_password_hash(...)
          ...
    metadata:
      category: security
      owasp: "A07:2021"
      cwe: CWE-916
      confidence: medium
      subcategory: authentication
      vulnerability_class: "Authentication Weakness"
      fix: "Use bcrypt (bcrypt.hashpw), argon2 (argon2-cffi), or scrypt (hashlib.scrypt) instead of MD5/SHA for password hashing."

  # ===================================================================== 
  # A08:2021 - Software and Data Integrity Failures
  # =====================================================================

  # Unsafe deserialization
  - id: python-unsafe-deserialization
    message: "Unsafe deserialization detected. Deserializing untrusted data can lead to remote code execution or denial of service. Use safe serialization formats like JSON or validate data before deserializing."
    severity: CRITICAL
    languages: [python]
    pattern-either:
      # Pickle
      - pattern: pickle.loads($DATA)
      - pattern: pickle.load($FILE)
      - pattern: cPickle.loads($DATA)
      # Marshal
      - pattern: marshal.loads($DATA)
      - pattern: marshal.load($FILE)
      # Shelve
      - pattern: shelve.open($FILE)
    metadata:
      category: security
      owasp: "A08:2021"
      cwe: CWE-502
      confidence: high
      subcategory: integrity
      vulnerability_class: "Insecure Deserialization"
      fix: "Replace pickle/shelve with json.loads() for data interchange. If pickle is required, use hmac to verify data integrity before deserializing."

  # Missing integrity check
  - id: python-missing-integrity-check
    message: "Missing integrity check. Data modifications go undetected without integrity verification. Implement checksums or HMACs on sensitive data."
    severity: MEDIUM
    languages: [python]
    patterns:
      - pattern-either:
          - pattern: requests.get($URL).content
          - pattern: urllib.request.urlretrieve($URL, ...)
      - pattern-not-inside: |
          ...
          hashlib.sha256(...).hexdigest()
          ...
      - pattern-not-inside: |
          ...
          if $HASH == ...:
            ...
    metadata:
      category: security
      owasp: "A08:2021"
      cwe: CWE-353
      confidence: low
      subcategory: integrity
      vulnerability_class: "Insecure Deserialization"

  # ===================================================================== 
  # A09:2021 - Security Logging and Monitoring Failures
  # =====================================================================

  # Sensitive data in logs
  - id: python-sensitive-data-in-logs
    message: "Sensitive data logged - can expose credentials or personal information"
    severity: MEDIUM
    languages: [python]
    pattern-either:
      - pattern: logging.info(..., $PASSWORD, ...)
      - pattern: logging.debug(..., $TOKEN, ...)
      - pattern: logging.error(..., $SECRET, ...)
      - pattern: print(..., $REQ.$W.get("password"), ...)
      - pattern: logger.info(..., $REQ.$W.get("token"), ...)
    metadata:
      category: security
      owasp: "A09:2021"
      cwe: CWE-532
      confidence: low
      subcategory: logging
      vulnerability_class: "Sensitive Data Exposure"

  # Missing error logging
  - id: python-missing-error-logging
    message: "Insufficient security logging. Critical events are not logged, hindering incident detection. Log authentication, authorization, and data access events."
    severity: LOW
    languages: [python]
    patterns:
      - pattern: |
          try:
            ...
          except $EXC:
            pass
      - pattern-not-inside: |
          try:
            ...
          except $EXC:
            logging.error(...)
      - pattern-not-inside: |
          try:
            ...
          except $EXC:
            logger.exception(...)
    metadata:
      category: security
      owasp: "A09:2021"
      cwe: CWE-778
      confidence: low
      subcategory: logging
      vulnerability_class: "Sensitive Data Exposure"

  # ===================================================================== 
  # A10:2021 - Server-Side Request Forgery (SSRF)
  # =====================================================================

  # SSRF via user-controlled URL
  - id: python-ssrf-vulnerability
    message: "SSRF vulnerability - validate and whitelist URLs before making requests"
    severity: HIGH
    languages: [python]
    pattern-either:
      - pattern: requests.get($REQ.$W.get(...))
      - pattern: requests.post($REQ.$W.get(...), ...)
      - pattern: urllib.request.urlopen($REQ.$W.get(...))
      - pattern: urllib.request.urlretrieve($REQ.$W.get(...), ...)
      - pattern: httpx.get($REQ.$W.get(...))
      - pattern: aiohttp.ClientSession().get($REQ.$W.get(...))
    metadata:
      category: security
      owasp: "A10:2021"
      cwe: CWE-918
      confidence: high
      subcategory: ssrf
      vulnerability_class: "Server-Side Request Forgery"
      fix: "Validate URLs against an allowlist of permitted hosts and schemes. Block private IP ranges (10.x, 172.16-31.x, 192.168.x, 127.x). Use urllib.parse to validate before fetching."

  # =====================================================================
  # Python Best Practices
  # =====================================================================

  # Assert in production code
  - id: python-assert-used
    message: "Assert statement in code - removed when compiling to optimized bytecode"
    severity: LOW
    languages: [python]
    pattern: assert $CONDITION
    metadata:
      category: best-practice
      cwe: CWE-703
      confidence: high
      subcategory: error-handling
      vulnerability_class: "Improper Error Handling"

  # Bare except clause
  - id: python-bare-except
    message: "Bare except clause catches all exceptions including system exits"
    severity: MEDIUM
    languages: [python]
    pattern: |
      try:
        ...
      except:
        ...
    metadata:
      category: best-practice
      cwe: CWE-396
      confidence: high
      subcategory: error-handling
      vulnerability_class: "Improper Error Handling"

  # Use of exec/eval
  - id: python-dangerous-eval-exec
    message: "Use of eval/exec can execute arbitrary code - avoid if possible"
    severity: HIGH
    languages: [python]
    patterns:
      - pattern-either:
          - pattern: eval(...)
          - pattern: exec(...)
      # Exclude hardcoded strings
      - pattern-not: eval("...")
      - pattern-not: exec("...")
    metadata:
      category: security
      cwe: CWE-95
      confidence: high
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Remove eval()/exec() with user input. Use ast.literal_eval() for safe Python literal parsing. Use a sandboxed environment if dynamic code execution is needed."

  # SQL format string
  - id: python-sql-format-string
    message: "SQL query using string formatting - use parameterized queries"
    severity: CRITICAL
    languages: [python]
    pattern-either:
      - pattern: $DB.execute("SELECT ..." % ...)
      - pattern: $DB.execute("INSERT ..." % ...)
      - pattern: $DB.execute("UPDATE ..." % ...)
      - pattern: $DB.execute("DELETE ..." % ...)
    metadata:
      category: security
      cwe: CWE-89
      confidence: high
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Use parameterized queries: cursor.execute('SELECT * FROM t WHERE id = %s', (user_id,)). For Django, use the ORM or QuerySet API. For SQLAlchemy, use bound parameters."

  # Tempfile without secure flags
  - id: python-insecure-temp-file
    message: "Temporary file created insecurely - use tempfile.mkstemp() or TemporaryFile()"
    severity: MEDIUM
    languages: [python]
    pattern-either:
      - pattern: open("/tmp/...", ...)
      - pattern: open("/var/tmp/...", ...)
      - pattern: tempfile.mktemp()
    metadata:
      category: security
      cwe: CWE-377
      confidence: high
      subcategory: file-operations
      vulnerability_class: "Insecure File Operation"
      owasp: "A01:2021"

  # ReDoS vulnerability
  - id: python-regex-dos
    message: "Complex regex pattern with user input - potential ReDoS vulnerability"
    severity: MEDIUM
    languages: [python]
    pattern-either:
      # User input as regex pattern
      - pattern: re.compile($REQ.$W.get(...))
      - pattern: re.match($REQ.$W.get(...), ...)
      - pattern: re.search($REQ.$W.get(...), ...)
      # Dangerous regex patterns
      - pattern: re.compile(r"(.+)+")
      - pattern: re.compile(r"(.*)+")
      - pattern: re.compile(r"(.*)\\*")
      - pattern: re.compile(r"(a+)+")
    metadata:
      category: security
      cwe: CWE-1333
      confidence: medium
      subcategory: dos
      vulnerability_class: "Denial of Service"

  # Unvalidated file upload
  - id: python-unvalidated-file-upload
    message: "File upload without validation - validate file type, size, and content"
    severity: HIGH
    languages: [python]
    patterns:
      - pattern-either:
          - pattern: $FILE.save($PATH)
          - pattern: open($PATH, "wb").write($REQ.files.get(...).read())
      - pattern-not-inside: |
          ...
          if $FILE.filename.endswith(...):
            ...
      - pattern-not-inside: |
          ...
          if $FILE.content_type in [...]:
            ...
    metadata:
      category: security
      cwe: CWE-434
      confidence: low
      subcategory: upload
      vulnerability_class: "Unrestricted File Upload"
      owasp: "A04:2021"
      fix: "Validate file extension, MIME type, and content. Use werkzeug.utils.secure_filename(). Store uploads outside the web root with randomized names."

  # === Bandit B107: Hardcoded password default ===
  - id: python-hardcoded-password-default
    message: "Hard-coded password detected. Passwords embedded in code are easily discovered. Use environment variables or a secrets manager."
    severity: MEDIUM
    languages: [python]
    pattern-either:
      - pattern: |
          def $FUNC(..., password="...", ...):
            ...
      - pattern: |
          def $FUNC(..., passwd="...", ...):
            ...
      - pattern: |
          def $FUNC(..., secret="...", ...):
            ...
    metadata:
      category: security
      bandit_equivalent: B107
      cwe: CWE-259
      subcategory: authentication
      vulnerability_class: "Authentication Weakness"
      owasp: "A07:2021"

  # === Bandit B301: Pickle usage ===
  - id: python-pickle-usage
    message: "Pickle usage detected. Pickle can be unsafe when loading untrusted data"
    severity: CRITICAL
    languages: [python]
    pattern-either:
      - pattern: pickle.loads($DATA)
      - pattern: pickle.load($FILE)
      - pattern: cPickle.loads($DATA)
      - pattern: cPickle.load($FILE)
      - pattern: dill.loads($DATA)
      - pattern: dill.load($FILE)
    metadata:
      category: security
      bandit_equivalent: B301
      cwe: CWE-502
      confidence: high
      subcategory: integrity
      vulnerability_class: "Insecure Deserialization"
      owasp: "A08:2021"
      fix: "Replace pickle/shelve with json.loads() for data interchange. If pickle is required, use hmac to verify data integrity before deserializing."

  # === Bandit B303: MD5 hash usage ===
  - id: python-md5-usage
    message: "Weak cryptographic algorithm detected. Using broken or outdated algorithms may allow attackers to decrypt data or forge signatures. Use modern algorithms like AES-256, SHA-256, or Ed25519."
    severity: MEDIUM
    languages: [python]
    pattern-either:
      - pattern: hashlib.md5(...)
      - pattern: hashlib.new("md5", ...)
      - pattern: hashlib.new('md5', ...)
      - pattern: Crypto.Hash.MD5.new(...)
    metadata:
      category: security
      bandit_equivalent: B303
      cwe: CWE-327
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"

  # === Bandit B304: SHA1 hash usage ===
  - id: python-sha1-usage
    message: "Weak cryptographic algorithm detected. Using broken or outdated algorithms may allow attackers to decrypt data or forge signatures. Use modern algorithms like AES-256, SHA-256, or Ed25519."
    severity: MEDIUM
    languages: [python]
    pattern-either:
      - pattern: hashlib.sha1(...)
      - pattern: hashlib.new("sha1", ...)
      - pattern: hashlib.new('sha1', ...)
      - pattern: Crypto.Hash.SHA1.new(...)
    metadata:
      category: security
      bandit_equivalent: B304
      cwe: CWE-327
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"

  # === Bandit B307: Eval usage ===
  - id: python-eval-usage
    message: "Code injection vulnerability detected. User-controlled input is passed to a code evaluation function, allowing arbitrary code execution. Avoid eval/exec with user input; use safe alternatives."
    severity: CRITICAL
    languages: [python]
    patterns:
      - pattern: eval($EXPR)
      # Exclude hardcoded strings
      - pattern-not: eval("...")
    metadata:
      category: security
      bandit_equivalent: B307
      cwe: CWE-94
      confidence: high
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Remove eval()/exec() calls with user input. Use ast.literal_eval() for safe parsing of Python literals. Use a sandboxed environment if dynamic execution is required."

  # === Bandit B501: Request without cert validation ===
  - id: python-request-without-cert-validation
    message: "TLS/SSL certificate validation is disabled or bypassed. This allows man-in-the-middle attacks where attackers can intercept encrypted communications. Always validate certificates in production."
    severity: HIGH
    languages: [python]
    pattern-either:
      - pattern: requests.get(..., verify=False, ...)
      - pattern: requests.post(..., verify=False, ...)
      - pattern: requests.put(..., verify=False, ...)
      - pattern: requests.delete(..., verify=False, ...)
      - pattern: requests.request(..., verify=False, ...)
      - pattern: urllib3.disable_warnings(...)
    metadata:
      category: security
      bandit_equivalent: B501
      cwe: CWE-295
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A07:2021"
      fix: "Always use verify=True (the default) in requests. Set ssl_context properly. Never set CERT_NONE or disable hostname checking."

  # === Bandit B502: SSL with bad version ===
  - id: python-ssl-bad-version
    message: "Weak cryptographic algorithm detected. Using broken or outdated algorithms may allow attackers to decrypt data or forge signatures. Use modern algorithms like AES-256, SHA-256, or Ed25519."
    severity: HIGH
    languages: [python]
    pattern-either:
      - pattern: ssl.PROTOCOL_SSLv2
      - pattern: ssl.PROTOCOL_SSLv3
      - pattern: ssl.PROTOCOL_TLSv1
      - pattern: ssl.SSLContext(ssl.PROTOCOL_SSLv2)
      - pattern: ssl.SSLContext(ssl.PROTOCOL_SSLv3)
      - pattern: ssl.SSLContext(ssl.PROTOCOL_TLSv1)
    metadata:
      category: security
      bandit_equivalent: B502
      cwe: CWE-327
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"
      fix: "Use hashlib.sha256() or hashlib.sha3_256() instead of md5/sha1. Use cryptography library with AES-GCM or ChaCha20-Poly1305 for encryption."

  # === Bandit B601: Paramiko calls ===
  - id: python-paramiko-calls
    message: "Key exchange without authentication. Unauthenticated key exchange enables man-in-the-middle attacks. Use authenticated key exchange protocols."
    severity: MEDIUM
    languages: [python]
    pattern-either:
      - pattern: paramiko.SSHClient().set_missing_host_key_policy(paramiko.AutoAddPolicy())
      - pattern: $CLIENT.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    metadata:
      category: security
      bandit_equivalent: B601
      cwe: CWE-322
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"

  # === Bandit B602: Subprocess with shell=True ===
  - id: python-subprocess-shell-true
    message: "Subprocess call with shell=True detected. This can be dangerous with user input"
    severity: CRITICAL
    languages: [python]
    pattern-either:
      - pattern: subprocess.call(..., shell=True, ...)
      - pattern: subprocess.check_call(..., shell=True, ...)
      - pattern: subprocess.check_output(..., shell=True, ...)
      - pattern: subprocess.run(..., shell=True, ...)
      - pattern: subprocess.Popen(..., shell=True, ...)
      - pattern: os.system($CMD)
      - pattern: os.popen($CMD)
    metadata:
      category: security
      bandit_equivalent: B602
      cwe: CWE-78
      confidence: high
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Use subprocess.run() with a list of arguments instead of shell=True: subprocess.run(['cmd', arg1, arg2]). Never pass user input to os.system() or shell commands."

  # === Bandit B605: Start process with shell ===
  - id: python-start-process-with-shell
    message: "Starting a process with a shell, possible injection detected"
    severity: CRITICAL
    languages: [python]
    pattern-either:
      - pattern: os.system($CMD)
      - pattern: os.popen($CMD)
      - pattern: os.popen2($CMD)
      - pattern: os.popen3($CMD)
      - pattern: os.popen4($CMD)
      - pattern: commands.getoutput($CMD)
      - pattern: commands.getstatusoutput($CMD)
    metadata:
      category: security
      bandit_equivalent: B605
      cwe: CWE-78
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Use subprocess.run() with a list of arguments instead of shell=True: subprocess.run(['cmd', arg1, arg2]). Never pass user input to os.system() or shell commands."

  # === Bandit B608: SQL injection ===
  - id: python-sql-injection-format
    message: "SQL injection vulnerability detected. User-supplied input is included in a SQL query without sanitization, potentially allowing attackers to read, modify, or delete database contents. Use parameterized queries or an ORM instead of string concatenation."
    severity: CRITICAL
    languages: [python]
    pattern-either:
      - pattern: $CURSOR.execute("..." % ...)
      - pattern: $CURSOR.execute('...' % ...)
      - pattern: $CURSOR.execute("...".format(...))
      - pattern: $CURSOR.execute('...'.format(...))
      - pattern: $CURSOR.execute(f"...{$VAR}...")
      - pattern: $CURSOR.execute(f'...{$VAR}...')
    metadata:
      category: security
      bandit_equivalent: B608
      cwe: CWE-89
      confidence: medium
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Use parameterized queries: cursor.execute('SELECT * FROM t WHERE id = %s', (user_id,)). For Django, use the ORM or QuerySet API. For SQLAlchemy, use bound parameters."

  # === Flask debug mode ===
  - id: python-flask-debug-true
    message: "Flask app with debug=True detected. This should not be used in production"
    severity: MEDIUM
    languages: [python]
    pattern-either:
      - pattern: $APP.run(debug=True, ...)
      - pattern: $APP.run(..., debug=True, ...)
      - pattern: app.config['DEBUG'] = True
    metadata:
      category: security
      bandit_equivalent: B201
      cwe: CWE-489
      subcategory: configuration
      vulnerability_class: "Security Misconfiguration"
      owasp: "A05:2021"

  # === Jinja2 autoescape false ===
  - id: python-jinja2-autoescape-false
    message: "Jinja2 autoescape is set to false. This can lead to XSS vulnerabilities"
    severity: HIGH
    languages: [python]
    pattern-either:
      - pattern: jinja2.Environment(autoescape=False, ...)
      - pattern: jinja2.Environment(..., autoescape=False, ...)
    metadata:
      category: security
      bandit_equivalent: B701
      cwe: CWE-79
      subcategory: xss
      vulnerability_class: "Cross-Site Scripting (XSS)"
      owasp: "A03:2021"
      fix: "Use template engine auto-escaping (Jinja2 autoescape=True, Django default). Use markupsafe.escape() for manual escaping. Never render raw user input with |safe or Markup()."

  # === Weak random ===
  - id: python-weak-random
    message: "Use of insecure random number generator. Consider using secrets module"
    severity: MEDIUM
    languages: [python]
    pattern-either:
      - pattern: random.random()
      - pattern: random.randint(...)
      - pattern: random.choice(...)
      - pattern: random.randrange(...)
      - pattern: random.uniform(...)
    metadata:
      category: security
      cwe: CWE-338
      confidence: high
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"

  # === Temporary file creation ===
  - id: python-tempfile-mktemp
    message: "Insecure temporary file creation. Predictable temp file names or insecure permissions can be exploited via symlink attacks. Use secure temp file creation functions."
    severity: LOW
    languages: [python]
    pattern-either:
      - pattern: tempfile.mktemp(...)
      - pattern: os.tempnam(...)
      - pattern: os.tmpnam(...)
    metadata:
      category: security
      cwe: CWE-377
      subcategory: file-operations
      vulnerability_class: "Insecure File Operation"
      owasp: "A01:2021"