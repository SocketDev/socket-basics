rules:
  # === Critical Severity Rules ===

  # Unsafe code blocks
  - id: rust-unsafe-usage
    message: "Memory buffer boundary violation. Operations read or write beyond buffer bounds, causing crashes or code execution. Use bounds-checked functions and validate sizes."
    severity: CRITICAL
    languages: [rust]
    pattern-either:
      - pattern: 'unsafe fn $FUNC(...) { ... }'
      - pattern: '$VAR as *mut $TYPE'
      - pattern: '$VAR as *const $TYPE'
      - pattern: 'std::mem::transmute($VAR)'
      - pattern: 'unsafe { ... }'
    metadata:
      category: security
      cwe: CWE-119
      confidence: medium
      subcategory: deprecated
      vulnerability_class: "Memory Safety Violation"
      fix: "Minimize unsafe blocks. Use safe Rust APIs with bounds checking. If unsafe is required, carefully validate all buffer sizes and indices."

  # Command injection
  - id: rust-command-injection
    message: "OS command injection vulnerability detected. User-controlled data flows into a system command without proper sanitization, allowing attackers to execute arbitrary commands. Use safe APIs with argument lists instead of shell execution."
    severity: CRITICAL
    languages: [rust]
    patterns:
      - pattern-either:
          - pattern: std::process::Command::new($CMD + $USER_INPUT)
          - pattern: Command::new($CMD + $USER_INPUT)
          - pattern: std::process::Command::new($CMD).arg($USER_INPUT)
          - pattern: Command::new($CMD).args(&[$USER_INPUT])
      - metavariable-pattern:
          metavariable: $USER_INPUT
          pattern: $VAR
    metadata:
      category: security
      cwe: CWE-78
      confidence: medium
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Use std::process::Command with separate arguments: Command::new('cmd').arg(arg1).arg(arg2). Never pass user input to shell commands."

  # Unsafe deserialization
  - id: rust-unsafe-deserialization
    message: "Unsafe deserialization detected. Deserializing untrusted data can lead to remote code execution or denial of service. Use safe serialization formats like JSON or validate data before deserializing."
    severity: CRITICAL
    languages: [rust]
    patterns:
      - pattern-either:
          - pattern: serde_pickle::from_slice($USER_INPUT)
          - pattern: bincode::deserialize($USER_INPUT)
          - pattern: postcard::from_bytes($USER_INPUT)
      - metavariable-pattern:
          metavariable: $USER_INPUT
          pattern: $VAR
    metadata:
      category: security
      cwe: CWE-502
      confidence: medium
      subcategory: integrity
      vulnerability_class: "Insecure Deserialization"
      owasp: "A08:2021"
      fix: "Use serde with JSON/MessagePack instead of bincode for untrusted data. Validate deserialized data before use."

  # SQL injection potential
  - id: rust-sql-injection
    message: "SQL injection vulnerability detected. User-supplied input is included in a SQL query without sanitization, potentially allowing attackers to read, modify, or delete database contents. Use parameterized queries or an ORM instead of string concatenation."
    severity: CRITICAL
    languages: [rust]
    pattern-either:
      - pattern: $CONN.execute($QUERY + $USER_INPUT, ...)
      - pattern: $CONN.query($QUERY + $USER_INPUT, ...)
      - pattern: format!($QUERY, $USER_INPUT)
      - pattern: $QUERY.push_str($USER_INPUT)
    metadata:
      category: security
      cwe: CWE-89
      confidence: medium
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      fix: "Use parameterized queries with sqlx: sqlx::query('SELECT * FROM t WHERE id = $1').bind(user_id). Never format user input into SQL strings."

  # === High Severity Rules ===

  # Hardcoded secrets
  - id: rust-hardcoded-secrets
    message: "Hard-coded credentials detected. Embedding secrets in source code makes them easily discoverable and impossible to rotate. Use environment variables or a secrets manager instead."
    severity: HIGH
    languages: [rust]
    patterns:
      - pattern-either:
          - pattern: |
              const $VAR: &str = "...";
          - pattern: |
              static $VAR: &str = "...";
          - pattern: |
              let $VAR = "...";
      - metavariable-regex:
          metavariable: $VAR
          regex: (?i).*(password|secret|token|key|api_key|apikey|private_key|auth|credential).*
    metadata:
      category: security
      cwe: CWE-798
      confidence: medium
      subcategory: authentication
      vulnerability_class: "Authentication Weakness"
      owasp: "A07:2021"
      fix: "Store secrets in environment variables (std::env::var('KEY')) or use a secrets manager. Use dotenvy for local development."

  # Weak cryptography - MD5
  - id: rust-weak-crypto-md5
    message: "Weak cryptographic algorithm detected. Using broken or outdated algorithms may allow attackers to decrypt data or forge signatures. Use modern algorithms like AES-256, SHA-256, or Ed25519."
    severity: HIGH
    languages: [rust]
    pattern-either:
      - pattern: md5::Md5::new()
      - pattern: Md5::new()
      - pattern: md5::compute($DATA)
      - pattern: md5_crate::Md5::new()
    metadata:
      category: security
      cwe: CWE-327
      confidence: high
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"
      fix: "Use sha2 crate (Sha256::digest) instead of md5. Use aes-gcm crate for authenticated encryption."

  # Weak cryptography - SHA1
  - id: rust-weak-crypto-sha1
    message: "Weak cryptographic algorithm detected. Using broken or outdated algorithms may allow attackers to decrypt data or forge signatures. Use modern algorithms like AES-256, SHA-256, or Ed25519."
    severity: HIGH
    languages: [rust]
    pattern-either:
      - pattern: sha1::Sha1::new()
      - pattern: Sha1::new()
      - pattern: sha1::digest($DATA)
      - pattern: openssl::hash::hash(MessageDigest::sha1(), ...)
    metadata:
      category: security
      cwe: CWE-327
      confidence: high
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"
      fix: "Use sha2 crate (Sha256::digest) instead of md5. Use aes-gcm crate for authenticated encryption."

  # Insecure TLS configuration
  - id: rust-insecure-tls
    message: "TLS/SSL certificate validation is disabled or bypassed. This allows man-in-the-middle attacks where attackers can intercept encrypted communications. Always validate certificates in production."
    severity: HIGH
    languages: [rust]
    pattern-either:
      - pattern: ClientBuilder::new().danger_accept_invalid_certs(true)
      - pattern: $CLIENT.danger_accept_invalid_hostnames(true)
      - pattern: TlsConnector::builder().danger_accept_invalid_certs(true)
    metadata:
      category: security
      cwe: CWE-295
      confidence: high
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A07:2021"
      fix: "Never use danger_accept_invalid_certs(true) in reqwest or rustls. Use the default TLS verification with proper CA certificates."

  # Path traversal
  - id: rust-path-traversal
    message: "Path traversal vulnerability detected. User input is used in file paths without validation, allowing attackers to access files outside the intended directory. Validate and canonicalize paths before use."
    severity: HIGH
    languages: [rust]
    patterns:
      - pattern-either:
          - pattern: std::fs::File::open($PATH + $USER_INPUT)
          - pattern: std::fs::read_to_string($PATH + $USER_INPUT)
          - pattern: std::fs::write($PATH + $USER_INPUT, ...)
          - pattern: PathBuf::from($USER_INPUT)
      - metavariable-pattern:
          metavariable: $USER_INPUT
          pattern: $VAR
    metadata:
      category: security
      cwe: CWE-22
      confidence: medium
      subcategory: access-control
      vulnerability_class: "Access Control Violation"
      owasp: "A01:2021"
      fix: "Use std::fs::canonicalize() and verify the result starts with the allowed base directory. Use Path::starts_with() for validation."

  # Buffer overflow potential
  - id: rust-buffer-overflow-potential
    message: "Buffer overflow vulnerability. Data is copied without checking buffer size, potentially allowing code execution. Always validate input length before buffer operations."
    severity: HIGH
    languages: [rust]
    pattern-either:
      - pattern: |
          unsafe {
            ...
            std::ptr::copy($SRC, $DST, $COUNT)
            ...
          }
      - pattern: |
          unsafe {
            ...
            std::ptr::copy_nonoverlapping($SRC, $DST, $COUNT)
            ...
          }
      - pattern: |
          unsafe {
            ...
            std::slice::from_raw_parts($PTR, $LEN)
            ...
          }
    metadata:
      category: security
      cwe: CWE-120
      confidence: low
      subcategory: deprecated
      vulnerability_class: "Memory Safety Violation"
      fix: "Use safe Rust APIs that enforce bounds checking. Minimize unsafe blocks. Use Vec<u8> and slice methods instead of raw pointers."

  # === Medium Severity Rules ===

  # Panic in production code
  - id: rust-panic-in-production
    message: "Explicit panic in production code - consider using Result instead"
    severity: MEDIUM
    languages: [rust]
    pattern-either:
      - pattern: panic!($MSG)
      - pattern: unimplemented!()
      - pattern: unreachable!()
      - pattern: todo!()
      - pattern: $VAR.unwrap()
      - pattern: $VAR.expect($MSG)
    metadata:
      category: security
      cwe: CWE-248
      confidence: low
      subcategory: error-handling
      vulnerability_class: "Improper Error Handling"

  # Insecure random number generation
  - id: rust-insecure-random
    message: "Insecure random number generator used. Non-cryptographic PRNGs produce predictable values that attackers can guess. Use a cryptographically secure random generator for security-sensitive operations."
    severity: MEDIUM
    languages: [rust]
    pattern-either:
      - pattern: rand::random()
      - pattern: rand::thread_rng().gen()
      - pattern: StdRng::from_entropy()
    metadata:
      category: security
      cwe: CWE-338
      confidence: low
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"

  # HTTP instead of HTTPS
  - id: rust-insecure-http
    message: "Sensitive data transmitted over an unencrypted channel. Using HTTP instead of HTTPS allows network attackers to intercept data in transit. Use HTTPS for all communications containing sensitive data."
    severity: MEDIUM
    languages: [rust]
    pattern-either:
      - pattern: 'Url::parse("http://...")'
      - pattern: 'reqwest::get("http://...")'
      - pattern: '"http://..."'
    metadata:
      category: security
      cwe: CWE-319
      confidence: low
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"

  # Weak cipher algorithms
  - id: rust-weak-cipher
    message: "Weak cryptographic algorithm detected. Using broken or outdated algorithms may allow attackers to decrypt data or forge signatures. Use modern algorithms like AES-256, SHA-256, or Ed25519."
    severity: MEDIUM
    languages: [rust]
    pattern-either:
      - pattern: openssl::symm::Cipher::des_ede3()
      - pattern: openssl::symm::Cipher::rc4()
      - pattern: Cipher::aes_128_ecb()
      - pattern: ring::aead::chacha20_poly1305_openssh()
    metadata:
      category: security
      cwe: CWE-327
      confidence: medium
      subcategory: crypto
      vulnerability_class: "Cryptographic Weakness"
      owasp: "A02:2021"

  # Integer overflow potential
  - id: rust-integer-overflow
    message: "Potential integer overflow - consider using checked arithmetic"
    severity: MEDIUM
    languages: [rust]
    patterns:
      - pattern-either:
          - pattern: $A + $B
          - pattern: $A - $B  
          - pattern: $A * $B
          - pattern: $A / $B
      - metavariable-pattern:
          metavariable: $A
          pattern: usize
      - metavariable-pattern:
          metavariable: $B
          pattern: $VAR
    metadata:
      category: security
      cwe: CWE-190
      confidence: low
      subcategory: deprecated
      vulnerability_class: "Memory Safety Violation"

  # === Low Severity Rules ===

  # Debug information disclosure
  - id: rust-debug-info-disclosure
    message: "Sensitive information written to log files. Passwords, tokens, or personal data in logs can be exposed to unauthorized parties. Redact sensitive values before logging."
    severity: LOW
    languages: [rust]
    patterns:
      - pattern-either:
          - pattern: println!($FMT, $USER_INPUT)
          - pattern: print!($FMT, $USER_INPUT)
          - pattern: dbg!($USER_INPUT)
          - pattern: eprintln!($FMT, $USER_INPUT)
      - metavariable-regex:
          metavariable: $USER_INPUT
          regex: (?i).*(password|token|secret|key|credential).*
    metadata:
      category: security
      cwe: CWE-532
      confidence: low
      subcategory: logging
      vulnerability_class: "Sensitive Data Exposure"
      owasp: "A09:2021"

  # Hardcoded IP addresses
  - id: rust-hardcoded-ip
    message: "Hard-coded credentials detected. Embedding secrets in source code makes them easily discoverable and impossible to rotate. Use environment variables or a secrets manager instead."
    severity: LOW
    languages: [rust]
    pattern-either:
      - pattern: '"192.168.$X.$Y"'
      - pattern: '"10.$X.$Y.$Z"'
      - pattern: '"172.16.$X.$Y"'
      - pattern: '"127.0.0.1"'
      - pattern: '"localhost"'
    metadata:
      category: security
      cwe: CWE-798
      confidence: low
      subcategory: authentication
      vulnerability_class: "Authentication Weakness"
      owasp: "A07:2021"

  # Development/testing code
  - id: rust-development-code
    message: "Development/testing code detected - should not be in production"
    severity: LOW
    languages: [rust]
    pattern-either:
      - pattern: |
          #[cfg(test)]
          mod tests {
            ...
          }
      - pattern: assert_eq!($A, $B)
      - pattern: assert!($COND)
      - pattern: debug_assert!($COND)
    metadata:
      category: security
      cwe: CWE-489
      confidence: low
      subcategory: configuration
      vulnerability_class: "Security Misconfiguration"
      owasp: "A05:2021"

  # === Framework-specific Rules ===

  # Actix-web security issues
  - id: rust-actix-security
    message: "Insecure configuration detected. A misconfigured setting weakens the application's security posture. Review and harden security-relevant configuration."
    severity: MEDIUM
    languages: [rust]
    pattern-either:
      - pattern: HttpServer::new().bind("0.0.0.0:$PORT")
      - pattern: App::new().wrap(Logger::default())
      - pattern: web::post().to($HANDLER)
    pattern-not-inside:
      pattern: |
        ...
        .wrap(middleware::DefaultHeaders::new().header("X-Frame-Options", "DENY"))
        ...
    metadata:
      category: security
      framework: actix
      cwe: CWE-16
      confidence: low
      subcategory: configuration
      vulnerability_class: "Security Misconfiguration"
      owasp: "A05:2021"
      references:
        - https://actix.rs/docs/

  # Warp security issues
  - id: rust-warp-security
    message: "Insecure configuration detected. A misconfigured setting weakens the application's security posture. Review and harden security-relevant configuration."
    severity: MEDIUM
    languages: [rust]
    pattern-either:
      - pattern: warp::serve($ROUTES).run(([0, 0, 0, 0], $PORT))
      - pattern: warp::path($PATH).and(warp::fs::dir($DIR))
    metadata:
      category: security
      framework: warp
      cwe: CWE-16
      confidence: low
      subcategory: configuration
      vulnerability_class: "Security Misconfiguration"
      owasp: "A05:2021"
      references:
        - https://docs.rs/warp/

  # Rocket security issues
  - id: rust-rocket-security
    message: "Insecure configuration detected. A misconfigured setting weakens the application's security posture. Review and harden security-relevant configuration."
    severity: MEDIUM
    languages: [rust]
    pattern-either:
      - pattern: |
          #[rocket::launch]
          fn rocket() -> _ {
            rocket::build().mount("/", routes![$ROUTES])
          }
    pattern-not-inside:
      pattern: |
        ...
        .attach(Shield::default())
        ...
    metadata:
      category: security
      framework: rocket
      cwe: CWE-16
      confidence: low
      subcategory: configuration
      vulnerability_class: "Security Misconfiguration"
      owasp: "A05:2021"
      references:
        - https://rocket.rs/guide/

  # Diesel ORM injection
  - id: rust-diesel-injection
    message: "SQL injection vulnerability detected. User-supplied input is included in a SQL query without sanitization, potentially allowing attackers to read, modify, or delete database contents. Use parameterized queries or an ORM instead of string concatenation."
    severity: HIGH
    languages: [rust]
    pattern-either:
      - pattern: diesel::sql_query($QUERY + $USER_INPUT)
      - pattern: sql_query($QUERY + $USER_INPUT)
      - pattern: $TABLE.filter(sql($USER_INPUT))
    metadata:
      category: security
      framework: diesel
      cwe: CWE-89
      confidence: medium
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"
      references:
        - https://diesel.rs/guides/
      fix: "Use parameterized queries with sqlx: sqlx::query('SELECT * FROM t WHERE id = $1').bind(user_id). Never format user input into SQL strings."

  # Tokio security issues
  - id: rust-tokio-security
    message: "Uncontrolled resource consumption detected. The application does not limit resource usage, making it vulnerable to denial-of-service attacks. Implement rate limiting and resource caps."
    severity: MEDIUM
    languages: [rust]
    pattern-either:
      - pattern: |
          tokio::spawn(async move {
            // Unbounded task
            loop {
              ...
            }
          })
      - pattern: tokio::time::timeout(Duration::MAX, $FUTURE)
    metadata:
      category: security
      framework: tokio
      cwe: CWE-400
      confidence: low
      subcategory: dos
      vulnerability_class: "Denial of Service"
      references:
        - https://tokio.rs/tokio/tutorial

  # Serde security issues
  - id: rust-serde-security
    message: "Unsafe deserialization detected. Deserializing untrusted data can lead to remote code execution or denial of service. Use safe serialization formats like JSON or validate data before deserializing."
    severity: HIGH
    languages: [rust]
    patterns:
      - pattern-either:
          - pattern: serde_json::from_str::<$TYPE>($USER_INPUT)
          - pattern: serde_yaml::from_str::<$TYPE>($USER_INPUT)
          - pattern: toml::from_str::<$TYPE>($USER_INPUT)
      - metavariable-pattern:
          metavariable: $USER_INPUT
          pattern: $VAR
    metadata:
      category: security
      framework: serde
      cwe: CWE-502
      confidence: low
      subcategory: integrity
      vulnerability_class: "Insecure Deserialization"
      owasp: "A08:2021"
      fix: "Use serde with JSON/MessagePack instead of bincode for untrusted data. Validate deserialized data before use."

  # Memory safety violations
  - id: rust-memory-safety
    message: "Use-after-free vulnerability. Accessing freed memory can cause crashes or arbitrary code execution. Nullify pointers after free and use smart pointers where possible."
    severity: HIGH
    languages: [rust]
    pattern-either:
      - pattern: '*$PTR = $VAL'
      - pattern: 'std::mem::forget($VAL)'
      - pattern: 'Box::from_raw($PTR)'
      - pattern: 'std::mem::transmute($VAL)'
      - pattern: 'std::ptr::write($PTR, $VAL)'
    metadata:
      category: security
      cwe: CWE-416
      confidence: low
      subcategory: deprecated
      vulnerability_class: "Memory Safety Violation"
      fix: "Avoid unsafe blocks with raw pointers. Use Rust's ownership system and borrowing rules. If unsafe is required, ensure lifetimes are properly managed."

  # File permissions
  - id: rust-file-permissions
    message: "Overly permissive file or resource permissions. Resources are accessible to unauthorized users due to incorrect permission settings. Apply the principle of least privilege."
    severity: MEDIUM
    languages: [rust]
    pattern-either:
      - pattern: std::fs::OpenOptions::new().mode(0o777)
      - pattern: std::fs::set_permissions($PATH, Permissions::from_mode(0o777))
      - pattern: OpenOptions::new().create(true).mode(0o666)
    metadata:
      category: security
      cwe: CWE-732
      confidence: medium
      subcategory: configuration
      vulnerability_class: "Security Misconfiguration"
      owasp: "A05:2021"

  # Environment variable injection
  - id: rust-env-injection
    message: "Injection vulnerability. User input reaches a downstream interpreter without sanitization. Sanitize or parameterize all user-controlled data."
    severity: MEDIUM
    languages: [rust]
    patterns:
      - pattern-either:
          - pattern: std::env::var($USER_INPUT)
          - pattern: env::var($USER_INPUT)
          - pattern: std::env::set_var($USER_INPUT, $VALUE)
      - metavariable-pattern:
          metavariable: $USER_INPUT
          pattern: $VAR
    metadata:
      category: security
      cwe: CWE-74
      confidence: low
      subcategory: injection
      vulnerability_class: "Injection Vulnerability"
      owasp: "A03:2021"